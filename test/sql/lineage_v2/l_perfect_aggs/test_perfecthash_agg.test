# name: test/sql/lineage_v2/l_aggs/test_perfecthash_agg.test
# description: Test Perfect Hash Aggregate Lineage
# group: [l_perfect_aggs]


statement ok
PRAGMA trace_lineage = "OFF";

statement ok
CREATE TABLE t1(i INTEGER, j INTEGER);
CREATE TABLE t2(i INTEGER);

statement ok
INSERT INTO t1 VALUES (1, 2),  (5, 2), (1, 4), (2, 1), (1, 3),(2, 2), (4, 1), (5, 1);
INSERT INTO t2 SELECT i FROM range(0,1030) tbl(i)


statement ok
PRAGMA trace_lineage = "ON";

query III
select i, avg(j), list(rowid) from t1 GROUP BY i
----
1	3.000000	[0, 2, 4]
2	1.500000	[3, 5]
4	1.000000	[6]
5	1.500000	[1, 7]

statement ok
SELECT i FROM t2 GROUP BY i

statement ok
PRAGMA trace_lineage = "OFF";

query II
select scan.out_index,  sink.in_index
from LINEAGE_1_PERFECT_HASH_GROUP_BY_2_1 as scan, LINEAGE_1_PERFECT_HASH_GROUP_BY_2_0 as sink
where scan.in_index=sink.out_index order by scan.out_index;
----
0	4
0	2
0	0
1	5
1	3
2	6
3	7
3	1


query II
select in_index, out_index from LINEAGE_1_PERFECT_HASH_GROUP_BY_2_0 as sink;
----
0	1
1	5
2	1
3	2
4	1
5	2
6	4
7	5

query II
select in_index, out_index from LINEAGE_1_PERFECT_HASH_GROUP_BY_2_1 as scan;
----
1	0
2	1
4	2
5	3


query II
select scan.out_index,  sink.in_index
from LINEAGE_2_PERFECT_HASH_GROUP_BY_2_1 as scan, LINEAGE_2_PERFECT_HASH_GROUP_BY_2_0 as sink
where scan.in_index=sink.out_index
AND scan.out_index != sink.in_index
----

