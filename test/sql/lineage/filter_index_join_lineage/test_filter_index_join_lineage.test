# name: test/sql/lineage/filter_index_join_lineage/test_filter_index_join_lineage.test
# description: Test Sequential Scan with a Filter and Index Join Lineage
# group: [filter_index_join_lineage]

#┌───────────────────────────┐
#│         PROJECTION        │
#│   ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─   │
#│             i             │
#│             j             │
#│             i             │
#└─────────────┬─────────────┘
#┌─────────────┴─────────────┐
#│         INDEX_JOIN        ├──────────────┐
#└─────────────┬─────────────┘              │
#┌─────────────┴─────────────┐┌─────────────┴─────────────┐
#│          SEQ_SCAN         ││          SEQ_SCAN         │
#│   ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─   ││   ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─   │
#│             t2            ││             t1            │
#│   ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─   ││   ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─   │
#│             i             ││             i             │
#│   ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─   ││             j             │
#│          Filters:         ││                           │
#│            i<70           ││                           │
#└───────────────────────────┘└───────────────────────────┘

statement ok
PRAGMA explain_output = PHYSICAL_ONLY;
PRAGMA force_index_join;
PRAGMA trace_lineage = "OFF";

statement ok
CREATE TABLE t1(i INTEGER, j INTEGER);
CREATE TABLE t2(i INTEGER);
CREATE INDEX i_index ON t1 using art(i);

statement ok
INSERT INTO t1 SELECT i+1, i FROM range(0,60) tbl(i);
INSERT INTO t2 SELECT i+1 FROM range(50,80) tbl(i);


statement ok
PRAGMA trace_lineage = "ON";

# standalone limit
query III
select t1.i, t1.j, t2.i from t1 inner join t2 on (t1.i = t2.i) where  t2.i < 70 ;
----
51	50	51
52	51	52
53	52	53
54	53	54
55	54	55
56	55	56
57	56	57
58	57	58
59	58	59
60	59	60

statement ok
PRAGMA trace_lineage = "OFF";

query II
SELECT * FROM queries_list;
----
19	select t1.i, t1.j, t2.i from t1 inner join t2 on (t1.i = t2.i) where  t2.i < 70 ;
21	PRAGMA trace_lineage = "OFF";

query IIII
select rowid, chunk_id, index, value from INDEX_JOIN_19_0_LHS;
----
0	0	0	0
1	0	1	1
2	0	2	2
3	0	3	3
4	0	4	4
5	0	5	5
6	0	6	6
7	0	7	7
8	0	8	8
9	0	9	9

query IIII
select f.rowid, f.chunk_id, f.index, f.value + r.range_start from SEQ_SCAN_19_0_range as r, SEQ_SCAN_19_0_filter as f where  r.chunk_id == f.chunk_id;
----
0	0	0	0
1	0	1	1
2	0	2	2
3	0	3	3
4	0	4	4
5	0	5	5
6	0	6	6
7	0	7	7
8	0	8	8
9	0	9	9
10	0	10	10
11	0	11	11
12	0	12	12
13	0	13	13
14	0	14	14
15	0	15	15
16	0	16	16
17	0	17	17
18	0	18	18

query II
select s.value as input_id, j_lhs.value as output_id from INDEX_JOIN_19_0_LHS as j_lhs, (select  f.chunk_id as chunk_id, f.index as index, (f.value + r.range_start) as value from SEQ_SCAN_19_0_range as r, SEQ_SCAN_19_0_filter as f where  r.chunk_id == f.chunk_id) as s where s.chunk_id=j_lhs.chunk_id and s.index = j_lhs.value;
----
0	0
1	1
2	2
3	3
4	4
5	5
6	6
7	7
8	8
9	9


query II
select index as output_id, value as input_id from INDEX_JOIN_19_0_RHS;
----
0	50
1	51
2	52
3	53
4	54
5	55
6	56
7	57
8	58
9	59


query IIII
select rowid, chunk_id, index, value from INDEX_JOIN_19_0_RHS;
----
0	0	0	50
1	0	1	51
2	0	2	52
3	0	3	53
4	0	4	54
5	0	5	55
6	0	6	56
7	0	7	57
8	0	8	58
9	0	9	59


query IIII
select rowid, chunk_id, range_start, range_end from SEQ_SCAN_19_0_range;
----
0	0	0	19


query IIII
select rowid, chunk_id, index, value from SEQ_SCAN_19_0_filter;
----
0	0	0	0
1	0	1	1
2	0	2	2
3	0	3	3
4	0	4	4
5	0	5	5
6	0	6	6
7	0	7	7
8	0	8	8
9	0	9	9
10	0	10	10
11	0	11	11
12	0	12	12
13	0	13	13
14	0	14	14
15	0	15	15
16	0	16	16
17	0	17	17
18	0	18	18
