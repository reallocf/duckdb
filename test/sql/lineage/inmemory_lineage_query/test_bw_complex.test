# name: test/sql/lineage/inmemory_lineage_query/test_bw_complex.test
# description: Test complex, multi-operator lineage
# group: [inmemory_lineage_query]

statement ok
CREATE TABLE t1(i INTEGER, j INTEGER);
CREATE TABLE t2(i INTEGER);
CREATE TABLE t3(i INTEGER);

statement ok
INSERT INTO t1 SELECT i, i+1 FROM range(0,3072) tbl(i);
INSERT INTO t2 SELECT i FROM range(0, 10) tbl(i);
INSERT INTO t2 SELECT i FROM range(5000,7000) tbl(i);
INSERT INTO t2 SELECT i FROM range(30, 40) tbl(i);
INSERT INTO t3 SELECT i FROM range(0,1030) tbl(i);

statement ok
PRAGMA trace_lineage = "ON"

query III
SELECT t1.i, t2.i, t3.i FROM t1, t2, t3 WHERE t1.i = t2.i AND t2.i = t3.i AND t1.j + t2.i > 12 ORDER BY t3.i LIMIT 5
----
6	6	6
7	7	7
8	8	8
9	9	9
30	30	30

statement ok
PRAGMA trace_lineage = "OFF";

query I
PRAGMA backward_lineage('SELECT t1.i, t2.i, t3.i FROM t1, t2, t3 WHERE t1.i = t2.i AND t2.i = t3.i AND t1.j + t2.i > 12 ORDER BY t3.i LIMIT 5', '0')
----
[6, 6, 6]

query I
PRAGMA backward_lineage('SELECT t1.i, t2.i, t3.i FROM t1, t2, t3 WHERE t1.i = t2.i AND t2.i = t3.i AND t1.j + t2.i > 12 ORDER BY t3.i LIMIT 5', '4')
----
[30, 2010, 30]
