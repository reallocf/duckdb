# name: test/sql/lineage/inmemory_tpch_queries/test_tpch_14.test
# description: Test TPC-H Query 14 in-memory
# group: [inmemory_tpch_queries]

require tpch

statement ok
CALL dbgen(sf=0.01);

statement ok
PRAGMA trace_lineage = "ON";

statement ok
SELECT 100.00 * sum(CASE WHEN p_type LIKE 'PROMO%' THEN l_extendedprice * (1 - l_discount) ELSE 0 END) / sum(l_extendedprice * (1 - l_discount)) AS promo_revenue FROM lineitem, part WHERE l_partkey = p_partkey AND l_shipdate >= date '1995-09-01' AND l_shipdate < CAST('1995-10-01' AS date)

statement ok
PRAGMA trace_lineage = "OFF";

query I
PRAGMA backward_lineage("SELECT 100.00 * sum(CASE WHEN p_type LIKE 'PROMO%' THEN l_extendedprice * (1 - l_discount) ELSE 0 END) / sum(l_extendedprice * (1 - l_discount)) AS promo_revenue FROM lineitem, part WHERE l_partkey = p_partkey AND l_shipdate >= date '1995-09-01' AND l_shipdate < CAST('1995-10-01' AS date)", 'VALUE', '0')
----
[161, 1892, 230, 1460, 233, 1412, 338, 194, 341, 345, 343, 421, 440, 268, 442, 1372, 483, 877, 504, 824, 559, 1588, 600, 1892, 610, 900, 612, 1850, 613, 1583, 734, 652, 895, 643, 896, 88, 897, 82, 900, 1670, 953, 567, 954, 545, 978, 1454, 980, 49, 988, 657, 1089, 1343, 1130, 196, 1315, 1494, 1408, 372, 1409, 1064, 1412, 1137, 1513, 1917, 1515, 1037, 1572, 1101, 1706, 297, 2183, 1778, 2307, 1485, 2310, 1417, 2354, 1787, 2470, 671, 2473, 1477, 2474, 467, 2654, 1533, 2687, 1467, 2787, 727, 2789, 696, 2804, 471, 2908, 37, 2910, 1969, 2911, 772, 2913, 864, 3086, 876, 3156, 1369, 3169, 23, 3582, 1741, 3583, 1440, 3642, 1902, 4370, 499, 4371, 834, 4436, 1950, 4438, 971, 4463, 1023, 4464, 1521, 4568, 1324, 4571, 1487, 4668, 1849, 4715, 1108, 4794, 319, 4815, 739, 4816, 1527, 4817, 1522, 4918, 1766, 4919, 1605, 4922, 1514, 4923, 1354, 5260, 87, 5332, 1172, 5333, 1247, 5585, 887, 5702, 1444, 5831, 998, 5978, 1488, 5979, 429, 5982, 1317, 6085, 1748, 6203, 1343, 6244, 1117, 6297, 1090, 6307, 961, 6318, 1534, 6319, 1354, 6346, 1949, 6352, 466, 6353, 1703, 6411, 804, 6412, 1186, 6482, 1247, 6513, 374, 6614, 1675, 6649, 68, 6650, 1282, 6690, 86, 6813, 224, 6880, 866, 6923, 1826, 6983, 1391, 6999, 304, 7165, 1231, 7182, 577, 7185, 1164, 7269, 1643, 7810, 1257, 7814, 500, 7982, 108, 7986, 990, 7994, 1449, 8143, 1352, 8400, 1448, 8404, 1350, 8482, 1327, 8500, 640, 8586, 1767, 8588, 47, 8695, 354, 8779, 957, 8952, 1837, 8956, 349, 8990, 566, 8996, 339, 9026, 70, 9099, 272, 9167, 1208, 9301, 267, 9402, 966, 9543, 1304, 9582, 1353, 9653, 703, 9717, 223, 9718, 760, 9719, 1447, 9731, 985, 9855, 1958, 10149, 1069, 10235, 601, 10287, 105, 10288, 112, 10289, 1247, 10294, 49, 10299, 638, 10496, 1037, 10497, 1911, 10498, 1852, 10536, 284, 10694, 330, 10696, 1327, 10746, 284, 11128, 1958, 11129, 1258, 11176, 1515, 11234, 719, 11237, 1107, 11289, 898, 11363, 1951, 11364, 58, 11366, 682, 11367, 1780, 11459, 1986, 11821, 272, 11822, 76, 11871, 850, 12009, 802, 12264, 933, 12266, 544, 12273, 1665, 12281, 1999, 12286, 5, 12331, 1257, 12336, 946, 12337, 1129, 12342, 1148, 12427, 1955, 12469, 1290, 12482, 350, 12484, 1670, 12486, 125, 12895, 240, 13547, 186, 13829, 1397, 13977, 1267, 13978, 242, 14007, 1839, 14008, 585, 14024, 330, 14025, 794, 14140, 793, 14158, 1648, 14319, 1036, 14423, 1260, 14425, 1464, 14465, 1496, 14547, 1501, 14551, 1901, 14576, 946, 14780, 1252, 14781, 858, 14936, 1805, 15001, 782, 15003, 216, 15018, 1924, 15019, 562, 15239, 941, 15329, 695, 15330, 1710, 15438, 1580, 15642, 1308, 15646, 873, 15719, 1885, 15721, 1815, 15722, 763, 15931, 1769, 15974, 1676, 16265, 1441, 16267, 1720, 16377, 1199, 16380, 724, 16451, 1205, 16523, 659, 16797, 137, 16798, 454, 16977, 1074, 17267, 465, 17269, 1909, 17270, 327, 17286, 1480, 17288, 1240, 17367, 625, 17428, 846, 17435, 68, 17480, 730, 17481, 483, 17506, 50, 17905, 1994, 17908, 253, 17940, 763, 17942, 1594, 18115, 1671, 18252, 1880, 18330, 1826, 18332, 1502, 18365, 1157, 18601, 452, 18654, 142, 18658, 558, 18849, 1997, 18852, 1649, 18882, 1436, 18886, 1425, 18962, 22, 19020, 520, 19040, 1405, 19380, 1800, 19384, 907, 19842, 110, 19844, 1581, 19846, 1065, 20129, 1563, 20270, 44, 20274, 850, 20528, 1059, 21085, 1355, 21120, 160, 21212, 158, 21435, 1076, 21436, 1767, 21545, 1124, 21551, 1628, 21621, 1765, 21624, 535, 21630, 858, 21637, 1052, 22299, 619, 22881, 770, 22882, 1901, 23117, 332, 23231, 1711, 23282, 716, 23385, 841, 23547, 1210, 23598, 1424, 23620, 1537, 23730, 295, 23732, 136, 23735, 1978, 23741, 68, 24067, 500, 24110, 654, 24112, 1032, 24115, 1747, 24271, 225, 24277, 1458, 24571, 631, 24699, 326, 24870, 898, 24955, 506, 25060, 1415, 25217, 1864, 25389, 1007, 25390, 1553, 25423, 1400, 25496, 186, 25497, 74, 25571, 278, 25572, 680, 25685, 569, 25778, 658, 26194, 1272, 26286, 1294, 26288, 1238, 26368, 732, 26369, 1456, 26372, 136, 26393, 392, 26394, 61, 26428, 556, 26515, 665, 26612, 1880, 26613, 10, 26695, 1679, 27023, 1092, 27062, 267, 27135, 1741, 27332, 1337, 27333, 1826, 27354, 1526, 27416, 1891, 27420, 1107, 27421, 1497, 27432, 1298, 27452, 327, 27623, 108, 27740, 145, 27761, 0, 27896, 1617, 27963, 636, 27974, 1639, 27975, 97, 28042, 1665, 28046, 982, 28047, 970, 28049, 364, 28122, 1360, 28125, 1219, 28126, 970, 28556, 1902, 28736, 1393, 28737, 623, 28885, 701, 28888, 1388, 28902, 1618, 28903, 195, 29069, 1704, 29071, 346, 29073, 169, 29154, 1087, 29155, 1176, 29237, 168, 29354, 15, 29355, 805, 29364, 635, 29461, 1910, 29462, 1257, 29465, 845, 29551, 498, 29552, 133, 29737, 1494, 29738, 115, 29741, 1092, 29795, 801, 29800, 754, 30048, 1231, 30050, 656, 30196, 370, 30337, 1816, 30511, 1686, 30768, 944, 30769, 1830, 30771, 372, 30791, 531, 30865, 201, 31070, 1305, 31144, 44, 31146, 1963, 31150, 758, 31180, 1269, 31266, 628, 31274, 1307, 31337, 1302, 31411, 810, 31422, 349, 31423, 899, 31653, 987, 31654, 1934, 31759, 1244, 31800, 1907, 31806, 1324, 31812, 1091, 31828, 394, 31830, 592, 31958, 1381, 31959, 1051, 31970, 942, 32017, 173, 32018, 811, 32020, 1462, 32052, 805, 32138, 1354, 32169, 1375, 32312, 1950, 32316, 1362, 32317, 1433, 32798, 939, 33030, 1684, 33286, 66, 33403, 599, 33605, 1001, 33764, 212, 33828, 429, 34308, 956, 34309, 506, 34369, 1091, 34786, 569, 34829, 217, 34846, 1111, 34865, 552, 34922, 967, 34932, 938, 35295, 1859, 35539, 20, 35552, 1586, 35656, 1443, 35659, 34, 35857, 148, 35939, 1891, 35952, 980, 36003, 937, 36005, 764, 36039, 511, 36044, 1657, 36045, 1157, 36337, 1577, 36363, 841, 36390, 1899, 36503, 1120, 36669, 571, 36670, 296, 36883, 1524, 36885, 1666, 36889, 778, 36906, 1844, 36907, 627, 36909, 1641, 37188, 714, 37191, 764, 37236, 1082, 37284, 1850, 37389, 1631, 37429, 24, 37633, 1284, 37725, 1745, 37728, 1953, 37924, 1422, 38492, 1722, 38605, 1127, 38684, 1621, 38786, 1803, 39194, 1198, 39353, 1246, 39405, 1106, 39406, 642, 39407, 143, 39440, 1143, 39441, 533, 39463, 1162, 39471, 183, 39475, 1296, 39726, 1982, 39861, 1066, 39876, 370, 39904, 295, 39964, 1497, 40607, 894, 40690, 237, 40691, 488, 41078, 1893, 41133, 1806, 41154, 485, 41160, 1451, 41394, 1377, 41655, 529, 41660, 321, 41833, 1362, 41869, 529, 42057, 453, 42157, 952, 42160, 1775, 42192, 1774, 42284, 1258, 42286, 143, 42321, 237, 42324, 1890, 42505, 1580, 42562, 926, 42563, 90, 42658, 394, 42761, 1256, 43386, 1873, 43390, 13, 43392, 724, 43507, 1139, 43530, 1706, 43543, 908, 43583, 1391, 44253, 86, 44510, 1267, 44725, 1883, 44789, 311, 44811, 1788, 44815, 331, 45281, 1136, 45589, 791, 45592, 1010, 45615, 441, 45813, 846, 45817, 1592, 45890, 670, 45997, 1138, 46013, 919, 46016, 1761, 46018, 74, 46094, 1315, 46096, 45, 46098, 166, 46155, 1866, 46157, 990, 46505, 1604, 46509, 1354, 46744, 1483, 46749, 576, 46750, 164, 46833, 720, 46881, 1515, 46944, 1162, 47075, 355, 47285, 545, 47495, 1916, 47652, 1209, 47675, 1821, 47676, 742, 47677, 774, 47679, 819, 47687, 60, 47688, 1593, 47700, 333, 47749, 677, 47750, 387, 47887, 1719, 47998, 1508, 47999, 1774, 48008, 1265, 48307, 1105, 48355, 1860, 48358, 1519, 48444, 1232, 48551, 1373, 48553, 1173, 48746, 215, 48785, 549, 48929, 291, 49037, 1899, 49038, 1597, 49039, 1723, 49316, 874, 49320, 8, 49420, 1068, 49465, 1684, 49521, 310, 49525, 1997, 49593, 74, 49597, 1022, 49609, 476, 49721, 320, 49959, 1255, 49960, 1104, 50023, 116, 50024, 1748, 50256, 33, 50258, 1951, 50259, 673, 50261, 1922, 50516, 1329, 50629, 879, 50631, 1674, 50752, 1793, 50753, 1638, 50754, 1551, 50771, 339, 50795, 1526, 51037, 275, 51176, 493, 51255, 713, 51495, 1402, 51526, 1120, 51543, 1121, 51619, 1896, 51650, 554, 51654, 556, 51746, 1521, 51748, 822, 51814, 1053, 51865, 255, 51916, 450, 52062, 1156, 52065, 1856, 52083, 98, 52117, 1436, 52118, 960, 52305, 714, 52311, 1849, 52690, 1052, 52692, 600, 52696, 442, 52834, 1114, 52835, 1642, 53114, 1455, 53116, 265, 53161, 537, 53162, 321, 53163, 1239, 53287, 528, 53288, 1305, 53347, 277, 53400, 0, 53402, 1584, 53780, 1173, 53853, 1676, 53855, 299, 53902, 1034, 53942, 1255, 53944, 1440, 54085, 1435, 54139, 1393, 54210, 736, 54212, 1419, 54213, 916, 54460, 1573, 54462, 1286, 54600, 1524, 54604, 762, 54763, 122, 54764, 677, 54766, 517, 55075, 1395, 55077, 329, 55079, 1758, 55081, 1832, 55142, 1877, 55186, 721, 55369, 1633, 55610, 1108, 55776, 1289, 55946, 599, 55990, 410, 55993, 1886, 56383, 232, 56544, 1465, 56545, 911, 56637, 210, 56662, 1267, 56702, 1627, 56705, 787, 56741, 1267, 56745, 1993, 56749, 1759, 56892, 1596, 56896, 1244, 56989, 701, 57183, 12, 57203, 55, 57205, 1439, 57207, 1807, 57471, 1577, 57475, 636, 57476, 167, 57479, 1863, 57480, 1835, 57482, 1069, 57566, 1561, 57567, 1094, 57692, 665, 57695, 1344, 57941, 567, 58557, 1548, 58615, 192, 58616, 1152, 58618, 788, 58633, 1912, 58634, 1229, 58714, 1395, 58718, 994, 58726, 1940, 58742, 1562, 58744, 786, 58988, 108, 59194, 1286, 59207, 716, 59572, 1521, 59683, 1514, 59995, 134, 59996, 727, 59998, 846, 60047, 511, 60111, 1083]

query I
PRAGMA backward_lineage("SELECT 100.00 * sum(CASE WHEN p_type LIKE 'PROMO%' THEN l_extendedprice * (1 - l_discount) ELSE 0 END) / sum(l_extendedprice * (1 - l_discount)) AS promo_revenue FROM lineitem, part WHERE l_partkey = p_partkey AND l_shipdate >= date '1995-09-01' AND l_shipdate < CAST('1995-10-01' AS date)", 'COUNT', '0')
----
1444
