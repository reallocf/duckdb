# name: test/sql/lineage/inmemory_tpch_queries/test_tpch_14.test
# description: Test TPC-H Query 14 in-memory
# group: [inmemory_tpch_queries]

require tpch

statement ok
CALL dbgen(sf=0.01);

statement ok
PRAGMA trace_lineage = "ON";

statement ok
SELECT 100.00 * sum(CASE WHEN p_type LIKE 'PROMO%' THEN l_extendedprice * (1 - l_discount) ELSE 0 END) / sum(l_extendedprice * (1 - l_discount)) AS promo_revenue FROM lineitem, part WHERE l_partkey = p_partkey AND l_shipdate >= date '1995-09-01' AND l_shipdate < CAST('1995-10-01' AS date)

statement ok
PRAGMA trace_lineage = "OFF";

query I
PRAGMA lineage_query("SELECT 100.00 * sum(CASE WHEN p_type LIKE 'PROMO%' THEN l_extendedprice * (1 - l_discount) ELSE 0 END) / sum(l_extendedprice * (1 - l_discount)) AS promo_revenue FROM lineitem, part WHERE l_partkey = p_partkey AND l_shipdate >= date '1995-09-01' AND l_shipdate < CAST('1995-10-01' AS date)", 'VALUE', 0)
----
[161, 230, 233, 338, 341, 343, 440, 442, 483, 504, 559, 600, 610, 612, 613, 734, 895, 896, 897, 900, 953, 954, 978, 980, 988, 1089, 1130, 1315, 1408, 1409, 1412, 1513, 1515, 1572, 1706, 2183, 2307, 2310, 2354, 2470, 2473, 2474, 2654, 2687, 2787, 2789, 2804, 2908, 2910, 2911, 2913, 3086, 3156, 3169, 3582, 3583, 3642, 4370, 4371, 4436, 4438, 4463, 4464, 4568, 4571, 4668, 4715, 4794, 4815, 4816, 4817, 4918, 4919, 4922, 4923, 5260, 5332, 5333, 5585, 5702, 5831, 5978, 5979, 5982, 6085, 6203, 6244, 6297, 6307, 6318, 6319, 6346, 6352, 6353, 6411, 6412, 6482, 6513, 6614, 6649, 6650, 6690, 6813, 6880, 6923, 6983, 6999, 7165, 7182, 7185, 7269, 7810, 7814, 7982, 7986, 7994, 8143, 8400, 8404, 8482, 8500, 8586, 8588, 8695, 8779, 8952, 8956, 8990, 8996, 9026, 9099, 9167, 9301, 9402, 9543, 9582, 9653, 9717, 9718, 9719, 9731, 9855, 10149, 10235, 10287, 10288, 10289, 10294, 10299, 10496, 10497, 10498, 10536, 10694, 10696, 10746, 11128, 11129, 11176, 11234, 11237, 11289, 11363, 11364, 11366, 11367, 11459, 11821, 11822, 11871, 12009, 12264, 12266, 12273, 12281, 12286, 12331, 12336, 12337, 12342, 12427, 12469, 12482, 12484, 12486, 12895, 13547, 13829, 13977, 13978, 14007, 14008, 14024, 14025, 14140, 14158, 14319, 14423, 14425, 14465, 14547, 14551, 14576, 14780, 14781, 14936, 15001, 15003, 15018, 15019, 15239, 15329, 15330, 15438, 15642, 15646, 15719, 15721, 15722, 15931, 15974, 16265, 16267, 16377, 16380, 16451, 16523, 16797, 16798, 16977, 17267, 17269, 17270, 17286, 17288, 17367, 17428, 17435, 17480, 17481, 17506, 17905, 17908, 17940, 17942, 18115, 18252, 18330, 18332, 18365, 18601, 18654, 18658, 18849, 18852, 18882, 18886, 18962, 19020, 19040, 19380, 19384, 19842, 19844, 19846, 20129, 20270, 20274, 20528, 21085, 21120, 21212, 21435, 21436, 21545, 21551, 21621, 21624, 21630, 21637, 22299, 22881, 22882, 23117, 23231, 23282, 23385, 23547, 23598, 23620, 23730, 23732, 23735, 23741, 24067, 24110, 24112, 24115, 24271, 24277, 24571, 24699, 24870, 24955, 25060, 25217, 25389, 25390, 25423, 25496, 25497, 25571, 25572, 25685, 25778, 26194, 26286, 26288, 26368, 26369, 26372, 26393, 26394, 26428, 26515, 26612, 26613, 26695, 27023, 27062, 27135, 27332, 27333, 27354, 27416, 27420, 27421, 27432, 27452, 27623, 27740, 27761, 27896, 27963, 27974, 27975, 28042, 28046, 28047, 28049, 28122, 28125, 28126, 28556, 28736, 28737, 28885, 28888, 28902, 28903, 29069, 29071, 29073, 29154, 29155, 29237, 29354, 29355, 29364, 29461, 29462, 29465, 29551, 29552, 29737, 29738, 29741, 29795, 29800, 30048, 30050, 30196, 30337, 30511, 30768, 30769, 30771, 30791, 30865, 31070, 31144, 31146, 31150, 31180, 31266, 31274, 31337, 31411, 31422, 31423, 31653, 31654, 31759, 31800, 31806, 31812, 31828, 31830, 31958, 31959, 31970, 32017, 32018, 32020, 32052, 32138, 32169, 32312, 32316, 32317, 32798, 33030, 33286, 33403, 33605, 33764, 33828, 34308, 34309, 34369, 34786, 34829, 34846, 34865, 34922, 34932, 35295, 35539, 35552, 35656, 35659, 35857, 35939, 35952, 36003, 36005, 36039, 36044, 36045, 36337, 36363, 36390, 36503, 36669, 36670, 36883, 36885, 36889, 36906, 36907, 36909, 37188, 37191, 37236, 37284, 37389, 37429, 37633, 37725, 37728, 37924, 38492, 38605, 38684, 38786, 39194, 39353, 39405, 39406, 39407, 39440, 39441, 39463, 39471, 39475, 39726, 39861, 39876, 39904, 39964, 40607, 40690, 40691, 41078, 41133, 41154, 41160, 41394, 41655, 41660, 41833, 41869, 42057, 42157, 42160, 42192, 42284, 42286, 42321, 42324, 42505, 42562, 42563, 42658, 42761, 43386, 43390, 43392, 43507, 43530, 43543, 43583, 44253, 44510, 44725, 44789, 44811, 44815, 45281, 45589, 45592, 45615, 45813, 45817, 45890, 45997, 46013, 46016, 46018, 46094, 46096, 46098, 46155, 46157, 46505, 46509, 46744, 46749, 46750, 46833, 46881, 46944, 47075, 47285, 47495, 47652, 47675, 47676, 47677, 47679, 47687, 47688, 47700, 47749, 47750, 47887, 47998, 47999, 48008, 48307, 48355, 48358, 48444, 48551, 48553, 48746, 48785, 48929, 49037, 49038, 49039, 49316, 49320, 49420, 49465, 49521, 49525, 49593, 49597, 49609, 49721, 49959, 49960, 50023, 50024, 50256, 50258, 50259, 50261, 50516, 50629, 50631, 50752, 50753, 50754, 50771, 50795, 51037, 51176, 51255, 51495, 51526, 51543, 51619, 51650, 51654, 51746, 51748, 51814, 51865, 51916, 52062, 52065, 52083, 52117, 52118, 52305, 52311, 52690, 52692, 52696, 52834, 52835, 53114, 53116, 53161, 53162, 53163, 53287, 53288, 53347, 53400, 53402, 53780, 53853, 53855, 53902, 53942, 53944, 54085, 54139, 54210, 54212, 54213, 54460, 54462, 54600, 54604, 54763, 54764, 54766, 55075, 55077, 55079, 55081, 55142, 55186, 55369, 55610, 55776, 55946, 55990, 55993, 56383, 56544, 56545, 56637, 56662, 56702, 56705, 56741, 56745, 56749, 56892, 56896, 56989, 57183, 57203, 57205, 57207, 57471, 57475, 57476, 57479, 57480, 57482, 57566, 57567, 57692, 57695, 57941, 58557, 58615, 58616, 58618, 58633, 58634, 58714, 58718, 58726, 58742, 58744, 58988, 59194, 59207, 59572, 59683, 59995, 59996, 59998, 60047, 60111, 1892, 1460, 1412, 194, 345, 421, 268, 1372, 877, 824, 1588, 1892, 900, 1850, 1583, 652, 643, 88, 82, 1670, 567, 545, 1454, 49, 657, 1343, 196, 1494, 372, 1064, 1137, 1917, 1037, 1101, 297, 1778, 1485, 1417, 1787, 671, 1477, 467, 1533, 1467, 727, 696, 471, 37, 1969, 772, 864, 876, 1369, 23, 1741, 1440, 1902, 499, 834, 1950, 971, 1023, 1521, 1324, 1487, 1849, 1108, 319, 739, 1527, 1522, 1766, 1605, 1514, 1354, 87, 1172, 1247, 887, 1444, 998, 1488, 429, 1317, 1748, 1343, 1117, 1090, 961, 1534, 1354, 1949, 466, 1703, 804, 1186, 1247, 374, 1675, 68, 1282, 86, 224, 866, 1826, 1391, 304, 1231, 577, 1164, 1643, 1257, 500, 108, 990, 1449, 1352, 1448, 1350, 1327, 640, 1767, 47, 354, 957, 1837, 349, 566, 339, 70, 272, 1208, 267, 966, 1304, 1353, 703, 223, 760, 1447, 985, 1958, 1069, 601, 105, 112, 1247, 49, 638, 1037, 1911, 1852, 284, 330, 1327, 284, 1958, 1258, 1515, 719, 1107, 898, 1951, 58, 682, 1780, 1986, 272, 76, 850, 802, 933, 544, 1665, 1999, 5, 1257, 946, 1129, 1148, 1955, 1290, 350, 1670, 125, 240, 186, 1397, 1267, 242, 1839, 585, 330, 794, 793, 1648, 1036, 1260, 1464, 1496, 1501, 1901, 946, 1252, 858, 1805, 782, 216, 1924, 562, 941, 695, 1710, 1580, 1308, 873, 1885, 1815, 763, 1769, 1676, 1441, 1720, 1199, 724, 1205, 659, 137, 454, 1074, 465, 1909, 327, 1480, 1240, 625, 846, 68, 730, 483, 50, 1994, 253, 763, 1594, 1671, 1880, 1826, 1502, 1157, 452, 142, 558, 1997, 1649, 1436, 1425, 22, 520, 1405, 1800, 907, 110, 1581, 1065, 1563, 44, 850, 1059, 1355, 160, 158, 1076, 1767, 1124, 1628, 1765, 535, 858, 1052, 619, 770, 1901, 332, 1711, 716, 841, 1210, 1424, 1537, 295, 136, 1978, 68, 500, 654, 1032, 1747, 225, 1458, 631, 326, 898, 506, 1415, 1864, 1007, 1553, 1400, 186, 74, 278, 680, 569, 658, 1272, 1294, 1238, 732, 1456, 136, 392, 61, 556, 665, 1880, 10, 1679, 1092, 267, 1741, 1337, 1826, 1526, 1891, 1107, 1497, 1298, 327, 108, 145, 0, 1617, 636, 1639, 97, 1665, 982, 970, 364, 1360, 1219, 970, 1902, 1393, 623, 701, 1388, 1618, 195, 1704, 346, 169, 1087, 1176, 168, 15, 805, 635, 1910, 1257, 845, 498, 133, 1494, 115, 1092, 801, 754, 1231, 656, 370, 1816, 1686, 944, 1830, 372, 531, 201, 1305, 44, 1963, 758, 1269, 628, 1307, 1302, 810, 349, 899, 987, 1934, 1244, 1907, 1324, 1091, 394, 592, 1381, 1051, 942, 173, 811, 1462, 805, 1354, 1375, 1950, 1362, 1433, 939, 1684, 66, 599, 1001, 212, 429, 956, 506, 1091, 569, 217, 1111, 552, 967, 938, 1859, 20, 1586, 1443, 34, 148, 1891, 980, 937, 764, 511, 1657, 1157, 1577, 841, 1899, 1120, 571, 296, 1524, 1666, 778, 1844, 627, 1641, 714, 764, 1082, 1850, 1631, 24, 1284, 1745, 1953, 1422, 1722, 1127, 1621, 1803, 1198, 1246, 1106, 642, 143, 1143, 533, 1162, 183, 1296, 1982, 1066, 370, 295, 1497, 894, 237, 488, 1893, 1806, 485, 1451, 1377, 529, 321, 1362, 529, 453, 952, 1775, 1774, 1258, 143, 237, 1890, 1580, 926, 90, 394, 1256, 1873, 13, 724, 1139, 1706, 908, 1391, 86, 1267, 1883, 311, 1788, 331, 1136, 791, 1010, 441, 846, 1592, 670, 1138, 919, 1761, 74, 1315, 45, 166, 1866, 990, 1604, 1354, 1483, 576, 164, 720, 1515, 1162, 355, 545, 1916, 1209, 1821, 742, 774, 819, 60, 1593, 333, 677, 387, 1719, 1508, 1774, 1265, 1105, 1860, 1519, 1232, 1373, 1173, 215, 549, 291, 1899, 1597, 1723, 874, 8, 1068, 1684, 310, 1997, 74, 1022, 476, 320, 1255, 1104, 116, 1748, 33, 1951, 673, 1922, 1329, 879, 1674, 1793, 1638, 1551, 339, 1526, 275, 493, 713, 1402, 1120, 1121, 1896, 554, 556, 1521, 822, 1053, 255, 450, 1156, 1856, 98, 1436, 960, 714, 1849, 1052, 600, 442, 1114, 1642, 1455, 265, 537, 321, 1239, 528, 1305, 277, 0, 1584, 1173, 1676, 299, 1034, 1255, 1440, 1435, 1393, 736, 1419, 916, 1573, 1286, 1524, 762, 122, 677, 517, 1395, 329, 1758, 1832, 1877, 721, 1633, 1108, 1289, 599, 410, 1886, 232, 1465, 911, 210, 1267, 1627, 787, 1267, 1993, 1759, 1596, 1244, 701, 12, 55, 1439, 1807, 1577, 636, 167, 1863, 1835, 1069, 1561, 1094, 665, 1344, 567, 1548, 192, 1152, 788, 1912, 1229, 1395, 994, 1940, 1562, 786, 108, 1286, 716, 1521, 1514, 134, 727, 846, 511, 1083]

query I
PRAGMA backward_lineage("SELECT 100.00 * sum(CASE WHEN p_type LIKE 'PROMO%' THEN l_extendedprice * (1 - l_discount) ELSE 0 END) / sum(l_extendedprice * (1 - l_discount)) AS promo_revenue FROM lineitem, part WHERE l_partkey = p_partkey AND l_shipdate >= date '1995-09-01' AND l_shipdate < CAST('1995-10-01' AS date)", 'COUNT', '0')
----
1444

query I
PRAGMA backward_lineage("SELECT 100.00 * sum(CASE WHEN p_type LIKE 'PROMO%' THEN l_extendedprice * (1 - l_discount) ELSE 0 END) / sum(l_extendedprice * (1 - l_discount)) AS promo_revenue FROM lineitem, part WHERE l_partkey = p_partkey AND l_shipdate >= date '1995-09-01' AND l_shipdate < CAST('1995-10-01' AS date)", 'LIN', '0')
----
1444

query I
PRAGMA backward_lineage("SELECT 100.00 * sum(CASE WHEN p_type LIKE 'PROMO%' THEN l_extendedprice * (1 - l_discount) ELSE 0 END) / sum(l_extendedprice * (1 - l_discount)) AS promo_revenue FROM lineitem, part WHERE l_partkey = p_partkey AND l_shipdate >= date '1995-09-01' AND l_shipdate < CAST('1995-10-01' AS date)", 'PERM', '0')
----
1444

query I
PRAGMA backward_lineage("SELECT 100.00 * sum(CASE WHEN p_type LIKE 'PROMO%' THEN l_extendedprice * (1 - l_discount) ELSE 0 END) / sum(l_extendedprice * (1 - l_discount)) AS promo_revenue FROM lineitem, part WHERE l_partkey = p_partkey AND l_shipdate >= date '1995-09-01' AND l_shipdate < CAST('1995-10-01' AS date)", 'PROV', '0')
----
1444
