# name: test/sql/lineage/inmemory_tpch_queries/test_tpch_11.test
# description: Test TPC-H Query 11 in-memory
# group: [inmemory_tpch_queries]

require tpch

statement ok
CALL dbgen(sf=0.01);

statement ok
PRAGMA trace_lineage = "ON";

statement ok
SELECT ps_partkey, sum(ps_supplycost * ps_availqty) AS value FROM partsupp, supplier, nation WHERE ps_suppkey = s_suppkey AND s_nationkey = n_nationkey AND n_name = 'GERMANY' GROUP BY ps_partkey HAVING sum(ps_supplycost * ps_availqty) > (SELECT sum(ps_supplycost * ps_availqty) * 0.0001000000 FROM partsupp, supplier, nation WHERE ps_suppkey = s_suppkey AND s_nationkey = n_nationkey AND n_name = 'GERMANY') ORDER BY value DESC

statement ok
PRAGMA trace_lineage = "OFF";

# TODO still not 100% these are correct...

query I
PRAGMA backward_lineage("SELECT ps_partkey, sum(ps_supplycost * ps_availqty) AS value FROM partsupp, supplier, nation WHERE ps_suppkey = s_suppkey AND s_nationkey = n_nationkey AND n_name = 'GERMANY' GROUP BY ps_partkey HAVING sum(ps_supplycost * ps_availqty) > (SELECT sum(ps_supplycost * ps_availqty) * 0.0001000000 FROM partsupp, supplier, nation WHERE ps_suppkey = s_suppkey AND s_nationkey = n_nationkey AND n_name = 'GERMANY') ORDER BY value DESC", 'VALUE', '0')
----
[3, 76, 7, 6, 52, 7, 25, 32, 7, 35, 84, 7, 69, 43, 7, 102, 76, 7, 105, 52, 7, 124, 32, 7, 134, 84, 7, 168, 43, 7, 201, 76, 7, 204, 52, 7, 227, 32, 7, 233, 84, 7, 271, 43, 7, 300, 76, 7, 307, 52, 7, 326, 32, 7, 332, 84, 7, 370, 43, 7, 421, 32, 7, 423, 84, 7, 465, 43, 7, 494, 76, 7, 501, 52, 7, 524, 32, 7, 526, 84, 7, 568, 43, 7, 597, 76, 7, 604, 52, 7, 615, 32, 7, 629, 84, 7, 659, 43, 7, 695, 52, 7, 700, 76, 7, 718, 32, 7, 732, 84, 7, 762, 43, 7, 791, 76, 7, 798, 52, 7, 811, 84, 7, 817, 32, 7, 861, 43, 7, 886, 76, 7, 897, 52, 7, 918, 84, 7, 924, 32, 7, 968, 43, 7, 993, 76, 7, 1003, 32, 7, 1004, 52, 7, 1025, 84, 7, 1047, 43, 7, 1083, 52, 7, 1100, 76, 7, 1110, 32, 7, 1132, 84, 7, 1154, 43, 7, 1179, 76, 7, 1190, 52, 7, 1213, 32, 7, 1257, 43, 7, 1278, 76, 7, 1293, 52, 7, 1310, 84, 7, 1324, 32, 7, 1368, 43, 7, 1389, 76, 7, 1391, 32, 7, 1404, 52, 7, 1421, 84, 7, 1435, 43, 7, 1471, 52, 7, 1500, 76, 7, 1502, 32, 7, 1532, 84, 7, 1546, 43, 7, 1567, 76, 7, 1582, 52, 7, 1599, 84, 7, 1609, 32, 7, 1653, 43, 7, 1670, 76, 7, 1689, 52, 7, 1702, 84, 7, 1724, 32, 7, 1768, 43, 7, 1779, 32, 7, 1785, 76, 7, 1804, 52, 7, 1817, 84, 7, 1823, 43, 7, 1859, 52, 7, 1894, 32, 7, 1900, 76, 7, 1932, 84, 7, 1938, 43, 7, 1955, 76, 7, 1974, 52, 7, 1987, 84, 7, 2005, 32, 7, 2049, 43, 7, 2062, 76, 7, 2085, 52, 7, 2094, 84, 7, 2124, 32, 7, 2167, 32, 7, 2168, 43, 7, 2181, 76, 7, 2204, 52, 7, 2211, 43, 7, 2213, 84, 7, 2247, 52, 7, 2286, 32, 7, 2300, 76, 7, 2330, 43, 7, 2332, 84, 7, 2343, 76, 7, 2366, 52, 7, 2375, 84, 7, 2401, 32, 7, 2445, 43, 7, 2454, 76, 7, 2481, 52, 7, 2486, 84, 7, 2524, 32, 7, 2555, 32, 7, 2568, 43, 7, 2577, 76, 7, 2599, 43, 7, 2604, 52, 7, 2609, 84, 7, 2635, 52, 7, 2678, 32, 7, 2700, 76, 7, 2722, 43, 7, 2731, 76, 7, 2732, 84, 7, 2758, 52, 7, 2763, 84, 7, 2841, 43, 7, 2846, 76, 7, 2877, 52, 7, 2878, 84, 7, 2924, 32, 7, 2943, 32, 7, 2968, 43, 7, 2973, 76, 7, 2987, 43, 7, 3004, 52, 7, 3005, 84, 7, 3023, 52, 7, 3070, 32, 7, 3100, 76, 7, 3114, 43, 7, 3119, 76, 7, 3132, 84, 7, 3150, 52, 7, 3151, 84, 7, 3197, 32, 7, 3237, 43, 7, 3238, 76, 7, 3270, 84, 7, 3273, 52, 7, 3324, 32, 7, 3331, 32, 7, 3368, 43, 7, 3369, 76, 7, 3375, 43, 7, 3401, 84, 7, 3404, 52, 7, 3411, 52, 7, 3462, 32, 7, 3500, 76, 7, 3506, 43, 7, 3507, 76, 7, 3532, 84, 7, 3539, 84, 7, 3542, 52, 7, 3593, 32, 7, 3630, 76, 7, 3633, 43, 7, 3662, 84, 7, 3669, 52, 7, 3719, 32, 7, 3724, 32, 7, 3763, 43, 7, 3765, 76, 7, 3768, 43, 7, 3797, 84, 7, 3799, 52, 7, 3804, 52, 7, 3854, 32, 7, 3895, 76, 7, 3898, 43, 7, 3900, 76, 7, 3927, 84, 7, 3932, 84, 7, 3934, 52, 7, 3989, 32, 7, 4022, 76, 7, 4029, 43, 7, 4054, 84, 7, 4065, 52, 7, 4107, 32, 7, 4124, 32, 7, 4151, 43, 7, 4161, 76, 7, 4168, 43, 7, 4187, 52, 7, 4193, 84, 7, 4204, 52, 7, 4246, 32, 7, 4283, 76, 7, 4290, 43, 7, 4300, 76, 7, 4315, 84, 7, 4326, 52, 7, 4332, 84, 7, 4385, 32, 7, 4414, 76, 7, 4425, 43, 7, 4446, 84, 7, 4461, 52, 7, 4495, 32, 7, 4524, 32, 7, 4539, 43, 7, 4557, 76, 7, 4568, 43, 7, 4575, 52, 7, 4589, 84, 7, 4604, 52, 7, 4638, 32, 7, 4671, 76, 7, 4682, 43, 7, 4700, 76, 7, 4703, 84, 7, 4718, 52, 7, 4732, 84, 7, 4781, 32, 7, 4806, 76, 7, 4821, 43, 7, 4838, 84, 7, 4857, 52, 7, 4883, 32, 7, 4924, 32, 7, 4927, 43, 7, 4953, 76, 7, 4963, 52, 7, 4968, 43, 7, 4985, 84, 7, 5004, 52, 7, 5030, 32, 7, 5059, 76, 7, 5074, 43, 7, 5091, 84, 7, 5100, 76, 7, 5110, 52, 7, 5132, 84, 7, 5177, 32, 7, 5217, 43, 7, 5230, 84, 7, 5253, 52, 7, 5271, 32, 7, 5315, 43, 7, 5324, 32, 7, 5349, 76, 7, 5351, 52, 7, 5368, 43, 7, 5381, 84, 7, 5404, 52, 7, 5422, 32, 7, 5447, 76, 7, 5466, 43, 7, 5479, 84, 7, 5500, 76, 7, 5502, 52, 7, 5532, 84, 7, 5573, 32, 7, 5598, 76, 7, 5613, 43, 7, 5622, 84, 7, 5649, 52, 7, 5659, 32, 7, 5703, 43, 7, 5724, 32, 7, 5739, 52, 7, 5745, 76, 7, 5768, 43, 7, 5777, 84, 7, 5804, 52, 7, 5814, 32, 7, 5835, 76, 7, 5858, 43, 7, 5867, 84, 7, 5894, 52, 7, 5900, 76, 7, 5932, 84, 7, 5969, 32, 7, 5990, 76, 7, 6009, 43, 7, 6014, 84, 7, 6045, 52, 7, 6047, 32, 7, 6091, 43, 7, 6124, 32, 7, 6127, 52, 7, 6141, 76, 7, 6168, 43, 7, 6173, 84, 7, 6204, 52, 7, 6206, 32, 7, 6223, 76, 7, 6250, 43, 7, 6255, 84, 7, 6286, 52, 7, 6300, 76, 7, 6332, 84, 7, 6365, 32, 7, 6382, 76, 7, 6405, 43, 7, 6406, 84, 7, 6435, 32, 7, 6441, 52, 7, 6479, 43, 7, 6515, 52, 7, 6524, 32, 7, 6537, 76, 7, 6568, 43, 7, 6569, 84, 7, 6598, 32, 7, 6604, 52, 7, 6611, 76, 7, 6642, 43, 7, 6643, 84, 7, 6678, 52, 7, 6700, 76, 7, 6732, 84, 7, 6761, 32, 7, 6774, 76, 7, 6801, 43, 7, 6823, 32, 7, 6837, 52, 7, 6867, 43, 7, 6903, 52, 7, 6924, 32, 7, 6933, 76, 7, 6965, 84, 7, 6968, 43, 7, 6990, 32, 7, 6999, 76, 7, 7004, 52, 7, 7031, 84, 7, 7034, 43, 7, 7070, 52, 7, 7100, 76, 7, 7132, 84, 7, 7157, 32, 7, 7166, 76, 7, 7198, 84, 7, 7211, 32, 7, 7233, 52, 7, 7255, 43, 7, 7291, 52, 7, 7324, 32, 7, 7329, 76, 7, 7361, 84, 7, 7368, 43, 7, 7382, 32, 7, 7387, 76, 7, 7404, 52, 7, 7419, 84, 7, 7426, 43, 7, 7462, 52, 7, 7500, 76, 7, 7532, 84, 7, 7553, 32, 7, 7558, 76, 7, 7590, 84, 7, 7597, 43, 7, 7629, 52, 7, 7643, 43, 7, 7679, 52, 7, 7724, 32, 7, 7725, 76, 7, 7757, 84, 7, 7768, 43, 7, 7774, 32, 7, 7775, 76, 7, 7804, 52, 7, 7807, 84, 7, 7818, 43, 7, 7854, 52, 7, 7900, 76, 7, 7932, 84, 7, 7949, 32, 7, 7950, 76, 7, 7982, 84, 7, 7993, 43, 7, 7999, 32, 7, 5500, 76, 7, 5502, 52, 7]

query I
PRAGMA backward_lineage("SELECT ps_partkey, sum(ps_supplycost * ps_availqty) AS value FROM partsupp, supplier, nation WHERE ps_suppkey = s_suppkey AND s_nationkey = n_nationkey AND n_name = 'GERMANY' GROUP BY ps_partkey HAVING sum(ps_supplycost * ps_availqty) > (SELECT sum(ps_supplycost * ps_availqty) * 0.0001000000 FROM partsupp, supplier, nation WHERE ps_suppkey = s_suppkey AND s_nationkey = n_nationkey AND n_name = 'GERMANY') ORDER BY value DESC", 'VALUE', '200')
----
[3, 76, 7, 6, 52, 7, 25, 32, 7, 35, 84, 7, 69, 43, 7, 102, 76, 7, 105, 52, 7, 124, 32, 7, 134, 84, 7, 168, 43, 7, 201, 76, 7, 204, 52, 7, 227, 32, 7, 233, 84, 7, 271, 43, 7, 300, 76, 7, 307, 52, 7, 326, 32, 7, 332, 84, 7, 370, 43, 7, 421, 32, 7, 423, 84, 7, 465, 43, 7, 494, 76, 7, 501, 52, 7, 524, 32, 7, 526, 84, 7, 568, 43, 7, 597, 76, 7, 604, 52, 7, 615, 32, 7, 629, 84, 7, 659, 43, 7, 695, 52, 7, 700, 76, 7, 718, 32, 7, 732, 84, 7, 762, 43, 7, 791, 76, 7, 798, 52, 7, 811, 84, 7, 817, 32, 7, 861, 43, 7, 886, 76, 7, 897, 52, 7, 918, 84, 7, 924, 32, 7, 968, 43, 7, 993, 76, 7, 1003, 32, 7, 1004, 52, 7, 1025, 84, 7, 1047, 43, 7, 1083, 52, 7, 1100, 76, 7, 1110, 32, 7, 1132, 84, 7, 1154, 43, 7, 1179, 76, 7, 1190, 52, 7, 1213, 32, 7, 1257, 43, 7, 1278, 76, 7, 1293, 52, 7, 1310, 84, 7, 1324, 32, 7, 1368, 43, 7, 1389, 76, 7, 1391, 32, 7, 1404, 52, 7, 1421, 84, 7, 1435, 43, 7, 1471, 52, 7, 1500, 76, 7, 1502, 32, 7, 1532, 84, 7, 1546, 43, 7, 1567, 76, 7, 1582, 52, 7, 1599, 84, 7, 1609, 32, 7, 1653, 43, 7, 1670, 76, 7, 1689, 52, 7, 1702, 84, 7, 1724, 32, 7, 1768, 43, 7, 1779, 32, 7, 1785, 76, 7, 1804, 52, 7, 1817, 84, 7, 1823, 43, 7, 1859, 52, 7, 1894, 32, 7, 1900, 76, 7, 1932, 84, 7, 1938, 43, 7, 1955, 76, 7, 1974, 52, 7, 1987, 84, 7, 2005, 32, 7, 2049, 43, 7, 2062, 76, 7, 2085, 52, 7, 2094, 84, 7, 2124, 32, 7, 2167, 32, 7, 2168, 43, 7, 2181, 76, 7, 2204, 52, 7, 2211, 43, 7, 2213, 84, 7, 2247, 52, 7, 2286, 32, 7, 2300, 76, 7, 2330, 43, 7, 2332, 84, 7, 2343, 76, 7, 2366, 52, 7, 2375, 84, 7, 2401, 32, 7, 2445, 43, 7, 2454, 76, 7, 2481, 52, 7, 2486, 84, 7, 2524, 32, 7, 2555, 32, 7, 2568, 43, 7, 2577, 76, 7, 2599, 43, 7, 2604, 52, 7, 2609, 84, 7, 2635, 52, 7, 2678, 32, 7, 2700, 76, 7, 2722, 43, 7, 2731, 76, 7, 2732, 84, 7, 2758, 52, 7, 2763, 84, 7, 2841, 43, 7, 2846, 76, 7, 2877, 52, 7, 2878, 84, 7, 2924, 32, 7, 2943, 32, 7, 2968, 43, 7, 2973, 76, 7, 2987, 43, 7, 3004, 52, 7, 3005, 84, 7, 3023, 52, 7, 3070, 32, 7, 3100, 76, 7, 3114, 43, 7, 3119, 76, 7, 3132, 84, 7, 3150, 52, 7, 3151, 84, 7, 3197, 32, 7, 3237, 43, 7, 3238, 76, 7, 3270, 84, 7, 3273, 52, 7, 3324, 32, 7, 3331, 32, 7, 3368, 43, 7, 3369, 76, 7, 3375, 43, 7, 3401, 84, 7, 3404, 52, 7, 3411, 52, 7, 3462, 32, 7, 3500, 76, 7, 3506, 43, 7, 3507, 76, 7, 3532, 84, 7, 3539, 84, 7, 3542, 52, 7, 3593, 32, 7, 3630, 76, 7, 3633, 43, 7, 3662, 84, 7, 3669, 52, 7, 3719, 32, 7, 3724, 32, 7, 3763, 43, 7, 3765, 76, 7, 3768, 43, 7, 3797, 84, 7, 3799, 52, 7, 3804, 52, 7, 3854, 32, 7, 3895, 76, 7, 3898, 43, 7, 3900, 76, 7, 3927, 84, 7, 3932, 84, 7, 3934, 52, 7, 3989, 32, 7, 4022, 76, 7, 4029, 43, 7, 4054, 84, 7, 4065, 52, 7, 4107, 32, 7, 4124, 32, 7, 4151, 43, 7, 4161, 76, 7, 4168, 43, 7, 4187, 52, 7, 4193, 84, 7, 4204, 52, 7, 4246, 32, 7, 4283, 76, 7, 4290, 43, 7, 4300, 76, 7, 4315, 84, 7, 4326, 52, 7, 4332, 84, 7, 4385, 32, 7, 4414, 76, 7, 4425, 43, 7, 4446, 84, 7, 4461, 52, 7, 4495, 32, 7, 4524, 32, 7, 4539, 43, 7, 4557, 76, 7, 4568, 43, 7, 4575, 52, 7, 4589, 84, 7, 4604, 52, 7, 4638, 32, 7, 4671, 76, 7, 4682, 43, 7, 4700, 76, 7, 4703, 84, 7, 4718, 52, 7, 4732, 84, 7, 4781, 32, 7, 4806, 76, 7, 4821, 43, 7, 4838, 84, 7, 4857, 52, 7, 4883, 32, 7, 4924, 32, 7, 4927, 43, 7, 4953, 76, 7, 4963, 52, 7, 4968, 43, 7, 4985, 84, 7, 5004, 52, 7, 5030, 32, 7, 5059, 76, 7, 5074, 43, 7, 5091, 84, 7, 5100, 76, 7, 5110, 52, 7, 5132, 84, 7, 5177, 32, 7, 5217, 43, 7, 5230, 84, 7, 5253, 52, 7, 5271, 32, 7, 5315, 43, 7, 5324, 32, 7, 5349, 76, 7, 5351, 52, 7, 5368, 43, 7, 5381, 84, 7, 5404, 52, 7, 5422, 32, 7, 5447, 76, 7, 5466, 43, 7, 5479, 84, 7, 5500, 76, 7, 5502, 52, 7, 5532, 84, 7, 5573, 32, 7, 5598, 76, 7, 5613, 43, 7, 5622, 84, 7, 5649, 52, 7, 5659, 32, 7, 5703, 43, 7, 5724, 32, 7, 5739, 52, 7, 5745, 76, 7, 5768, 43, 7, 5777, 84, 7, 5804, 52, 7, 5814, 32, 7, 5835, 76, 7, 5858, 43, 7, 5867, 84, 7, 5894, 52, 7, 5900, 76, 7, 5932, 84, 7, 5969, 32, 7, 5990, 76, 7, 6009, 43, 7, 6014, 84, 7, 6045, 52, 7, 6047, 32, 7, 6091, 43, 7, 6124, 32, 7, 6127, 52, 7, 6141, 76, 7, 6168, 43, 7, 6173, 84, 7, 6204, 52, 7, 6206, 32, 7, 6223, 76, 7, 6250, 43, 7, 6255, 84, 7, 6286, 52, 7, 6300, 76, 7, 6332, 84, 7, 6365, 32, 7, 6382, 76, 7, 6405, 43, 7, 6406, 84, 7, 6435, 32, 7, 6441, 52, 7, 6479, 43, 7, 6515, 52, 7, 6524, 32, 7, 6537, 76, 7, 6568, 43, 7, 6569, 84, 7, 6598, 32, 7, 6604, 52, 7, 6611, 76, 7, 6642, 43, 7, 6643, 84, 7, 6678, 52, 7, 6700, 76, 7, 6732, 84, 7, 6761, 32, 7, 6774, 76, 7, 6801, 43, 7, 6823, 32, 7, 6837, 52, 7, 6867, 43, 7, 6903, 52, 7, 6924, 32, 7, 6933, 76, 7, 6965, 84, 7, 6968, 43, 7, 6990, 32, 7, 6999, 76, 7, 7004, 52, 7, 7031, 84, 7, 7034, 43, 7, 7070, 52, 7, 7100, 76, 7, 7132, 84, 7, 7157, 32, 7, 7166, 76, 7, 7198, 84, 7, 7211, 32, 7, 7233, 52, 7, 7255, 43, 7, 7291, 52, 7, 7324, 32, 7, 7329, 76, 7, 7361, 84, 7, 7368, 43, 7, 7382, 32, 7, 7387, 76, 7, 7404, 52, 7, 7419, 84, 7, 7426, 43, 7, 7462, 52, 7, 7500, 76, 7, 7532, 84, 7, 7553, 32, 7, 7558, 76, 7, 7590, 84, 7, 7597, 43, 7, 7629, 52, 7, 7643, 43, 7, 7679, 52, 7, 7724, 32, 7, 7725, 76, 7, 7757, 84, 7, 7768, 43, 7, 7774, 32, 7, 7775, 76, 7, 7804, 52, 7, 7807, 84, 7, 7818, 43, 7, 7854, 52, 7, 7900, 76, 7, 7932, 84, 7, 7949, 32, 7, 7950, 76, 7, 7982, 84, 7, 7993, 43, 7, 7999, 32, 7, 968, 43, 7]

query I
PRAGMA backward_lineage("SELECT ps_partkey, sum(ps_supplycost * ps_availqty) AS value FROM partsupp, supplier, nation WHERE ps_suppkey = s_suppkey AND s_nationkey = n_nationkey AND n_name = 'GERMANY' GROUP BY ps_partkey HAVING sum(ps_supplycost * ps_availqty) > (SELECT sum(ps_supplycost * ps_availqty) * 0.0001000000 FROM partsupp, supplier, nation WHERE ps_suppkey = s_suppkey AND s_nationkey = n_nationkey AND n_name = 'GERMANY') ORDER BY value DESC", 'COUNT', '0')
----
1206

query I
PRAGMA backward_lineage("SELECT ps_partkey, sum(ps_supplycost * ps_availqty) AS value FROM partsupp, supplier, nation WHERE ps_suppkey = s_suppkey AND s_nationkey = n_nationkey AND n_name = 'GERMANY' GROUP BY ps_partkey HAVING sum(ps_supplycost * ps_availqty) > (SELECT sum(ps_supplycost * ps_availqty) * 0.0001000000 FROM partsupp, supplier, nation WHERE ps_suppkey = s_suppkey AND s_nationkey = n_nationkey AND n_name = 'GERMANY') ORDER BY value DESC", 'COUNT', '200')
----
1203
