# name: test/sql/lineage/inmemory_tpch_queries/test_tpch_11.test
# description: Test TPC-H Query 11 in-memory
# group: [inmemory_tpch_queries]

require tpch

statement ok
CALL dbgen(sf=0.01);

statement ok
PRAGMA trace_lineage = "ON";

statement ok
SELECT ps_partkey, sum(ps_supplycost * ps_availqty) AS value FROM partsupp, supplier, nation WHERE ps_suppkey = s_suppkey AND s_nationkey = n_nationkey AND n_name = 'GERMANY' GROUP BY ps_partkey HAVING sum(ps_supplycost * ps_availqty) > (SELECT sum(ps_supplycost * ps_availqty) * 0.0001000000 FROM partsupp, supplier, nation WHERE ps_suppkey = s_suppkey AND s_nationkey = n_nationkey AND n_name = 'GERMANY') ORDER BY value DESC

statement ok
PRAGMA trace_lineage = "OFF";

# TODO still not 100% these are correct...

query I
PRAGMA lineage_query("SELECT ps_partkey, sum(ps_supplycost * ps_availqty) AS value FROM partsupp, supplier, nation WHERE ps_suppkey = s_suppkey AND s_nationkey = n_nationkey AND n_name = 'GERMANY' GROUP BY ps_partkey HAVING sum(ps_supplycost * ps_availqty) > (SELECT sum(ps_supplycost * ps_availqty) * 0.0001000000 FROM partsupp, supplier, nation WHERE ps_suppkey = s_suppkey AND s_nationkey = n_nationkey AND n_name = 'GERMANY') ORDER BY value DESC", 0, 'LIN', 0)
----
[5500, 5502, 3, 6, 25, 35, 69, 102, 105, 124, 134, 168, 201, 204, 227, 233, 271, 300, 307, 326, 332, 370, 421, 423, 465, 494, 501, 524, 526, 568, 597, 604, 615, 629, 659, 695, 700, 718, 732, 762, 791, 798, 811, 817, 861, 886, 897, 918, 924, 968, 993, 1003, 1004, 1025, 1047, 1083, 1100, 1110, 1132, 1154, 1179, 1190, 1213, 1257, 1278, 1293, 1310, 1324, 1368, 1389, 1391, 1404, 1421, 1435, 1471, 1500, 1502, 1532, 1546, 1567, 1582, 1599, 1609, 1653, 1670, 1689, 1702, 1724, 1768, 1779, 1785, 1804, 1817, 1823, 1859, 1894, 1900, 1932, 1938, 1955, 1974, 1987, 2005, 2049, 2062, 2085, 2094, 2124, 2167, 2168, 2181, 2204, 2211, 2213, 2247, 2286, 2300, 2330, 2332, 2343, 2366, 2375, 2401, 2445, 2454, 2481, 2486, 2524, 2555, 2568, 2577, 2599, 2604, 2609, 2635, 2678, 2700, 2722, 2731, 2732, 2758, 2763, 2841, 2846, 2877, 2878, 2924, 2943, 2968, 2973, 2987, 3004, 3005, 3023, 3070, 3100, 3114, 3119, 3132, 3150, 3151, 3197, 3237, 3238, 3270, 3273, 3324, 3331, 3368, 3369, 3375, 3401, 3404, 3411, 3462, 3500, 3506, 3507, 3532, 3539, 3542, 3593, 3630, 3633, 3662, 3669, 3719, 3724, 3763, 3765, 3768, 3797, 3799, 3804, 3854, 3895, 3898, 3900, 3927, 3932, 3934, 3989, 4022, 4029, 4054, 4065, 4107, 4124, 4151, 4161, 4168, 4187, 4193, 4204, 4246, 4283, 4290, 4300, 4315, 4326, 4332, 4385, 4414, 4425, 4446, 4461, 4495, 4524, 4539, 4557, 4568, 4575, 4589, 4604, 4638, 4671, 4682, 4700, 4703, 4718, 4732, 4781, 4806, 4821, 4838, 4857, 4883, 4924, 4927, 4953, 4963, 4968, 4985, 5004, 5030, 5059, 5074, 5091, 5100, 5110, 5132, 5177, 5217, 5230, 5253, 5271, 5315, 5324, 5349, 5351, 5368, 5381, 5404, 5422, 5447, 5466, 5479, 5500, 5502, 5532, 5573, 5598, 5613, 5622, 5649, 5659, 5703, 5724, 5739, 5745, 5768, 5777, 5804, 5814, 5835, 5858, 5867, 5894, 5900, 5932, 5969, 5990, 6009, 6014, 6045, 6047, 6091, 6124, 6127, 6141, 6168, 6173, 6204, 6206, 6223, 6250, 6255, 6286, 6300, 6332, 6365, 6382, 6405, 6406, 6435, 6441, 6479, 6515, 6524, 6537, 6568, 6569, 6598, 6604, 6611, 6642, 6643, 6678, 6700, 6732, 6761, 6774, 6801, 6823, 6837, 6867, 6903, 6924, 6933, 6965, 6968, 6990, 6999, 7004, 7031, 7034, 7070, 7100, 7132, 7157, 7166, 7198, 7211, 7233, 7255, 7291, 7324, 7329, 7361, 7368, 7382, 7387, 7404, 7419, 7426, 7462, 7500, 7532, 7553, 7558, 7590, 7597, 7629, 7643, 7679, 7724, 7725, 7757, 7768, 7774, 7775, 7804, 7807, 7818, 7854, 7900, 7932, 7949, 7950, 7982, 7993, 7999, 76, 52, 32, 84, 43, 76, 52, 32, 84, 43, 76, 52, 32, 84, 43, 76, 52, 32, 84, 43, 32, 84, 43, 76, 52, 32, 84, 43, 76, 52, 32, 84, 43, 52, 76, 32, 84, 43, 76, 52, 84, 32, 43, 76, 52, 84, 32, 43, 76, 32, 52, 84, 43, 52, 76, 32, 84, 43, 76, 52, 32, 43, 76, 52, 84, 32, 43, 76, 32, 52, 84, 43, 52, 76, 32, 84, 43, 76, 52, 84, 32, 43, 76, 52, 84, 32, 43, 32, 76, 52, 84, 43, 52, 32, 76, 84, 43, 76, 52, 84, 32, 43, 76, 52, 84, 32, 32, 43, 76, 52, 43, 84, 52, 32, 76, 43, 84, 76, 52, 84, 32, 43, 76, 52, 84, 32, 32, 43, 76, 43, 52, 84, 52, 32, 76, 43, 76, 84, 52, 84, 43, 76, 52, 84, 32, 32, 43, 76, 43, 52, 84, 52, 32, 76, 43, 76, 84, 52, 84, 32, 43, 76, 84, 52, 32, 32, 43, 76, 43, 84, 52, 52, 32, 76, 43, 76, 84, 84, 52, 32, 76, 43, 84, 52, 32, 32, 43, 76, 43, 84, 52, 52, 32, 76, 43, 76, 84, 84, 52, 32, 76, 43, 84, 52, 32, 32, 43, 76, 43, 52, 84, 52, 32, 76, 43, 76, 84, 52, 84, 32, 76, 43, 84, 52, 32, 32, 43, 76, 43, 52, 84, 52, 32, 76, 43, 76, 84, 52, 84, 32, 76, 43, 84, 52, 32, 32, 43, 76, 52, 43, 84, 52, 32, 76, 43, 84, 76, 52, 84, 32, 43, 84, 52, 32, 43, 32, 76, 52, 43, 84, 52, 32, 76, 43, 84, 76, 52, 84, 32, 76, 43, 84, 52, 32, 43, 32, 52, 76, 43, 84, 52, 32, 76, 43, 84, 52, 76, 84, 32, 76, 43, 84, 52, 32, 43, 32, 52, 76, 43, 84, 52, 32, 76, 43, 84, 52, 76, 84, 32, 76, 43, 84, 32, 52, 43, 52, 32, 76, 43, 84, 32, 52, 76, 43, 84, 52, 76, 84, 32, 76, 43, 32, 52, 43, 52, 32, 76, 84, 43, 32, 76, 52, 84, 43, 52, 76, 84, 32, 76, 84, 32, 52, 43, 52, 32, 76, 84, 43, 32, 76, 52, 84, 43, 52, 76, 84, 32, 76, 84, 43, 52, 43, 52, 32, 76, 84, 43, 32, 76, 52, 84, 43, 52, 76, 84, 32, 76, 84, 43, 32, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 76, 52, 7, 7]

query I
PRAGMA lineage_query("SELECT ps_partkey, sum(ps_supplycost * ps_availqty) AS value FROM partsupp, supplier, nation WHERE ps_suppkey = s_suppkey AND s_nationkey = n_nationkey AND n_name = 'GERMANY' GROUP BY ps_partkey HAVING sum(ps_supplycost * ps_availqty) > (SELECT sum(ps_supplycost * ps_availqty) * 0.0001000000 FROM partsupp, supplier, nation WHERE ps_suppkey = s_suppkey AND s_nationkey = n_nationkey AND n_name = 'GERMANY') ORDER BY value DESC", 200, 'LIN', 0)
----
[968, 3, 6, 25, 35, 69, 102, 105, 124, 134, 168, 201, 204, 227, 233, 271, 300, 307, 326, 332, 370, 421, 423, 465, 494, 501, 524, 526, 568, 597, 604, 615, 629, 659, 695, 700, 718, 732, 762, 791, 798, 811, 817, 861, 886, 897, 918, 924, 968, 993, 1003, 1004, 1025, 1047, 1083, 1100, 1110, 1132, 1154, 1179, 1190, 1213, 1257, 1278, 1293, 1310, 1324, 1368, 1389, 1391, 1404, 1421, 1435, 1471, 1500, 1502, 1532, 1546, 1567, 1582, 1599, 1609, 1653, 1670, 1689, 1702, 1724, 1768, 1779, 1785, 1804, 1817, 1823, 1859, 1894, 1900, 1932, 1938, 1955, 1974, 1987, 2005, 2049, 2062, 2085, 2094, 2124, 2167, 2168, 2181, 2204, 2211, 2213, 2247, 2286, 2300, 2330, 2332, 2343, 2366, 2375, 2401, 2445, 2454, 2481, 2486, 2524, 2555, 2568, 2577, 2599, 2604, 2609, 2635, 2678, 2700, 2722, 2731, 2732, 2758, 2763, 2841, 2846, 2877, 2878, 2924, 2943, 2968, 2973, 2987, 3004, 3005, 3023, 3070, 3100, 3114, 3119, 3132, 3150, 3151, 3197, 3237, 3238, 3270, 3273, 3324, 3331, 3368, 3369, 3375, 3401, 3404, 3411, 3462, 3500, 3506, 3507, 3532, 3539, 3542, 3593, 3630, 3633, 3662, 3669, 3719, 3724, 3763, 3765, 3768, 3797, 3799, 3804, 3854, 3895, 3898, 3900, 3927, 3932, 3934, 3989, 4022, 4029, 4054, 4065, 4107, 4124, 4151, 4161, 4168, 4187, 4193, 4204, 4246, 4283, 4290, 4300, 4315, 4326, 4332, 4385, 4414, 4425, 4446, 4461, 4495, 4524, 4539, 4557, 4568, 4575, 4589, 4604, 4638, 4671, 4682, 4700, 4703, 4718, 4732, 4781, 4806, 4821, 4838, 4857, 4883, 4924, 4927, 4953, 4963, 4968, 4985, 5004, 5030, 5059, 5074, 5091, 5100, 5110, 5132, 5177, 5217, 5230, 5253, 5271, 5315, 5324, 5349, 5351, 5368, 5381, 5404, 5422, 5447, 5466, 5479, 5500, 5502, 5532, 5573, 5598, 5613, 5622, 5649, 5659, 5703, 5724, 5739, 5745, 5768, 5777, 5804, 5814, 5835, 5858, 5867, 5894, 5900, 5932, 5969, 5990, 6009, 6014, 6045, 6047, 6091, 6124, 6127, 6141, 6168, 6173, 6204, 6206, 6223, 6250, 6255, 6286, 6300, 6332, 6365, 6382, 6405, 6406, 6435, 6441, 6479, 6515, 6524, 6537, 6568, 6569, 6598, 6604, 6611, 6642, 6643, 6678, 6700, 6732, 6761, 6774, 6801, 6823, 6837, 6867, 6903, 6924, 6933, 6965, 6968, 6990, 6999, 7004, 7031, 7034, 7070, 7100, 7132, 7157, 7166, 7198, 7211, 7233, 7255, 7291, 7324, 7329, 7361, 7368, 7382, 7387, 7404, 7419, 7426, 7462, 7500, 7532, 7553, 7558, 7590, 7597, 7629, 7643, 7679, 7724, 7725, 7757, 7768, 7774, 7775, 7804, 7807, 7818, 7854, 7900, 7932, 7949, 7950, 7982, 7993, 7999, 76, 52, 32, 84, 43, 76, 52, 32, 84, 43, 76, 52, 32, 84, 43, 76, 52, 32, 84, 43, 32, 84, 43, 76, 52, 32, 84, 43, 76, 52, 32, 84, 43, 52, 76, 32, 84, 43, 76, 52, 84, 32, 43, 76, 52, 84, 32, 43, 76, 32, 52, 84, 43, 52, 76, 32, 84, 43, 76, 52, 32, 43, 76, 52, 84, 32, 43, 76, 32, 52, 84, 43, 52, 76, 32, 84, 43, 76, 52, 84, 32, 43, 76, 52, 84, 32, 43, 32, 76, 52, 84, 43, 52, 32, 76, 84, 43, 76, 52, 84, 32, 43, 76, 52, 84, 32, 32, 43, 76, 52, 43, 84, 52, 32, 76, 43, 84, 76, 52, 84, 32, 43, 76, 52, 84, 32, 32, 43, 76, 43, 52, 84, 52, 32, 76, 43, 76, 84, 52, 84, 43, 76, 52, 84, 32, 32, 43, 76, 43, 52, 84, 52, 32, 76, 43, 76, 84, 52, 84, 32, 43, 76, 84, 52, 32, 32, 43, 76, 43, 84, 52, 52, 32, 76, 43, 76, 84, 84, 52, 32, 76, 43, 84, 52, 32, 32, 43, 76, 43, 84, 52, 52, 32, 76, 43, 76, 84, 84, 52, 32, 76, 43, 84, 52, 32, 32, 43, 76, 43, 52, 84, 52, 32, 76, 43, 76, 84, 52, 84, 32, 76, 43, 84, 52, 32, 32, 43, 76, 43, 52, 84, 52, 32, 76, 43, 76, 84, 52, 84, 32, 76, 43, 84, 52, 32, 32, 43, 76, 52, 43, 84, 52, 32, 76, 43, 84, 76, 52, 84, 32, 43, 84, 52, 32, 43, 32, 76, 52, 43, 84, 52, 32, 76, 43, 84, 76, 52, 84, 32, 76, 43, 84, 52, 32, 43, 32, 52, 76, 43, 84, 52, 32, 76, 43, 84, 52, 76, 84, 32, 76, 43, 84, 52, 32, 43, 32, 52, 76, 43, 84, 52, 32, 76, 43, 84, 52, 76, 84, 32, 76, 43, 84, 32, 52, 43, 52, 32, 76, 43, 84, 32, 52, 76, 43, 84, 52, 76, 84, 32, 76, 43, 32, 52, 43, 52, 32, 76, 84, 43, 32, 76, 52, 84, 43, 52, 76, 84, 32, 76, 84, 32, 52, 43, 52, 32, 76, 84, 43, 32, 76, 52, 84, 43, 52, 76, 84, 32, 76, 84, 43, 52, 43, 52, 32, 76, 84, 43, 32, 76, 52, 84, 43, 52, 76, 84, 32, 76, 84, 43, 32, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 43, 7]

query I
PRAGMA backward_lineage("SELECT ps_partkey, sum(ps_supplycost * ps_availqty) AS value FROM partsupp, supplier, nation WHERE ps_suppkey = s_suppkey AND s_nationkey = n_nationkey AND n_name = 'GERMANY' GROUP BY ps_partkey HAVING sum(ps_supplycost * ps_availqty) > (SELECT sum(ps_supplycost * ps_availqty) * 0.0001000000 FROM partsupp, supplier, nation WHERE ps_suppkey = s_suppkey AND s_nationkey = n_nationkey AND n_name = 'GERMANY') ORDER BY value DESC", 'COUNT', '0')
----
1206

query I
PRAGMA backward_lineage("SELECT ps_partkey, sum(ps_supplycost * ps_availqty) AS value FROM partsupp, supplier, nation WHERE ps_suppkey = s_suppkey AND s_nationkey = n_nationkey AND n_name = 'GERMANY' GROUP BY ps_partkey HAVING sum(ps_supplycost * ps_availqty) > (SELECT sum(ps_supplycost * ps_availqty) * 0.0001000000 FROM partsupp, supplier, nation WHERE ps_suppkey = s_suppkey AND s_nationkey = n_nationkey AND n_name = 'GERMANY') ORDER BY value DESC", 'LIN', '0')
----
1206

query I
PRAGMA backward_lineage("SELECT ps_partkey, sum(ps_supplycost * ps_availqty) AS value FROM partsupp, supplier, nation WHERE ps_suppkey = s_suppkey AND s_nationkey = n_nationkey AND n_name = 'GERMANY' GROUP BY ps_partkey HAVING sum(ps_supplycost * ps_availqty) > (SELECT sum(ps_supplycost * ps_availqty) * 0.0001000000 FROM partsupp, supplier, nation WHERE ps_suppkey = s_suppkey AND s_nationkey = n_nationkey AND n_name = 'GERMANY') ORDER BY value DESC", 'PERM', '0')
----
1206

query I
PRAGMA backward_lineage("SELECT ps_partkey, sum(ps_supplycost * ps_availqty) AS value FROM partsupp, supplier, nation WHERE ps_suppkey = s_suppkey AND s_nationkey = n_nationkey AND n_name = 'GERMANY' GROUP BY ps_partkey HAVING sum(ps_supplycost * ps_availqty) > (SELECT sum(ps_supplycost * ps_availqty) * 0.0001000000 FROM partsupp, supplier, nation WHERE ps_suppkey = s_suppkey AND s_nationkey = n_nationkey AND n_name = 'GERMANY') ORDER BY value DESC", 'PROV', '0')
----
1206

query I
PRAGMA backward_lineage("SELECT ps_partkey, sum(ps_supplycost * ps_availqty) AS value FROM partsupp, supplier, nation WHERE ps_suppkey = s_suppkey AND s_nationkey = n_nationkey AND n_name = 'GERMANY' GROUP BY ps_partkey HAVING sum(ps_supplycost * ps_availqty) > (SELECT sum(ps_supplycost * ps_availqty) * 0.0001000000 FROM partsupp, supplier, nation WHERE ps_suppkey = s_suppkey AND s_nationkey = n_nationkey AND n_name = 'GERMANY') ORDER BY value DESC", 'COUNT', '200')
----
1203
