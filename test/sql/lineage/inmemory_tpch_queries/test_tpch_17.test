# name: test/sql/lineage/inmemory_tpch_queries/test_tpch_17.test
# description: Test TPC-H Query 17 in-memory
# group: [inmemory_tpch_queries]

require tpch

statement ok
CALL dbgen(sf=0.1);

statement ok
PRAGMA trace_lineage = "ON";

statement ok
SELECT sum(l_extendedprice) / 7.0 AS avg_yearly FROM lineitem, part WHERE p_partkey = l_partkey AND p_brand = 'Brand#23' AND p_container = 'MED BOX' AND l_quantity < (  SELECT 0.2 * avg(l_quantity)  FROM  lineitem   WHERE  l_partkey = p_partkey);

statement ok
PRAGMA trace_lineage = "OFF";

query I
PRAGMA lineage_query("SELECT sum(l_extendedprice) / 7.0 AS avg_yearly FROM lineitem, part WHERE p_partkey = l_partkey AND p_brand = 'Brand#23' AND p_container = 'MED BOX' AND l_quantity < (  SELECT 0.2 * avg(l_quantity)  FROM  lineitem   WHERE  l_partkey = p_partkey);", 0, 'LIN', 0)
----
[32366, 94002, 95007, 99417, 105402, 140146, 142373, 143384, 147287, 152378, 152838, 160143, 163431, 191197, 250061, 263432, 275665, 284680, 333052, 364659, 377864, 378912, 389369, 398320, 403816, 413474, 414961, 453890, 459348, 485257, 498410, 508673, 532921, 538311, 549480, 559949, 564178, 579999, 581086, 589379, 592564, 594123, 594923, 32366, 70706, 71219, 76311, 112421, 116075, 131509, 143384, 152838, 192925, 213780, 264121, 283201, 283560, 291518, 364659, 368008, 388668, 421965, 465049, 478152, 533947, 547110, 551118, 582622, 583440, 586837, 592564, 10186, 14274, 26319, 92089, 94002, 127549, 138959, 168333, 199470, 213523, 242834, 251248, 263800, 271714, 275665, 297463, 307130, 340907, 361663, 395121, 407905, 420145, 426197, 431175, 461235, 479555, 495040, 533428, 535067, 595621, 14742, 61763, 65553, 85576, 86798, 93284, 95007, 117348, 152378, 160286, 173732, 194510, 212899, 249089, 273611, 287112, 307664, 353108, 358347, 374845, 385588, 437137, 452887, 465592, 466528, 490961, 531913, 533390, 549480, 571860, 598146, 2466, 3243, 19387, 24010, 36199, 37636, 53308, 57014, 71365, 99417, 129555, 135963, 147287, 163362, 163431, 186136, 257912, 262607, 288293, 292038, 316154, 326793, 334531, 350589, 366124, 388202, 395858, 406165, 446876, 492890, 516189, 548996, 579999, 583143, 38392, 49227, 60087, 65404, 74595, 83981, 85031, 105402, 105907, 107626, 170995, 190566, 193282, 203672, 208498, 229073, 242627, 255845, 262476, 277880, 293336, 302214, 331412, 341388, 353948, 365810, 389369, 406958, 409030, 413884, 431754, 485257, 498410, 501080, 521341, 550365, 558452, 20426, 22200, 27367, 37029, 40454, 63151, 106455, 108202, 111139, 113768, 140146, 143970, 178265, 184961, 195154, 243076, 263432, 264309, 264480, 287143, 316601, 361741, 391254, 418509, 430494, 438310, 480000, 503038, 526613, 557397, 50501, 64459, 89706, 95710, 96616, 142373, 144319, 154803, 173047, 190490, 202277, 221336, 232225, 235288, 249044, 297553, 300805, 324077, 332577, 335791, 370906, 377864, 386457, 387221, 398320, 416200, 422956, 459348, 478538, 498451, 537661, 550438, 554002, 554490, 554771, 556798, 575688, 599105, 32366, 70706, 71219, 76311, 112421, 116075, 131509, 143384, 152838, 192925, 213780, 264121, 283201, 283560, 291518, 364659, 368008, 388668, 421965, 465049, 478152, 533947, 547110, 551118, 582622, 583440, 586837, 592564, 2466, 3243, 19387, 24010, 36199, 37636, 53308, 57014, 71365, 99417, 129555, 135963, 147287, 163362, 163431, 186136, 257912, 262607, 288293, 292038, 316154, 326793, 334531, 350589, 366124, 388202, 395858, 406165, 446876, 492890, 516189, 548996, 579999, 583143, 14742, 61763, 65553, 85576, 86798, 93284, 95007, 117348, 152378, 160286, 173732, 194510, 212899, 249089, 273611, 287112, 307664, 353108, 358347, 374845, 385588, 437137, 452887, 465592, 466528, 490961, 531913, 533390, 549480, 571860, 598146, 32366, 70706, 71219, 76311, 112421, 116075, 131509, 143384, 152838, 192925, 213780, 264121, 283201, 283560, 291518, 364659, 368008, 388668, 421965, 465049, 478152, 533947, 547110, 551118, 582622, 583440, 586837, 592564, 13895, 21598, 45593, 50772, 61749, 68479, 77479, 82395, 91283, 115803, 138836, 154102, 160143, 177954, 193038, 216061, 232726, 249080, 309853, 313647, 335929, 350133, 380438, 414961, 439207, 455513, 481601, 573688, 575835, 584483, 594923, 598774, 2466, 3243, 19387, 24010, 36199, 37636, 53308, 57014, 71365, 99417, 129555, 135963, 147287, 163362, 163431, 186136, 257912, 262607, 288293, 292038, 316154, 326793, 334531, 350589, 366124, 388202, 395858, 406165, 446876, 492890, 516189, 548996, 579999, 583143, 48217, 55321, 55711, 71842, 90924, 118704, 145205, 157164, 163107, 181901, 191197, 207641, 211915, 219306, 241348, 245782, 293901, 300437, 344877, 354506, 373062, 382071, 385898, 394077, 394779, 416962, 426011, 461913, 472417, 511315, 511824, 522401, 548449, 554657, 559949, 565156, 572920, 597493, 598756, 21597, 97258, 115391, 118421, 147748, 172467, 234436, 247265, 248106, 249463, 250061, 264231, 272310, 279074, 301610, 324893, 336186, 366619, 390920, 404671, 433854, 517671, 569900, 571739, 581086, 583649, 20426, 22200, 27367, 37029, 40454, 63151, 106455, 108202, 111139, 113768, 140146, 143970, 178265, 184961, 195154, 243076, 263432, 264309, 264480, 287143, 316601, 361741, 391254, 418509, 430494, 438310, 480000, 503038, 526613, 557397, 10186, 14274, 26319, 92089, 94002, 127549, 138959, 168333, 199470, 213523, 242834, 251248, 263800, 271714, 275665, 297463, 307130, 340907, 361663, 395121, 407905, 420145, 426197, 431175, 461235, 479555, 495040, 533428, 535067, 595621, 13587, 35429, 60128, 99119, 99702, 155522, 203765, 205937, 224995, 225684, 233182, 248045, 250461, 252228, 284680, 288067, 310640, 328259, 372806, 422959, 453890, 489232, 492898, 515161, 586679, 450, 15019, 16711, 31630, 95991, 119418, 127176, 152705, 223901, 241168, 246420, 269607, 271927, 287341, 288685, 293490, 318900, 322196, 328898, 333052, 351926, 354315, 367999, 370949, 391284, 410328, 421499, 446723, 522782, 531972, 565741, 576363, 581834, 600341, 32366, 70706, 71219, 76311, 112421, 116075, 131509, 143384, 152838, 192925, 213780, 264121, 283201, 283560, 291518, 364659, 368008, 388668, 421965, 465049, 478152, 533947, 547110, 551118, 582622, 583440, 586837, 592564, 50501, 64459, 89706, 95710, 96616, 142373, 144319, 154803, 173047, 190490, 202277, 221336, 232225, 235288, 249044, 297553, 300805, 324077, 332577, 335791, 370906, 377864, 386457, 387221, 398320, 416200, 422956, 459348, 478538, 498451, 537661, 550438, 554002, 554490, 554771, 556798, 575688, 599105, 16525, 27492, 41044, 130683, 172212, 214132, 242823, 266749, 331535, 334325, 368035, 378912, 400173, 403816, 407267, 440181, 470977, 477856, 505914, 523448, 525989, 527445, 545009, 594123, 597826, 38392, 49227, 60087, 65404, 74595, 83981, 85031, 105402, 105907, 107626, 170995, 190566, 193282, 203672, 208498, 229073, 242627, 255845, 262476, 277880, 293336, 302214, 331412, 341388, 353948, 365810, 389369, 406958, 409030, 413884, 431754, 485257, 498410, 501080, 521341, 550365, 558452, 50501, 64459, 89706, 95710, 96616, 142373, 144319, 154803, 173047, 190490, 202277, 221336, 232225, 235288, 249044, 297553, 300805, 324077, 332577, 335791, 370906, 377864, 386457, 387221, 398320, 416200, 422956, 459348, 478538, 498451, 537661, 550438, 554002, 554490, 554771, 556798, 575688, 599105, 16525, 27492, 41044, 130683, 172212, 214132, 242823, 266749, 331535, 334325, 368035, 378912, 400173, 403816, 407267, 440181, 470977, 477856, 505914, 523448, 525989, 527445, 545009, 594123, 597826, 16952, 47767, 53118, 67353, 98806, 103703, 108717, 161707, 176932, 217552, 224818, 245277, 273920, 302940, 351611, 400994, 410628, 413474, 446001, 476833, 478844, 525397, 532921, 549636, 592117, 13895, 21598, 45593, 50772, 61749, 68479, 77479, 82395, 91283, 115803, 138836, 154102, 160143, 177954, 193038, 216061, 232726, 249080, 309853, 313647, 335929, 350133, 380438, 414961, 439207, 455513, 481601, 573688, 575835, 584483, 594923, 598774, 13587, 35429, 60128, 99119, 99702, 155522, 203765, 205937, 224995, 225684, 233182, 248045, 250461, 252228, 284680, 288067, 310640, 328259, 372806, 422959, 453890, 489232, 492898, 515161, 586679, 50501, 64459, 89706, 95710, 96616, 142373, 144319, 154803, 173047, 190490, 202277, 221336, 232225, 235288, 249044, 297553, 300805, 324077, 332577, 335791, 370906, 377864, 386457, 387221, 398320, 416200, 422956, 459348, 478538, 498451, 537661, 550438, 554002, 554490, 554771, 556798, 575688, 599105, 38392, 49227, 60087, 65404, 74595, 83981, 85031, 105402, 105907, 107626, 170995, 190566, 193282, 203672, 208498, 229073, 242627, 255845, 262476, 277880, 293336, 302214, 331412, 341388, 353948, 365810, 389369, 406958, 409030, 413884, 431754, 485257, 498410, 501080, 521341, 550365, 558452, 38392, 49227, 60087, 65404, 74595, 83981, 85031, 105402, 105907, 107626, 170995, 190566, 193282, 203672, 208498, 229073, 242627, 255845, 262476, 277880, 293336, 302214, 331412, 341388, 353948, 365810, 389369, 406958, 409030, 413884, 431754, 485257, 498410, 501080, 521341, 550365, 558452, 59820, 66044, 74006, 92444, 117820, 126807, 178444, 183303, 208896, 219224, 249101, 259302, 284972, 299149, 334918, 343384, 359681, 384541, 408047, 434480, 444704, 447648, 508673, 516615, 534481, 576858, 589379, 16952, 47767, 53118, 67353, 98806, 103703, 108717, 161707, 176932, 217552, 224818, 245277, 273920, 302940, 351611, 400994, 410628, 413474, 446001, 476833, 478844, 525397, 532921, 549636, 592117, 11748, 12092, 19795, 38870, 42414, 43612, 50843, 51753, 70852, 94736, 104533, 106358, 113114, 171948, 179215, 211699, 269243, 277234, 291790, 313635, 339970, 456962, 473576, 497651, 506065, 509808, 519640, 529679, 537663, 538311, 538710, 562152, 14742, 61763, 65553, 85576, 86798, 93284, 95007, 117348, 152378, 160286, 173732, 194510, 212899, 249089, 273611, 287112, 307664, 353108, 358347, 374845, 385588, 437137, 452887, 465592, 466528, 490961, 531913, 533390, 549480, 571860, 598146, 48217, 55321, 55711, 71842, 90924, 118704, 145205, 157164, 163107, 181901, 191197, 207641, 211915, 219306, 241348, 245782, 293901, 300437, 344877, 354506, 373062, 382071, 385898, 394077, 394779, 416962, 426011, 461913, 472417, 511315, 511824, 522401, 548449, 554657, 559949, 565156, 572920, 597493, 598756, 35585, 40476, 46097, 54410, 97371, 121331, 125104, 206534, 246383, 297762, 303697, 387932, 402072, 422842, 423986, 427301, 439932, 442572, 457795, 468726, 476102, 493346, 520448, 522443, 564178, 572008, 576394, 576801, 2466, 3243, 19387, 24010, 36199, 37636, 53308, 57014, 71365, 99417, 129555, 135963, 147287, 163362, 163431, 186136, 257912, 262607, 288293, 292038, 316154, 326793, 334531, 350589, 366124, 388202, 395858, 406165, 446876, 492890, 516189, 548996, 579999, 583143, 21597, 97258, 115391, 118421, 147748, 172467, 234436, 247265, 248106, 249463, 250061, 264231, 272310, 279074, 301610, 324893, 336186, 366619, 390920, 404671, 433854, 517671, 569900, 571739, 581086, 583649, 59820, 66044, 74006, 92444, 117820, 126807, 178444, 183303, 208896, 219224, 249101, 259302, 284972, 299149, 334918, 343384, 359681, 384541, 408047, 434480, 444704, 447648, 508673, 516615, 534481, 576858, 589379, 32366, 70706, 71219, 76311, 112421, 116075, 131509, 143384, 152838, 192925, 213780, 264121, 283201, 283560, 291518, 364659, 368008, 388668, 421965, 465049, 478152, 533947, 547110, 551118, 582622, 583440, 586837, 592564, 16525, 27492, 41044, 130683, 172212, 214132, 242823, 266749, 331535, 334325, 368035, 378912, 400173, 403816, 407267, 440181, 470977, 477856, 505914, 523448, 525989, 527445, 545009, 594123, 597826, 13895, 21598, 45593, 50772, 61749, 68479, 77479, 82395, 91283, 115803, 138836, 154102, 160143, 177954, 193038, 216061, 232726, 249080, 309853, 313647, 335929, 350133, 380438, 414961, 439207, 455513, 481601, 573688, 575835, 584483, 594923, 598774, 11, 2, 6, 1, 14, 9, 16, 11, 1, 6, 11, 5, 1, 15, 10, 9, 2, 4, 0, 11, 16, 7, 14, 16, 7, 8, 5, 4, 16, 14, 14, 17, 8, 3, 6, 15, 12, 1, 10, 17, 11, 7, 5, 10686, 11255, 2408, 14348, 2424, 11815, 12553, 10686, 14348, 2408, 10686, 4879, 14348, 19780, 18281, 11815, 11255, 7681, 5626, 10686, 12553, 18622, 2424, 12553, 18622, 19284, 4879, 7681, 12553, 2424, 2424, 11199, 19284, 6078, 2408, 19780, 12918, 14348, 18281, 11199, 10686, 18622, 4879]

query I
PRAGMA backward_lineage("SELECT sum(l_extendedprice) / 7.0 AS avg_yearly FROM lineitem, part WHERE p_partkey = l_partkey AND p_brand = 'Brand#23' AND p_container = 'MED BOX' AND l_quantity < (  SELECT 0.2 * avg(l_quantity)  FROM  lineitem   WHERE  l_partkey = p_partkey);", 'COUNT', 0)
----
172

query I
PRAGMA backward_lineage("SELECT sum(l_extendedprice) / 7.0 AS avg_yearly FROM lineitem, part WHERE p_partkey = l_partkey AND p_brand = 'Brand#23' AND p_container = 'MED BOX' AND l_quantity < (  SELECT 0.2 * avg(l_quantity)  FROM  lineitem   WHERE  l_partkey = p_partkey);", 'LIN', '0')
----
172

query I
PRAGMA backward_lineage("SELECT sum(l_extendedprice) / 7.0 AS avg_yearly FROM lineitem, part WHERE p_partkey = l_partkey AND p_brand = 'Brand#23' AND p_container = 'MED BOX' AND l_quantity < (  SELECT 0.2 * avg(l_quantity)  FROM  lineitem   WHERE  l_partkey = p_partkey);", 'PERM', '0')
----
172

query I
PRAGMA backward_lineage("SELECT sum(l_extendedprice) / 7.0 AS avg_yearly FROM lineitem, part WHERE p_partkey = l_partkey AND p_brand = 'Brand#23' AND p_container = 'MED BOX' AND l_quantity < (  SELECT 0.2 * avg(l_quantity)  FROM  lineitem   WHERE  l_partkey = p_partkey);", 'PROV', '0')
----
172
