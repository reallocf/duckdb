# name: test/sql/lineage/inmemory_tpch_queries/test_tpch_08.test
# description: Test TPC-H Query 8 in-memory
# group: [inmemory_tpch_queries]

require tpch

statement ok
CALL dbgen(sf=0.01);

statement ok
PRAGMA trace_lineage = "ON";

statement ok
SELECT o_year, sum(CASE WHEN nation = 'BRAZIL' THEN volume ELSE 0 END) / sum(volume) AS mkt_share FROM (SELECT extract(year FROM o_orderdate) AS o_year, l_extendedprice * (1 - l_discount) AS volume, n2.n_name AS nation FROM part, supplier, lineitem, orders, customer, nation n1, nation n2, region WHERE p_partkey = l_partkey AND s_suppkey = l_suppkey AND l_orderkey = o_orderkey AND o_custkey = c_custkey AND c_nationkey = n1.n_nationkey AND n1.n_regionkey = r_regionkey AND r_name = 'AMERICA' AND s_nationkey = n2.n_nationkey AND o_orderdate BETWEEN CAST('1995-01-01' AS date) AND CAST('1996-12-31' AS date) AND p_type = 'ECONOMY ANODIZED STEEL') AS all_nations GROUP BY o_year ORDER BY o_year

statement ok
PRAGMA trace_lineage = "OFF";

query I
PRAGMA backward_lineage("SELECT o_year, sum(CASE WHEN nation = 'BRAZIL' THEN volume ELSE 0 END) / sum(volume) AS mkt_share FROM (SELECT extract(year FROM o_orderdate) AS o_year, l_extendedprice * (1 - l_discount) AS volume, n2.n_name AS nation FROM part, supplier, lineitem, orders, customer, nation n1, nation n2, region WHERE p_partkey = l_partkey AND s_suppkey = l_suppkey AND l_orderkey = o_orderkey AND o_custkey = c_custkey AND c_nationkey = n1.n_nationkey AND n1.n_regionkey = r_regionkey AND r_name = 'AMERICA' AND s_nationkey = n2.n_nationkey AND o_orderdate BETWEEN CAST('1995-01-01' AS date) AND CAST('1996-12-31' AS date) AND p_type = 'ECONOMY ANODIZED STEEL') AS all_nations GROUP BY o_year ORDER BY o_year", '0')
----
[9950, 2498, 996, 17, 1, 30, 16, 1829, 10071, 2536, 645, 2, 1, 41, 22, 906, 25421, 6316, 39, 3, 1, 54, 24, 953, 31425, 7812, 267, 3, 1, 3, 15, 1002, 31977, 7944, 729, 2, 1, 7, 17, 906, 8773, 2190, 549, 17, 1, 9, 24, 1370, 19103, 4779, 727, 24, 1, 6, 23, 545, 19265, 4815, 225, 3, 1, 42, 12, 1036, 21908, 5454, 384, 3, 1, 85, 19, 1370, 27331, 6792, 475, 2, 1, 50, 9, 1044, 47285, 11780, 1395, 3, 1, 76, 7, 545, 47286, 11780, 1395, 3, 1, 73, 20, 1002, 57206, 14270, 811, 17, 1, 49, 9, 320]

query I
PRAGMA backward_lineage("SELECT o_year, sum(CASE WHEN nation = 'BRAZIL' THEN volume ELSE 0 END) / sum(volume) AS mkt_share FROM (SELECT extract(year FROM o_orderdate) AS o_year, l_extendedprice * (1 - l_discount) AS volume, n2.n_name AS nation FROM part, supplier, lineitem, orders, customer, nation n1, nation n2, region WHERE p_partkey = l_partkey AND s_suppkey = l_suppkey AND l_orderkey = o_orderkey AND o_custkey = c_custkey AND c_nationkey = n1.n_nationkey AND n1.n_regionkey = r_regionkey AND r_name = 'AMERICA' AND s_nationkey = n2.n_nationkey AND o_orderdate BETWEEN CAST('1995-01-01' AS date) AND CAST('1996-12-31' AS date) AND p_type = 'ECONOMY ANODIZED STEEL') AS all_nations GROUP BY o_year ORDER BY o_year", '1')
----
[10630, 2672, 202, 1, 1, 47, 14, 1370, 11202, 2813, 534, 2, 1, 45, 24, 1044, 16304, 4073, 897, 3, 1, 9, 24, 156, 16959, 4242, 1206, 3, 1, 57, 16, 156, 25303, 6286, 1050, 2, 1, 36, 0, 235, 27832, 6910, 1167, 17, 1, 85, 19, 1370, 32422, 8058, 241, 3, 1, 7, 17, 906, 7855, 1971, 1350, 1, 1, 85, 19, 1370, 21030, 5248, 1461, 17, 1, 35, 13, 156, 21284, 5311, 774, 17, 1, 57, 16, 156, 22317, 5558, 549, 17, 1, 21, 4, 320, 30455, 7563, 729, 2, 1, 30, 16, 1829, 36226, 9010, 748, 24, 1, 71, 18, 1370, 41414, 10293, 948, 2, 1, 78, 14, 745, 53194, 13244, 675, 24, 1, 41, 22, 906, 50046, 12466, 433, 3, 1, 15, 22, 1044]
