# name: test/sql/lineage/inmemory_tpch_queries/test_tpch_22.test
# description: Test TPC-H Query 22 in-memory
# group: [inmemory_tpch_queries]

require tpch

statement ok
CALL dbgen(sf=0.01);

statement ok
PRAGMA trace_lineage = "ON";

statement ok
SELECT cntrycode, count(*) AS numcust, sum(c_acctbal) AS totacctbal FROM (SELECT substring(c_phone FROM 1 FOR 2) AS cntrycode, c_acctbal FROM customer WHERE substring(c_phone FROM 1 FOR 2) IN ('13', '31', '23', '29', '30', '18', '17') AND c_acctbal > ( SELECT avg(c_acctbal) FROM customer WHERE c_acctbal > 0.00 AND substring(c_phone FROM 1 FOR 2) IN ('13', '31', '23', '29', '30', '18', '17')) AND NOT EXISTS (SELECT * FROM orders WHERE o_custkey = c_custkey)) AS custsale GROUP BY cntrycode ORDER BY cntrycode

statement ok
PRAGMA trace_lineage = "OFF";

# Not sure about this one... getting different answers than the prior approach

query I
PRAGMA backward_lineage("SELECT cntrycode, count(*) AS numcust, sum(c_acctbal) AS totacctbal FROM (SELECT substring(c_phone FROM 1 FOR 2) AS cntrycode, c_acctbal FROM customer WHERE substring(c_phone FROM 1 FOR 2) IN ('13', '31', '23', '29', '30', '18', '17') AND c_acctbal > ( SELECT avg(c_acctbal) FROM customer WHERE c_acctbal > 0.00 AND substring(c_phone FROM 1 FOR 2) IN ('13', '31', '23', '29', '30', '18', '17')) AND NOT EXISTS (SELECT * FROM orders WHERE o_custkey = c_custkey)) AS custsale GROUP BY cntrycode ORDER BY cntrycode", 'VALUE', '0')
----
[1, 4, 5, 8, 11, 12, 20, 21, 22, 23, 26, 27, 35, 39, 42, 56, 57, 61, 62, 80, 90, 92, 95, 99, 101, 111, 114, 118, 121, 126, 128, 134, 144, 145, 148, 150, 151, 153, 159, 160, 161, 162, 170, 177, 181, 183, 185, 201, 207, 209, 210, 211, 213, 222, 224, 225, 226, 227, 229, 232, 234, 241, 242, 246, 250, 254, 267, 269, 273, 277, 282, 284, 290, 297, 299, 300, 302, 306, 308, 313, 314, 315, 316, 320, 321, 326, 329, 334, 342, 347, 350, 360, 366, 368, 372, 378, 379, 381, 384, 387, 392, 396, 398, 400, 409, 413, 419, 420, 422, 423, 425, 427, 429, 432, 433, 435, 439, 442, 444, 446, 450, 452, 453, 456, 460, 461, 469, 473, 479, 480, 481, 483, 484, 485, 491, 494, 497, 500, 502, 505, 510, 519, 524, 526, 529, 530, 545, 558, 559, 566, 567, 573, 581, 582, 588, 589, 590, 594, 601, 602, 603, 608, 610, 619, 621, 624, 630, 633, 635, 636, 647, 656, 670, 674, 676, 680, 686, 687, 689, 691, 694, 701, 705, 706, 714, 717, 720, 721, 722, 725, 728, 730, 732, 742, 743, 745, 746, 749, 751, 756, 760, 764, 769, 771, 772, 776, 779, 785, 790, 791, 795, 807, 821, 825, 828, 830, 834, 844, 862, 865, 875, 882, 883, 888, 892, 897, 902, 910, 920, 921, 927, 929, 931, 938, 939, 940, 945, 953, 955, 956, 962, 965, 968, 973, 975, 982, 986, 987, 990, 992, 1000, 1002, 1003, 1004, 1018, 1019, 1021, 1024, 1029, 1030, 1032, 1035, 1042, 1044, 1047, 1051, 1053, 1054, 1057, 1059, 1062, 1068, 1074, 1076, 1077, 1078, 1082, 1084, 1085, 1086, 1103, 1105, 1107, 1111, 1118, 1120, 1124, 1125, 1128, 1130, 1139, 1147, 1148, 1150, 1152, 1153, 1154, 1156, 1160, 1166, 1169, 1170, 1178, 1179, 1190, 1191, 1193, 1195, 1203, 1204, 1205, 1212, 1215, 1223, 1236, 1238, 1240, 1247, 1248, 1258, 1260, 1261, 1265, 1269, 1271, 1274, 1284, 1287, 1290, 1291, 1296, 1306, 1310, 1311, 1321, 1323, 1324, 1330, 1337, 1339, 1349, 1351, 1354, 1357, 1359, 1360, 1361, 1365, 1370, 1372, 1383, 1384, 1386, 1387, 1388, 1393, 1395, 1396, 1397, 1410, 1413, 1414, 1415, 1422, 1428, 1430, 1431, 1438, 1439, 1444, 1449, 1451, 1454, 1455, 1457, 1459, 1460, 1462, 1464, 1468, 1477, 1479, 1481, 1482, 1489, 1497, 1498, 26, 725, 1019, 446, 185, 302, 1148, 1454, 1124, 1460]

query I
PRAGMA backward_lineage("SELECT cntrycode, count(*) AS numcust, sum(c_acctbal) AS totacctbal FROM (SELECT substring(c_phone FROM 1 FOR 2) AS cntrycode, c_acctbal FROM customer WHERE substring(c_phone FROM 1 FOR 2) IN ('13', '31', '23', '29', '30', '18', '17') AND c_acctbal > ( SELECT avg(c_acctbal) FROM customer WHERE c_acctbal > 0.00 AND substring(c_phone FROM 1 FOR 2) IN ('13', '31', '23', '29', '30', '18', '17')) AND NOT EXISTS (SELECT * FROM orders WHERE o_custkey = c_custkey)) AS custsale GROUP BY cntrycode ORDER BY cntrycode", 'VALUE', '4')
----
[1, 4, 5, 8, 11, 12, 20, 21, 22, 23, 26, 27, 35, 39, 42, 56, 57, 61, 62, 80, 90, 92, 95, 99, 101, 111, 114, 118, 121, 126, 128, 134, 144, 145, 148, 150, 151, 153, 159, 160, 161, 162, 170, 177, 181, 183, 185, 201, 207, 209, 210, 211, 213, 222, 224, 225, 226, 227, 229, 232, 234, 241, 242, 246, 250, 254, 267, 269, 273, 277, 282, 284, 290, 297, 299, 300, 302, 306, 308, 313, 314, 315, 316, 320, 321, 326, 329, 334, 342, 347, 350, 360, 366, 368, 372, 378, 379, 381, 384, 387, 392, 396, 398, 400, 409, 413, 419, 420, 422, 423, 425, 427, 429, 432, 433, 435, 439, 442, 444, 446, 450, 452, 453, 456, 460, 461, 469, 473, 479, 480, 481, 483, 484, 485, 491, 494, 497, 500, 502, 505, 510, 519, 524, 526, 529, 530, 545, 558, 559, 566, 567, 573, 581, 582, 588, 589, 590, 594, 601, 602, 603, 608, 610, 619, 621, 624, 630, 633, 635, 636, 647, 656, 670, 674, 676, 680, 686, 687, 689, 691, 694, 701, 705, 706, 714, 717, 720, 721, 722, 725, 728, 730, 732, 742, 743, 745, 746, 749, 751, 756, 760, 764, 769, 771, 772, 776, 779, 785, 790, 791, 795, 807, 821, 825, 828, 830, 834, 844, 862, 865, 875, 882, 883, 888, 892, 897, 902, 910, 920, 921, 927, 929, 931, 938, 939, 940, 945, 953, 955, 956, 962, 965, 968, 973, 975, 982, 986, 987, 990, 992, 1000, 1002, 1003, 1004, 1018, 1019, 1021, 1024, 1029, 1030, 1032, 1035, 1042, 1044, 1047, 1051, 1053, 1054, 1057, 1059, 1062, 1068, 1074, 1076, 1077, 1078, 1082, 1084, 1085, 1086, 1103, 1105, 1107, 1111, 1118, 1120, 1124, 1125, 1128, 1130, 1139, 1147, 1148, 1150, 1152, 1153, 1154, 1156, 1160, 1166, 1169, 1170, 1178, 1179, 1190, 1191, 1193, 1195, 1203, 1204, 1205, 1212, 1215, 1223, 1236, 1238, 1240, 1247, 1248, 1258, 1260, 1261, 1265, 1269, 1271, 1274, 1284, 1287, 1290, 1291, 1296, 1306, 1310, 1311, 1321, 1323, 1324, 1330, 1337, 1339, 1349, 1351, 1354, 1357, 1359, 1360, 1361, 1365, 1370, 1372, 1383, 1384, 1386, 1387, 1388, 1393, 1395, 1396, 1397, 1410, 1413, 1414, 1415, 1422, 1428, 1430, 1431, 1438, 1439, 1444, 1449, 1451, 1454, 1455, 1457, 1459, 1460, 1462, 1464, 1468, 1477, 1479, 1481, 1482, 1489, 1497, 1498, 530, 953, 425, 938, 602, 101, 656, 134, 956, 1190, 1166]

query I
PRAGMA backward_lineage("SELECT cntrycode, count(*) AS numcust, sum(c_acctbal) AS totacctbal FROM (SELECT substring(c_phone FROM 1 FOR 2) AS cntrycode, c_acctbal FROM customer WHERE substring(c_phone FROM 1 FOR 2) IN ('13', '31', '23', '29', '30', '18', '17') AND c_acctbal > ( SELECT avg(c_acctbal) FROM customer WHERE c_acctbal > 0.00 AND substring(c_phone FROM 1 FOR 2) IN ('13', '31', '23', '29', '30', '18', '17')) AND NOT EXISTS (SELECT * FROM orders WHERE o_custkey = c_custkey)) AS custsale GROUP BY cntrycode ORDER BY cntrycode", 'COUNT', '0')
----
397

query I
PRAGMA backward_lineage("SELECT cntrycode, count(*) AS numcust, sum(c_acctbal) AS totacctbal FROM (SELECT substring(c_phone FROM 1 FOR 2) AS cntrycode, c_acctbal FROM customer WHERE substring(c_phone FROM 1 FOR 2) IN ('13', '31', '23', '29', '30', '18', '17') AND c_acctbal > ( SELECT avg(c_acctbal) FROM customer WHERE c_acctbal > 0.00 AND substring(c_phone FROM 1 FOR 2) IN ('13', '31', '23', '29', '30', '18', '17')) AND NOT EXISTS (SELECT * FROM orders WHERE o_custkey = c_custkey)) AS custsale GROUP BY cntrycode ORDER BY cntrycode", 'LIN', '0')
----
397

query I
PRAGMA backward_lineage("SELECT cntrycode, count(*) AS numcust, sum(c_acctbal) AS totacctbal FROM (SELECT substring(c_phone FROM 1 FOR 2) AS cntrycode, c_acctbal FROM customer WHERE substring(c_phone FROM 1 FOR 2) IN ('13', '31', '23', '29', '30', '18', '17') AND c_acctbal > ( SELECT avg(c_acctbal) FROM customer WHERE c_acctbal > 0.00 AND substring(c_phone FROM 1 FOR 2) IN ('13', '31', '23', '29', '30', '18', '17')) AND NOT EXISTS (SELECT * FROM orders WHERE o_custkey = c_custkey)) AS custsale GROUP BY cntrycode ORDER BY cntrycode", 'PERM', '0')
----
397

query I
PRAGMA backward_lineage("SELECT cntrycode, count(*) AS numcust, sum(c_acctbal) AS totacctbal FROM (SELECT substring(c_phone FROM 1 FOR 2) AS cntrycode, c_acctbal FROM customer WHERE substring(c_phone FROM 1 FOR 2) IN ('13', '31', '23', '29', '30', '18', '17') AND c_acctbal > ( SELECT avg(c_acctbal) FROM customer WHERE c_acctbal > 0.00 AND substring(c_phone FROM 1 FOR 2) IN ('13', '31', '23', '29', '30', '18', '17')) AND NOT EXISTS (SELECT * FROM orders WHERE o_custkey = c_custkey)) AS custsale GROUP BY cntrycode ORDER BY cntrycode", 'PROV', '0')
----
397

query I
PRAGMA backward_lineage("SELECT cntrycode, count(*) AS numcust, sum(c_acctbal) AS totacctbal FROM (SELECT substring(c_phone FROM 1 FOR 2) AS cntrycode, c_acctbal FROM customer WHERE substring(c_phone FROM 1 FOR 2) IN ('13', '31', '23', '29', '30', '18', '17') AND c_acctbal > ( SELECT avg(c_acctbal) FROM customer WHERE c_acctbal > 0.00 AND substring(c_phone FROM 1 FOR 2) IN ('13', '31', '23', '29', '30', '18', '17')) AND NOT EXISTS (SELECT * FROM orders WHERE o_custkey = c_custkey)) AS custsale GROUP BY cntrycode ORDER BY cntrycode", 'COUNT', '4')
----
398
