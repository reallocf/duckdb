# name: test/sql/lineage/inmemory_tpch_queries/test_tpch_04.test
# description: Test TPC-H Query 4 in-memory
# group: [inmemory_tpch_queries]

require tpch

statement ok
CALL dbgen(sf=0.01);

statement ok
PRAGMA trace_lineage = "ON";

statement ok
SELECT o_orderpriority, count(*) AS order_count FROM orders WHERE o_orderdate >= CAST('1993-07-01' AS date) AND o_orderdate < CAST('1993-10-01' AS date) AND EXISTS ( SELECT * FROM lineitem WHERE l_orderkey = o_orderkey AND l_commitdate < l_receiptdate) GROUP BY o_orderpriority ORDER BY o_orderpriority

statement ok
PRAGMA trace_lineage = "OFF";

query I
PRAGMA backward_lineage("SELECT o_orderpriority, count(*) AS order_count FROM orders WHERE o_orderdate >= CAST('1993-07-01' AS date) AND o_orderdate < CAST('1993-10-01' AS date) AND EXISTS ( SELECT * FROM lineitem WHERE l_orderkey = o_orderkey AND l_commitdate < l_receiptdate) GROUP BY o_orderpriority ORDER BY o_orderpriority", 'VALUE', '0')
----
[48, 193, 341, 1346, 518, 2070, 591, 2358, 779, 3144, 862, 3473, 870, 3512, 1235, 4973, 1268, 5105, 1542, 6196, 2056, 8216, 2148, 8601, 2226, 8909, 2451, 9758, 2452, 9765, 2642, 10522, 2690, 10707, 2947, 11737, 3122, 12480, 3124, 12492, 3181, 12705, 3221, 12877, 3232, 12931, 3652, 14675, 3822, 15319, 3830, 15352, 4128, 16505, 4335, 17317, 4440, 17727, 4491, 17936, 4530, 18093, 4588, 18334, 4653, 18588, 4929, 19735, 5084, 20387, 5286, 21174, 5516, 22153, 5532, 22214, 5621, 22597, 5721, 23029, 5840, 23523, 5934, 23901, 5977, 24061, 6317, 25431, 6323, 25459, 6588, 26497, 6695, 26949, 6731, 27089, 6935, 27917, 6988, 28146, 7441, 29981, 7903, 31798, 8144, 32790, 8209, 33048, 8638, 34728, 8708, 35028, 8746, 35170, 8831, 35511, 8944, 35934, 9479, 38143, 9621, 38696, 9811, 39491, 9813, 39503, 9833, 39593, 9874, 39765, 10392, 41822, 10689, 43005, 10769, 43339, 10788, 43408, 10993, 44161, 11314, 45449, 11393, 45769, 11492, 46153, 11673, 46864, 11719, 47052, 11821, 47471, 11895, 47781, 11998, 48212, 12154, 48828, 12462, 50035, 12567, 50485, 12957, 51982, 13264, 53275, 13348, 53602, 13672, 54856, 13787, 55319, 13941, 55913, 14045, 56318, 14414, 57757, 14420, 57784, 14560, 58374, 14751, 59157, 14894, 59741]

query I
PRAGMA backward_lineage("SELECT o_orderpriority, count(*) AS order_count FROM orders WHERE o_orderdate >= CAST('1993-07-01' AS date) AND o_orderdate < CAST('1993-10-01' AS date) AND EXISTS ( SELECT * FROM lineitem WHERE l_orderkey = o_orderkey AND l_commitdate < l_receiptdate) GROUP BY o_orderpriority ORDER BY o_orderpriority", 'VALUE', '4')
----
[103, 411, 160, 629, 254, 1003, 349, 1376, 380, 1497, 401, 1584, 403, 1591, 662, 2669, 780, 3150, 1040, 4207, 1364, 5493, 1445, 5801, 1688, 6811, 1799, 7226, 1991, 7935, 1999, 7962, 2103, 8409, 2496, 9946, 2577, 10255, 2597, 10330, 2874, 11447, 2921, 11635, 2978, 11858, 3133, 12526, 3153, 12589, 3632, 14594, 3741, 15012, 3870, 15492, 3977, 15903, 3992, 15973, 4159, 16644, 4312, 17234, 4353, 17388, 4370, 17443, 4389, 17515, 4499, 17972, 4560, 18227, 4569, 18255, 5056, 20289, 5132, 20577, 5289, 21191, 5312, 21290, 5317, 21307, 5569, 22368, 5578, 22407, 5667, 22796, 5760, 23179, 5791, 23308, 5894, 23747, 5961, 24007, 5969, 24030, 6006, 24178, 6020, 24246, 6571, 26427, 6936, 27923, 6971, 28077, 7019, 28302, 7192, 28975, 7235, 29158, 7477, 30117, 7529, 30320, 7631, 30716, 7714, 31061, 7723, 31102, 7738, 31159, 7803, 31389, 7814, 31439, 7878, 31692, 7967, 32066, 8001, 32190, 8365, 33676, 8376, 33723, 8510, 34236, 8563, 34456, 8585, 34528, 8606, 34609, 8633, 34705, 8641, 34738, 8915, 35832, 8952, 35963, 9004, 36205, 9026, 36293, 9168, 36875, 9504, 38243, 9688, 38974, 9787, 39383, 9978, 40185, 10208, 41096, 10487, 42203, 10644, 42838, 10673, 42942, 10738, 43200, 11016, 44239, 11236, 45137, 11273, 45279, 11382, 45719, 11439, 45961, 11441, 45965, 11470, 46080, 11522, 46276, 11558, 46404, 11651, 46770, 11891, 47759, 11922, 47875, 11927, 47903, 12290, 49342, 12367, 49660, 12553, 50428, 12621, 50694, 12777, 51280, 12918, 51838, 12947, 51937, 12951, 51955, 13085, 52511, 13215, 53061, 13229, 53123, 13236, 53160, 13253, 53226, 13809, 55399, 14111, 56577, 14169, 56794, 14359, 57537, 14700, 58949, 14769, 59236, 14812, 59402, 14883, 59684, 14941, 59939, 14950, 59982]

query I
PRAGMA backward_lineage("SELECT o_orderpriority, count(*) AS order_count FROM orders WHERE o_orderdate >= CAST('1993-07-01' AS date) AND o_orderdate < CAST('1993-10-01' AS date) AND EXISTS ( SELECT * FROM lineitem WHERE l_orderkey = o_orderkey AND l_commitdate < l_receiptdate) GROUP BY o_orderpriority ORDER BY o_orderpriority", 'COUNT', '0')
----
186

query I
PRAGMA backward_lineage("SELECT o_orderpriority, count(*) AS order_count FROM orders WHERE o_orderdate >= CAST('1993-07-01' AS date) AND o_orderdate < CAST('1993-10-01' AS date) AND EXISTS ( SELECT * FROM lineitem WHERE l_orderkey = o_orderkey AND l_commitdate < l_receiptdate) GROUP BY o_orderpriority ORDER BY o_orderpriority", 'COUNT', '4')
----
256
