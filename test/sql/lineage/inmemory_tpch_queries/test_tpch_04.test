# name: test/sql/lineage/inmemory_tpch_queries/test_tpch_04.test
# description: Test TPC-H Query 4 in-memory
# group: [inmemory_tpch_queries]

require tpch

statement ok
CALL dbgen(sf=0.01);

statement ok
PRAGMA trace_lineage = "ON";

statement ok
SELECT o_orderpriority, count(*) AS order_count FROM orders WHERE o_orderdate >= CAST('1993-07-01' AS date) AND o_orderdate < CAST('1993-10-01' AS date) AND EXISTS ( SELECT * FROM lineitem WHERE l_orderkey = o_orderkey AND l_commitdate < l_receiptdate) GROUP BY o_orderpriority ORDER BY o_orderpriority

statement ok
PRAGMA trace_lineage = "OFF";

query I
PRAGMA backward_lineage("SELECT o_orderpriority, count(*) AS order_count FROM orders WHERE o_orderdate >= CAST('1993-07-01' AS date) AND o_orderdate < CAST('1993-10-01' AS date) AND EXISTS ( SELECT * FROM lineitem WHERE l_orderkey = o_orderkey AND l_commitdate < l_receiptdate) GROUP BY o_orderpriority ORDER BY o_orderpriority", 'VALUE', '0')
----
[193, 1346, 2070, 2358, 3144, 3473, 3512, 4973, 5105, 6196, 8216, 8601, 8909, 9758, 9765, 10522, 10707, 11737, 12480, 12492, 12705, 12877, 12931, 14675, 15319, 15352, 16505, 17317, 17727, 17936, 18093, 18334, 18588, 19735, 20387, 21174, 22153, 22214, 22597, 23029, 23523, 23901, 24061, 25431, 25459, 26497, 26949, 27089, 27917, 28146, 29981, 31798, 32790, 33048, 34728, 35028, 35170, 35511, 35934, 38143, 38696, 39491, 39503, 39593, 39765, 41822, 43005, 43339, 43408, 44161, 45449, 45769, 46153, 46864, 47052, 47471, 47781, 48212, 48828, 50035, 50485, 51982, 53275, 53602, 54856, 55319, 55913, 56318, 57757, 57784, 58374, 59157, 59741, 48, 341, 518, 591, 779, 862, 870, 1235, 1268, 1542, 2056, 2148, 2226, 2451, 2452, 2642, 2690, 2947, 3122, 3124, 3181, 3221, 3232, 3652, 3822, 3830, 4128, 4335, 4440, 4491, 4530, 4588, 4653, 4929, 5084, 5286, 5516, 5532, 5621, 5721, 5840, 5934, 5977, 6317, 6323, 6588, 6695, 6731, 6935, 6988, 7441, 7903, 8144, 8209, 8638, 8708, 8746, 8831, 8944, 9479, 9621, 9811, 9813, 9833, 9874, 10392, 10689, 10769, 10788, 10993, 11314, 11393, 11492, 11673, 11719, 11821, 11895, 11998, 12154, 12462, 12567, 12957, 13264, 13348, 13672, 13787, 13941, 14045, 14414, 14420, 14560, 14751, 14894]

query I
PRAGMA backward_lineage("SELECT o_orderpriority, count(*) AS order_count FROM orders WHERE o_orderdate >= CAST('1993-07-01' AS date) AND o_orderdate < CAST('1993-10-01' AS date) AND EXISTS ( SELECT * FROM lineitem WHERE l_orderkey = o_orderkey AND l_commitdate < l_receiptdate) GROUP BY o_orderpriority ORDER BY o_orderpriority", 'VALUE', '4')
----
[411, 629, 1003, 1376, 1497, 1584, 1591, 2669, 3150, 4207, 5493, 5801, 6811, 7226, 7935, 7962, 8409, 9946, 10255, 10330, 11447, 11635, 11858, 12526, 12589, 14594, 15012, 15492, 15903, 15973, 16644, 17234, 17388, 17443, 17515, 17972, 18227, 18255, 20289, 20577, 21191, 21290, 21307, 22368, 22407, 22796, 23179, 23308, 23747, 24007, 24030, 24178, 24246, 26427, 27923, 28077, 28302, 28975, 29158, 30117, 30320, 30716, 31061, 31102, 31159, 31389, 31439, 31692, 32066, 32190, 33676, 33723, 34236, 34456, 34528, 34609, 34705, 34738, 35832, 35963, 36205, 36293, 36875, 38243, 38974, 39383, 40185, 41096, 42203, 42838, 42942, 43200, 44239, 45137, 45279, 45719, 45961, 45965, 46080, 46276, 46404, 46770, 47759, 47875, 47903, 49342, 49660, 50428, 50694, 51280, 51838, 51937, 51955, 52511, 53061, 53123, 53160, 53226, 55399, 56577, 56794, 57537, 58949, 59236, 59402, 59684, 59939, 59982, 103, 160, 254, 349, 380, 401, 403, 662, 780, 1040, 1364, 1445, 1688, 1799, 1991, 1999, 2103, 2496, 2577, 2597, 2874, 2921, 2978, 3133, 3153, 3632, 3741, 3870, 3977, 3992, 4159, 4312, 4353, 4370, 4389, 4499, 4560, 4569, 5056, 5132, 5289, 5312, 5317, 5569, 5578, 5667, 5760, 5791, 5894, 5961, 5969, 6006, 6020, 6571, 6936, 6971, 7019, 7192, 7235, 7477, 7529, 7631, 7714, 7723, 7738, 7803, 7814, 7878, 7967, 8001, 8365, 8376, 8510, 8563, 8585, 8606, 8633, 8641, 8915, 8952, 9004, 9026, 9168, 9504, 9688, 9787, 9978, 10208, 10487, 10644, 10673, 10738, 11016, 11236, 11273, 11382, 11439, 11441, 11470, 11522, 11558, 11651, 11891, 11922, 11927, 12290, 12367, 12553, 12621, 12777, 12918, 12947, 12951, 13085, 13215, 13229, 13236, 13253, 13809, 14111, 14169, 14359, 14700, 14769, 14812, 14883, 14941, 14950]

query I
PRAGMA backward_lineage("SELECT o_orderpriority, count(*) AS order_count FROM orders WHERE o_orderdate >= CAST('1993-07-01' AS date) AND o_orderdate < CAST('1993-10-01' AS date) AND EXISTS ( SELECT * FROM lineitem WHERE l_orderkey = o_orderkey AND l_commitdate < l_receiptdate) GROUP BY o_orderpriority ORDER BY o_orderpriority", 'COUNT', '0')
----
186

query I
PRAGMA backward_lineage("SELECT o_orderpriority, count(*) AS order_count FROM orders WHERE o_orderdate >= CAST('1993-07-01' AS date) AND o_orderdate < CAST('1993-10-01' AS date) AND EXISTS ( SELECT * FROM lineitem WHERE l_orderkey = o_orderkey AND l_commitdate < l_receiptdate) GROUP BY o_orderpriority ORDER BY o_orderpriority", 'COUNT', '4')
----
256
