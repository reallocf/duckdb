# name: test/sql/lineage/inmemory_tpch_queries/test_tpch_21.test
# description: Test TPC-H Query 21 in-memory
# group: [inmemory_tpch_queries]

require tpch

statement ok
CALL dbgen(sf=0.1);

statement ok
PRAGMA trace_lineage = "ON";

statement ok
SELECT s_name,count(*) AS numwait FROM supplier,lineitem l1,orders, nation WHERE s_suppkey = l1.l_suppkey AND o_orderkey = l1.l_orderkey AND o_orderstatus = 'F' AND l1.l_receiptdate > l1.l_commitdate AND EXISTS ( SELECT  * FROM   lineitem l2   WHERE  l2.l_orderkey = l1.l_orderkey  AND l2.l_suppkey <> l1.l_suppkey) AND NOT EXISTS (  SELECT  * FROM  lineitem l3 WHERE l3.l_orderkey = l1.l_orderkey AND l3.l_suppkey <> l1.l_suppkey AND l3.l_receiptdate > l3.l_commitdate) AND s_nationkey = n_nationkey AND n_name = 'SAUDI ARABIA' GROUP BY s_name ORDER BY numwait DESC, s_name LIMIT 100;


statement ok
PRAGMA trace_lineage = "OFF";

query I
PRAGMA backward_lineage("SELECT s_name,count(*) AS numwait FROM supplier,lineitem l1,orders, nation WHERE s_suppkey = l1.l_suppkey AND o_orderkey = l1.l_orderkey AND o_orderstatus = 'F' AND l1.l_receiptdate > l1.l_commitdate AND EXISTS ( SELECT  * FROM   lineitem l2   WHERE  l2.l_orderkey = l1.l_orderkey  AND l2.l_suppkey <> l1.l_suppkey) AND NOT EXISTS (  SELECT  * FROM  lineitem l3 WHERE l3.l_orderkey = l1.l_orderkey AND l3.l_suppkey <> l1.l_suppkey AND l3.l_receiptdate > l3.l_commitdate) AND s_nationkey = n_nationkey AND n_name = 'SAUDI ARABIA' GROUP BY s_name ORDER BY numwait DESC, s_name LIMIT 100;", 'VALUE', '0')
----
[25531, 6341, 659, 20, 329, 25529, 25006, 6215, 820, 20, 333, 25003, 1068, 271, 444, 20, 10, 1067, 10640, 2675, 444, 20, 129, 10639, 30074, 7468, 444, 20, 376, 30072, 31940, 7936, 444, 20, 394, 31941, 13847, 3449, 708, 20, 186, 13846, 59299, 14786, 659, 20, 706, 59297, 3720, 917, 668, 20, 43, 3718, 55224, 13765, 261, 20, 671, 55223, 41432, 10296, 708, 20, 496, 41426, 61824, 15416, 379, 20, 734, 61825, 35796, 8908, 632, 20, 438, 35795, 34809, 8657, 686, 20, 423, 34808, 55471, 13827, 976, 20, 675, 55470, 616, 157, 495, 20, 996, 71212]

query I
PRAGMA backward_lineage("SELECT s_name,count(*) AS numwait FROM supplier,lineitem l1,orders, nation WHERE s_suppkey = l1.l_suppkey AND o_orderkey = l1.l_orderkey AND o_orderstatus = 'F' AND l1.l_receiptdate > l1.l_commitdate AND EXISTS ( SELECT  * FROM   lineitem l2   WHERE  l2.l_orderkey = l1.l_orderkey  AND l2.l_suppkey <> l1.l_suppkey) AND NOT EXISTS (  SELECT  * FROM  lineitem l3 WHERE l3.l_orderkey = l1.l_orderkey AND l3.l_suppkey <> l1.l_suppkey AND l3.l_receiptdate > l3.l_commitdate) AND s_nationkey = n_nationkey AND n_name = 'SAUDI ARABIA' GROUP BY s_name ORDER BY numwait DESC, s_name LIMIT 100;", 'COUNT', '0')
----
96
