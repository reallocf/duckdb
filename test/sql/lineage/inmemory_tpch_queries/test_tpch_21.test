# name: test/sql/lineage/inmemory_tpch_queries/test_tpch_21.test
# description: Test TPC-H Query 21 in-memory
# group: [inmemory_tpch_queries]

require tpch

statement ok
CALL dbgen(sf=0.1);

statement ok
PRAGMA trace_lineage = "ON";

statement ok
SELECT s_name,count(*) AS numwait FROM supplier,lineitem l1,orders, nation WHERE s_suppkey = l1.l_suppkey AND o_orderkey = l1.l_orderkey AND o_orderstatus = 'F' AND l1.l_receiptdate > l1.l_commitdate AND EXISTS ( SELECT  * FROM   lineitem l2   WHERE  l2.l_orderkey = l1.l_orderkey  AND l2.l_suppkey <> l1.l_suppkey) AND NOT EXISTS (  SELECT  * FROM  lineitem l3 WHERE l3.l_orderkey = l1.l_orderkey AND l3.l_suppkey <> l1.l_suppkey AND l3.l_receiptdate > l3.l_commitdate) AND s_nationkey = n_nationkey AND n_name = 'SAUDI ARABIA' GROUP BY s_name ORDER BY numwait DESC, s_name LIMIT 100;


statement ok
PRAGMA trace_lineage = "OFF";

query I
PRAGMA backward_lineage("SELECT s_name,count(*) AS numwait FROM supplier,lineitem l1,orders, nation WHERE s_suppkey = l1.l_suppkey AND o_orderkey = l1.l_orderkey AND o_orderstatus = 'F' AND l1.l_receiptdate > l1.l_commitdate AND EXISTS ( SELECT  * FROM   lineitem l2   WHERE  l2.l_orderkey = l1.l_orderkey  AND l2.l_suppkey <> l1.l_suppkey) AND NOT EXISTS (  SELECT  * FROM  lineitem l3 WHERE l3.l_orderkey = l1.l_orderkey AND l3.l_suppkey <> l1.l_suppkey AND l3.l_receiptdate > l3.l_commitdate) AND s_nationkey = n_nationkey AND n_name = 'SAUDI ARABIA' GROUP BY s_name ORDER BY numwait DESC, s_name LIMIT 100;", 'VALUE', '0')
----
[25531, 25006, 1068, 10640, 30074, 31940, 13847, 59299, 3720, 55224, 41432, 61824, 35796, 34809, 55471, 616, 6341, 6215, 271, 2675, 7468, 7936, 3449, 14786, 917, 13765, 10296, 15416, 8908, 8657, 13827, 157, 659, 820, 444, 444, 444, 444, 708, 659, 668, 261, 708, 379, 632, 686, 976, 495, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 329, 333, 10, 129, 376, 394, 186, 706, 43, 671, 496, 734, 438, 423, 675, 996, 25529, 25003, 1067, 10639, 30072, 31941, 13846, 59297, 3718, 55223, 41426, 61825, 35795, 34808, 55470, 71212]

query I
PRAGMA backward_lineage("SELECT s_name,count(*) AS numwait FROM supplier,lineitem l1,orders, nation WHERE s_suppkey = l1.l_suppkey AND o_orderkey = l1.l_orderkey AND o_orderstatus = 'F' AND l1.l_receiptdate > l1.l_commitdate AND EXISTS ( SELECT  * FROM   lineitem l2   WHERE  l2.l_orderkey = l1.l_orderkey  AND l2.l_suppkey <> l1.l_suppkey) AND NOT EXISTS (  SELECT  * FROM  lineitem l3 WHERE l3.l_orderkey = l1.l_orderkey AND l3.l_suppkey <> l1.l_suppkey AND l3.l_receiptdate > l3.l_commitdate) AND s_nationkey = n_nationkey AND n_name = 'SAUDI ARABIA' GROUP BY s_name ORDER BY numwait DESC, s_name LIMIT 100;", 'COUNT', '0')
----
96

query I
PRAGMA backward_lineage("SELECT s_name,count(*) AS numwait FROM supplier,lineitem l1,orders, nation WHERE s_suppkey = l1.l_suppkey AND o_orderkey = l1.l_orderkey AND o_orderstatus = 'F' AND l1.l_receiptdate > l1.l_commitdate AND EXISTS ( SELECT  * FROM   lineitem l2   WHERE  l2.l_orderkey = l1.l_orderkey  AND l2.l_suppkey <> l1.l_suppkey) AND NOT EXISTS (  SELECT  * FROM  lineitem l3 WHERE l3.l_orderkey = l1.l_orderkey AND l3.l_suppkey <> l1.l_suppkey AND l3.l_receiptdate > l3.l_commitdate) AND s_nationkey = n_nationkey AND n_name = 'SAUDI ARABIA' GROUP BY s_name ORDER BY numwait DESC, s_name LIMIT 100;", 'LIN', '0')
----
96

query I
PRAGMA backward_lineage("SELECT s_name,count(*) AS numwait FROM supplier,lineitem l1,orders, nation WHERE s_suppkey = l1.l_suppkey AND o_orderkey = l1.l_orderkey AND o_orderstatus = 'F' AND l1.l_receiptdate > l1.l_commitdate AND EXISTS ( SELECT  * FROM   lineitem l2   WHERE  l2.l_orderkey = l1.l_orderkey  AND l2.l_suppkey <> l1.l_suppkey) AND NOT EXISTS (  SELECT  * FROM  lineitem l3 WHERE l3.l_orderkey = l1.l_orderkey AND l3.l_suppkey <> l1.l_suppkey AND l3.l_receiptdate > l3.l_commitdate) AND s_nationkey = n_nationkey AND n_name = 'SAUDI ARABIA' GROUP BY s_name ORDER BY numwait DESC, s_name LIMIT 100;", 'PERM', '0')
----
96

query I
PRAGMA backward_lineage("SELECT s_name,count(*) AS numwait FROM supplier,lineitem l1,orders, nation WHERE s_suppkey = l1.l_suppkey AND o_orderkey = l1.l_orderkey AND o_orderstatus = 'F' AND l1.l_receiptdate > l1.l_commitdate AND EXISTS ( SELECT  * FROM   lineitem l2   WHERE  l2.l_orderkey = l1.l_orderkey  AND l2.l_suppkey <> l1.l_suppkey) AND NOT EXISTS (  SELECT  * FROM  lineitem l3 WHERE l3.l_orderkey = l1.l_orderkey AND l3.l_suppkey <> l1.l_suppkey AND l3.l_receiptdate > l3.l_commitdate) AND s_nationkey = n_nationkey AND n_name = 'SAUDI ARABIA' GROUP BY s_name ORDER BY numwait DESC, s_name LIMIT 100;", 'PROV', '0')
----
96
