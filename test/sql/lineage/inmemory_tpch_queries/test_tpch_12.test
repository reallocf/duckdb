# name: test/sql/lineage/inmemory_tpch_queries/test_tpch_12.test
# description: Test TPC-H Query 12 in-memory
# group: [inmemory_tpch_queries]

require tpch

statement ok
CALL dbgen(sf=0.01);

statement ok
PRAGMA trace_lineage = "ON";

statement ok
SELECT l_shipmode, sum(CASE WHEN o_orderpriority = '1-URGENT' OR o_orderpriority = '2-HIGH' THEN 1 ELSE 0 END) AS high_line_count, sum(CASE WHEN o_orderpriority <> '1-URGENT' AND o_orderpriority <> '2-HIGH' THEN 1 ELSE 0 END) AS low_line_count FROM orders, lineitem WHERE o_orderkey = l_orderkey AND l_shipmode IN ('MAIL', 'SHIP') AND l_commitdate < l_receiptdate AND l_shipdate < l_commitdate AND l_receiptdate >= CAST('1994-01-01' AS date) AND l_receiptdate < CAST('1995-01-01' AS date) GROUP BY l_shipmode ORDER BY l_shipmode

statement ok
PRAGMA trace_lineage = "OFF";

query I
PRAGMA lineage_query("SELECT l_shipmode, sum(CASE WHEN o_orderpriority = '1-URGENT' OR o_orderpriority = '2-HIGH' THEN 1 ELSE 0 END) AS high_line_count, sum(CASE WHEN o_orderpriority <> '1-URGENT' AND o_orderpriority <> '2-HIGH' THEN 1 ELSE 0 END) AS low_line_count FROM orders, lineitem WHERE o_orderkey = l_orderkey AND l_shipmode IN ('MAIL', 'SHIP') AND l_commitdate < l_receiptdate AND l_shipdate < l_commitdate AND l_receiptdate >= CAST('1994-01-01' AS date) AND l_receiptdate < CAST('1995-01-01' AS date) GROUP BY l_shipmode ORDER BY l_shipmode", 'VALUE', 0)
----
[892, 1046, 1121, 1244, 2190, 2479, 2541, 4745, 5846, 5943, 7378, 7722, 7792, 7928, 7946, 8163, 8311, 8625, 9180, 9549, 10080, 10625, 10627, 10913, 10932, 11298, 11624, 11954, 12458, 12514, 12848, 12916, 13667, 14163, 16236, 16457, 16743, 16767, 16990, 17120, 18013, 18015, 19067, 19808, 20009, 20209, 20419, 21793, 22908, 23951, 25225, 25615, 25627, 25917, 26115, 26147, 27636, 27006, 28259, 28386, 29317, 29589, 29636, 30032, 30633, 31349, 31470, 31851, 31913, 31915, 32232, 32234, 32835, 33077, 33473, 34374, 35386, 35534, 35725, 36108, 36489, 37055, 37332, 37668, 38356, 38472, 38573, 38640, 38658, 38804, 38964, 39158, 39202, 39222, 39378, 39871, 40286, 40621, 40624, 41281, 42048, 42597, 42599, 42632, 42794, 43850, 44533, 45587, 46181, 46761, 48035, 48082, 48264, 48575, 48790, 49131, 49266, 49624, 49779, 50005, 50196, 51102, 51104, 51257, 51312, 51724, 53088, 53350, 53404, 54067, 54069, 54078, 54408, 55224, 55496, 55830, 55958, 56062, 56063, 56259, 56393, 57143, 57615, 57875, 58301, 58790, 59046, 59198, 59253, 59954, 229, 266, 284, 318, 549, 617, 633, 1179, 1459, 1485, 1843, 1936, 1956, 1989, 1994, 2043, 2079, 2153, 2298, 2399, 2537, 2670, 2670, 2740, 2745, 2835, 2919, 2999, 3116, 3131, 3215, 3229, 3405, 3529, 4058, 4114, 4185, 4191, 4250, 4282, 4511, 4511, 4770, 4946, 4988, 5038, 5094, 5430, 5693, 5945, 6267, 6364, 6367, 6444, 6494, 6501, 6867, 6709, 7011, 7040, 7275, 7341, 7353, 7454, 7605, 7794, 7823, 7915, 7930, 7930, 8012, 8013, 8154, 8219, 8313, 8543, 8799, 8840, 8892, 8983, 9076, 9206, 9274, 9360, 9534, 9562, 9588, 9605, 9609, 9644, 9687, 9732, 9743, 9747, 9786, 9900, 10002, 10089, 10089, 10253, 10446, 10580, 10580, 10589, 10632, 10913, 11084, 11347, 11498, 11647, 11959, 11967, 12010, 12095, 12147, 12234, 12271, 12360, 12398, 12454, 12503, 12732, 12733, 12770, 12786, 12895, 13221, 13287, 13301, 13474, 13474, 13477, 13562, 13765, 13833, 13916, 13955, 13984, 13984, 14030, 14067, 14250, 14378, 14440, 14542, 14663, 14724, 14762, 14775, 14944]

query I
PRAGMA lineage_query("SELECT l_shipmode, sum(CASE WHEN o_orderpriority = '1-URGENT' OR o_orderpriority = '2-HIGH' THEN 1 ELSE 0 END) AS high_line_count, sum(CASE WHEN o_orderpriority <> '1-URGENT' AND o_orderpriority <> '2-HIGH' THEN 1 ELSE 0 END) AS low_line_count FROM orders, lineitem WHERE o_orderkey = l_orderkey AND l_shipmode IN ('MAIL', 'SHIP') AND l_commitdate < l_receiptdate AND l_shipdate < l_commitdate AND l_receiptdate >= CAST('1994-01-01' AS date) AND l_receiptdate < CAST('1995-01-01' AS date) GROUP BY l_shipmode ORDER BY l_shipmode", 'VALUE', 1)
----
[262, 816, 1197, 1762, 1984, 2126, 2361, 2435, 2796, 2825, 4482, 4538, 4615, 4886, 5972, 6474, 6693, 6739, 6892, 7022, 8855, 9473, 10121, 10911, 12204, 12577, 12648, 13232, 13589, 13635, 13636, 13665, 13675, 14510, 14519, 14966, 15060, 15171, 15430, 15674, 16246, 17738, 19048, 19228, 19564, 20046, 20373, 20515, 21188, 21345, 21578, 21609, 22905, 23139, 23318, 24331, 24366, 24588, 24854, 24975, 25036, 25206, 25270, 25618, 25672, 26290, 27640, 26892, 27204, 27749, 28206, 28515, 28664, 29007, 29199, 29200, 30556, 30641, 30762, 30977, 32145, 32646, 33901, 33920, 34689, 34968, 35905, 36110, 36422, 38042, 38641, 38915, 39014, 39372, 39467, 39697, 39715, 39779, 39993, 40890, 41350, 41910, 41995, 42147, 42681, 42682, 43548, 43726, 44449, 44647, 45258, 46385, 46637, 48085, 48263, 48392, 48435, 49204, 49623, 50004, 50013, 50033, 50197, 50447, 50514, 50823, 50938, 51701, 52394, 52646, 53681, 53972, 54088, 54170, 54730, 54975, 55020, 55507, 55563, 55898, 56006, 56181, 56289, 56292, 56497, 56709, 56717, 57587, 58250, 58414, 58463, 58484, 58846, 58907, 59386, 59844, 59963, 63, 206, 305, 441, 496, 535, 593, 608, 694, 701, 1114, 1129, 1150, 1214, 1492, 1612, 1663, 1674, 1710, 1745, 2210, 2373, 2549, 2740, 3059, 3148, 3168, 3305, 3389, 3401, 3401, 3405, 3407, 3611, 3612, 3728, 3753, 3780, 3853, 3917, 4060, 4443, 4766, 4807, 4891, 4997, 5081, 5119, 5288, 5325, 5377, 5385, 5692, 5751, 5793, 6041, 6048, 6102, 6171, 6209, 6221, 6262, 6279, 6364, 6378, 6537, 6867, 6683, 6761, 6890, 7001, 7073, 7114, 7201, 7246, 7246, 7588, 7607, 7643, 7694, 7988, 8107, 8423, 8428, 8628, 8695, 8937, 8983, 9061, 9456, 9605, 9672, 9700, 9786, 9806, 9858, 9861, 9878, 9929, 10158, 10274, 10411, 10435, 10472, 10602, 10602, 10830, 10880, 11065, 11111, 11267, 11553, 11613, 11968, 12010, 12050, 12057, 12253, 12360, 12454, 12456, 12461, 12503, 12557, 12576, 12656, 12684, 12889, 13058, 13118, 13371, 13453, 13479, 13497, 13639, 13701, 13713, 13836, 13847, 13936, 13969, 14013, 14038, 14038, 14094, 14148, 14149, 14371, 14531, 14572, 14584, 14590, 14676, 14692, 14807, 14917, 14946]

query I
PRAGMA backward_lineage("SELECT l_shipmode, sum(CASE WHEN o_orderpriority = '1-URGENT' OR o_orderpriority = '2-HIGH' THEN 1 ELSE 0 END) AS high_line_count, sum(CASE WHEN o_orderpriority <> '1-URGENT' AND o_orderpriority <> '2-HIGH' THEN 1 ELSE 0 END) AS low_line_count FROM orders, lineitem WHERE o_orderkey = l_orderkey AND l_shipmode IN ('MAIL', 'SHIP') AND l_commitdate < l_receiptdate AND l_shipdate < l_commitdate AND l_receiptdate >= CAST('1994-01-01' AS date) AND l_receiptdate < CAST('1995-01-01' AS date) GROUP BY l_shipmode ORDER BY l_shipmode", 'COUNT', '0')
----
300

query I
PRAGMA backward_lineage("SELECT l_shipmode, sum(CASE WHEN o_orderpriority = '1-URGENT' OR o_orderpriority = '2-HIGH' THEN 1 ELSE 0 END) AS high_line_count, sum(CASE WHEN o_orderpriority <> '1-URGENT' AND o_orderpriority <> '2-HIGH' THEN 1 ELSE 0 END) AS low_line_count FROM orders, lineitem WHERE o_orderkey = l_orderkey AND l_shipmode IN ('MAIL', 'SHIP') AND l_commitdate < l_receiptdate AND l_shipdate < l_commitdate AND l_receiptdate >= CAST('1994-01-01' AS date) AND l_receiptdate < CAST('1995-01-01' AS date) GROUP BY l_shipmode ORDER BY l_shipmode", 'LIN', '0')
----
300

query I
PRAGMA backward_lineage("SELECT l_shipmode, sum(CASE WHEN o_orderpriority = '1-URGENT' OR o_orderpriority = '2-HIGH' THEN 1 ELSE 0 END) AS high_line_count, sum(CASE WHEN o_orderpriority <> '1-URGENT' AND o_orderpriority <> '2-HIGH' THEN 1 ELSE 0 END) AS low_line_count FROM orders, lineitem WHERE o_orderkey = l_orderkey AND l_shipmode IN ('MAIL', 'SHIP') AND l_commitdate < l_receiptdate AND l_shipdate < l_commitdate AND l_receiptdate >= CAST('1994-01-01' AS date) AND l_receiptdate < CAST('1995-01-01' AS date) GROUP BY l_shipmode ORDER BY l_shipmode", 'PERM', '0')
----
300

query I
PRAGMA backward_lineage("SELECT l_shipmode, sum(CASE WHEN o_orderpriority = '1-URGENT' OR o_orderpriority = '2-HIGH' THEN 1 ELSE 0 END) AS high_line_count, sum(CASE WHEN o_orderpriority <> '1-URGENT' AND o_orderpriority <> '2-HIGH' THEN 1 ELSE 0 END) AS low_line_count FROM orders, lineitem WHERE o_orderkey = l_orderkey AND l_shipmode IN ('MAIL', 'SHIP') AND l_commitdate < l_receiptdate AND l_shipdate < l_commitdate AND l_receiptdate >= CAST('1994-01-01' AS date) AND l_receiptdate < CAST('1995-01-01' AS date) GROUP BY l_shipmode ORDER BY l_shipmode", 'PROV', '0')
----
300

query I
PRAGMA backward_lineage("SELECT l_shipmode, sum(CASE WHEN o_orderpriority = '1-URGENT' OR o_orderpriority = '2-HIGH' THEN 1 ELSE 0 END) AS high_line_count, sum(CASE WHEN o_orderpriority <> '1-URGENT' AND o_orderpriority <> '2-HIGH' THEN 1 ELSE 0 END) AS low_line_count FROM orders, lineitem WHERE o_orderkey = l_orderkey AND l_shipmode IN ('MAIL', 'SHIP') AND l_commitdate < l_receiptdate AND l_shipdate < l_commitdate AND l_receiptdate >= CAST('1994-01-01' AS date) AND l_receiptdate < CAST('1995-01-01' AS date) GROUP BY l_shipmode ORDER BY l_shipmode", 'COUNT', '1')
----
314
