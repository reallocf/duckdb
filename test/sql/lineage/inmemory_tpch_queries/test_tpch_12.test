# name: test/sql/lineage/inmemory_tpch_queries/test_tpch_12.test
# description: Test TPC-H Query 12 in-memory
# group: [inmemory_tpch_queries]

require tpch

statement ok
CALL dbgen(sf=0.01);

statement ok
PRAGMA trace_lineage = "ON";

statement ok
SELECT l_shipmode, sum(CASE WHEN o_orderpriority = '1-URGENT' OR o_orderpriority = '2-HIGH' THEN 1 ELSE 0 END) AS high_line_count, sum(CASE WHEN o_orderpriority <> '1-URGENT' AND o_orderpriority <> '2-HIGH' THEN 1 ELSE 0 END) AS low_line_count FROM orders, lineitem WHERE o_orderkey = l_orderkey AND l_shipmode IN ('MAIL', 'SHIP') AND l_commitdate < l_receiptdate AND l_shipdate < l_commitdate AND l_receiptdate >= CAST('1994-01-01' AS date) AND l_receiptdate < CAST('1995-01-01' AS date) GROUP BY l_shipmode ORDER BY l_shipmode

statement ok
PRAGMA trace_lineage = "OFF";

query I
PRAGMA backward_lineage("SELECT l_shipmode, sum(CASE WHEN o_orderpriority = '1-URGENT' OR o_orderpriority = '2-HIGH' THEN 1 ELSE 0 END) AS high_line_count, sum(CASE WHEN o_orderpriority <> '1-URGENT' AND o_orderpriority <> '2-HIGH' THEN 1 ELSE 0 END) AS low_line_count FROM orders, lineitem WHERE o_orderkey = l_orderkey AND l_shipmode IN ('MAIL', 'SHIP') AND l_commitdate < l_receiptdate AND l_shipdate < l_commitdate AND l_receiptdate >= CAST('1994-01-01' AS date) AND l_receiptdate < CAST('1995-01-01' AS date) GROUP BY l_shipmode ORDER BY l_shipmode", 'VALUE', '0')
----
[892, 229, 1046, 266, 1121, 284, 1244, 318, 2190, 549, 2479, 617, 2541, 633, 4745, 1179, 5846, 1459, 5943, 1485, 7378, 1843, 7722, 1936, 7792, 1956, 7928, 1989, 7946, 1994, 8163, 2043, 8311, 2079, 8625, 2153, 9180, 2298, 9549, 2399, 10080, 2537, 10625, 2670, 10627, 2670, 10913, 2740, 10932, 2745, 11298, 2835, 11624, 2919, 11954, 2999, 12458, 3116, 12514, 3131, 12848, 3215, 12916, 3229, 13667, 3405, 14163, 3529, 16236, 4058, 16457, 4114, 16743, 4185, 16767, 4191, 16990, 4250, 17120, 4282, 18013, 4511, 18015, 4511, 19067, 4770, 19808, 4946, 20009, 4988, 20209, 5038, 20419, 5094, 21793, 5430, 22908, 5693, 23951, 5945, 25225, 6267, 25615, 6364, 25627, 6367, 25917, 6444, 26115, 6494, 26147, 6501, 27636, 6867, 27006, 6709, 28259, 7011, 28386, 7040, 29317, 7275, 29589, 7341, 29636, 7353, 30032, 7454, 30633, 7605, 31349, 7794, 31470, 7823, 31851, 7915, 31913, 7930, 31915, 7930, 32232, 8012, 32234, 8013, 32835, 8154, 33077, 8219, 33473, 8313, 34374, 8543, 35386, 8799, 35534, 8840, 35725, 8892, 36108, 8983, 36489, 9076, 37055, 9206, 37332, 9274, 37668, 9360, 38356, 9534, 38472, 9562, 38573, 9588, 38640, 9605, 38658, 9609, 38804, 9644, 38964, 9687, 39158, 9732, 39202, 9743, 39222, 9747, 39378, 9786, 39871, 9900, 40286, 10002, 40621, 10089, 40624, 10089, 41281, 10253, 42048, 10446, 42597, 10580, 42599, 10580, 42632, 10589, 42794, 10632, 43850, 10913, 44533, 11084, 45587, 11347, 46181, 11498, 46761, 11647, 48035, 11959, 48082, 11967, 48264, 12010, 48575, 12095, 48790, 12147, 49131, 12234, 49266, 12271, 49624, 12360, 49779, 12398, 50005, 12454, 50196, 12503, 51102, 12732, 51104, 12733, 51257, 12770, 51312, 12786, 51724, 12895, 53088, 13221, 53350, 13287, 53404, 13301, 54067, 13474, 54069, 13474, 54078, 13477, 54408, 13562, 55224, 13765, 55496, 13833, 55830, 13916, 55958, 13955, 56062, 13984, 56063, 13984, 56259, 14030, 56393, 14067, 57143, 14250, 57615, 14378, 57875, 14440, 58301, 14542, 58790, 14663, 59046, 14724, 59198, 14762, 59253, 14775, 59954, 14944]

query I
PRAGMA backward_lineage("SELECT l_shipmode, sum(CASE WHEN o_orderpriority = '1-URGENT' OR o_orderpriority = '2-HIGH' THEN 1 ELSE 0 END) AS high_line_count, sum(CASE WHEN o_orderpriority <> '1-URGENT' AND o_orderpriority <> '2-HIGH' THEN 1 ELSE 0 END) AS low_line_count FROM orders, lineitem WHERE o_orderkey = l_orderkey AND l_shipmode IN ('MAIL', 'SHIP') AND l_commitdate < l_receiptdate AND l_shipdate < l_commitdate AND l_receiptdate >= CAST('1994-01-01' AS date) AND l_receiptdate < CAST('1995-01-01' AS date) GROUP BY l_shipmode ORDER BY l_shipmode", 'VALUE', '1')
----
[262, 63, 816, 206, 1197, 305, 1762, 441, 1984, 496, 2126, 535, 2361, 593, 2435, 608, 2796, 694, 2825, 701, 4482, 1114, 4538, 1129, 4615, 1150, 4886, 1214, 5972, 1492, 6474, 1612, 6693, 1663, 6739, 1674, 6892, 1710, 7022, 1745, 8855, 2210, 9473, 2373, 10121, 2549, 10911, 2740, 12204, 3059, 12577, 3148, 12648, 3168, 13232, 3305, 13589, 3389, 13635, 3401, 13636, 3401, 13665, 3405, 13675, 3407, 14510, 3611, 14519, 3612, 14966, 3728, 15060, 3753, 15171, 3780, 15430, 3853, 15674, 3917, 16246, 4060, 17738, 4443, 19048, 4766, 19228, 4807, 19564, 4891, 20046, 4997, 20373, 5081, 20515, 5119, 21188, 5288, 21345, 5325, 21578, 5377, 21609, 5385, 22905, 5692, 23139, 5751, 23318, 5793, 24331, 6041, 24366, 6048, 24588, 6102, 24854, 6171, 24975, 6209, 25036, 6221, 25206, 6262, 25270, 6279, 25618, 6364, 25672, 6378, 26290, 6537, 27640, 6867, 26892, 6683, 27204, 6761, 27749, 6890, 28206, 7001, 28515, 7073, 28664, 7114, 29007, 7201, 29199, 7246, 29200, 7246, 30556, 7588, 30641, 7607, 30762, 7643, 30977, 7694, 32145, 7988, 32646, 8107, 33901, 8423, 33920, 8428, 34689, 8628, 34968, 8695, 35905, 8937, 36110, 8983, 36422, 9061, 38042, 9456, 38641, 9605, 38915, 9672, 39014, 9700, 39372, 9786, 39467, 9806, 39697, 9858, 39715, 9861, 39779, 9878, 39993, 9929, 40890, 10158, 41350, 10274, 41910, 10411, 41995, 10435, 42147, 10472, 42681, 10602, 42682, 10602, 43548, 10830, 43726, 10880, 44449, 11065, 44647, 11111, 45258, 11267, 46385, 11553, 46637, 11613, 48085, 11968, 48263, 12010, 48392, 12050, 48435, 12057, 49204, 12253, 49623, 12360, 50004, 12454, 50013, 12456, 50033, 12461, 50197, 12503, 50447, 12557, 50514, 12576, 50823, 12656, 50938, 12684, 51701, 12889, 52394, 13058, 52646, 13118, 53681, 13371, 53972, 13453, 54088, 13479, 54170, 13497, 54730, 13639, 54975, 13701, 55020, 13713, 55507, 13836, 55563, 13847, 55898, 13936, 56006, 13969, 56181, 14013, 56289, 14038, 56292, 14038, 56497, 14094, 56709, 14148, 56717, 14149, 57587, 14371, 58250, 14531, 58414, 14572, 58463, 14584, 58484, 14590, 58846, 14676, 58907, 14692, 59386, 14807, 59844, 14917, 59963, 14946]

query I
PRAGMA backward_lineage("SELECT l_shipmode, sum(CASE WHEN o_orderpriority = '1-URGENT' OR o_orderpriority = '2-HIGH' THEN 1 ELSE 0 END) AS high_line_count, sum(CASE WHEN o_orderpriority <> '1-URGENT' AND o_orderpriority <> '2-HIGH' THEN 1 ELSE 0 END) AS low_line_count FROM orders, lineitem WHERE o_orderkey = l_orderkey AND l_shipmode IN ('MAIL', 'SHIP') AND l_commitdate < l_receiptdate AND l_shipdate < l_commitdate AND l_receiptdate >= CAST('1994-01-01' AS date) AND l_receiptdate < CAST('1995-01-01' AS date) GROUP BY l_shipmode ORDER BY l_shipmode", 'COUNT', '0')
----
300

query I
PRAGMA backward_lineage("SELECT l_shipmode, sum(CASE WHEN o_orderpriority = '1-URGENT' OR o_orderpriority = '2-HIGH' THEN 1 ELSE 0 END) AS high_line_count, sum(CASE WHEN o_orderpriority <> '1-URGENT' AND o_orderpriority <> '2-HIGH' THEN 1 ELSE 0 END) AS low_line_count FROM orders, lineitem WHERE o_orderkey = l_orderkey AND l_shipmode IN ('MAIL', 'SHIP') AND l_commitdate < l_receiptdate AND l_shipdate < l_commitdate AND l_receiptdate >= CAST('1994-01-01' AS date) AND l_receiptdate < CAST('1995-01-01' AS date) GROUP BY l_shipmode ORDER BY l_shipmode", 'COUNT', '1')
----
314
