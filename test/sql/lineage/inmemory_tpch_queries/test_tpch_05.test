# name: test/sql/lineage/inmemory_tpch_queries/test_tpch_05.test
# description: Test TPC-H Query 5 in-memory
# group: [inmemory_tpch_queries]

require tpch

statement ok
CALL dbgen(sf=0.01);

statement ok
PRAGMA trace_lineage = "ON";

statement ok
SELECT n_name, sum(l_extendedprice * (1 - l_discount)) AS revenue FROM customer, orders, lineitem, supplier, nation, region WHERE c_custkey = o_custkey AND l_orderkey = o_orderkey AND l_suppkey = s_suppkey AND c_nationkey = s_nationkey AND s_nationkey = n_nationkey AND n_regionkey = r_regionkey AND r_name = 'ASIA' AND o_orderdate >= CAST('1994-01-01' AS date) AND o_orderdate < CAST('1995-01-01' AS date) GROUP BY n_name ORDER BY revenue DESC

statement ok
PRAGMA trace_lineage = "OFF";

query I
PRAGMA backward_lineage("SELECT n_name, sum(l_extendedprice * (1 - l_discount)) AS revenue FROM customer, orders, lineitem, supplier, nation, region WHERE c_custkey = o_custkey AND l_orderkey = o_orderkey AND l_suppkey = s_suppkey AND c_nationkey = s_nationkey AND s_nationkey = n_nationkey AND n_regionkey = r_regionkey AND r_name = 'ASIA' AND o_orderdate >= CAST('1994-01-01' AS date) AND o_orderdate < CAST('1995-01-01' AS date) GROUP BY n_name ORDER BY revenue DESC", 'VALUE', '0')
----
[136, 1802, 2849, 3168, 3433, 3485, 3526, 8430, 9600, 14234, 14518, 14519, 14967, 16878, 20323, 21457, 22486, 22256, 24329, 24331, 24449, 24538, 29405, 34344, 41686, 44198, 49096, 49097, 49806, 58813, 59379, 34, 99, 25, 99, 99, 79, 67, 34, 67, 25, 34, 97, 97, 99, 25, 25, 25, 34, 34, 97, 97, 97, 97, 67, 99, 34, 97, 79, 25, 79, 34, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 34, 450, 706, 783, 852, 865, 875, 2109, 2412, 3543, 3612, 3612, 3728, 4222, 5069, 5350, 5594, 5543, 6041, 6041, 6069, 6093, 7298, 8535, 10359, 11001, 12227, 12227, 12406, 14667, 14806, 927, 927, 1018, 229, 1296, 945, 1018, 177, 1410, 990, 720, 720, 1410, 945, 1438, 177, 1149, 1414, 1086, 1086, 1410, 1084, 1149, 480, 1149, 480, 1062, 1062, 720, 460, 1414]

query I
PRAGMA backward_lineage("SELECT n_name, sum(l_extendedprice * (1 - l_discount)) AS revenue FROM customer, orders, lineitem, supplier, nation, region WHERE c_custkey = o_custkey AND l_orderkey = o_orderkey AND l_suppkey = s_suppkey AND c_nationkey = s_nationkey AND s_nationkey = n_nationkey AND n_regionkey = r_regionkey AND r_name = 'ASIA' AND o_orderdate >= CAST('1994-01-01' AS date) AND o_orderdate < CAST('1995-01-01' AS date) GROUP BY n_name ORDER BY revenue DESC", 'VALUE', '3')
----
[2480, 18512, 18570, 19094, 22956, 24794, 39385, 40925, 41995, 45452, 34651, 47637, 48383, 54694, 57191, 59167, 88, 88, 88, 50, 88, 22, 50, 50, 49, 50, 88, 88, 22, 88, 44, 50, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 617, 4636, 4650, 4776, 5705, 6155, 9788, 10166, 10435, 11315, 8618, 11864, 12047, 13630, 14268, 14755, 180, 1488, 93, 840, 703, 180, 1488, 622, 138, 421, 66, 141, 891, 405, 1230, 909]

query I
PRAGMA backward_lineage("SELECT n_name, sum(l_extendedprice * (1 - l_discount)) AS revenue FROM customer, orders, lineitem, supplier, nation, region WHERE c_custkey = o_custkey AND l_orderkey = o_orderkey AND l_suppkey = s_suppkey AND c_nationkey = s_nationkey AND s_nationkey = n_nationkey AND n_regionkey = r_regionkey AND r_name = 'ASIA' AND o_orderdate >= CAST('1994-01-01' AS date) AND o_orderdate < CAST('1995-01-01' AS date) GROUP BY n_name ORDER BY revenue DESC", 'COUNT', '0')
----
186

query I
PRAGMA backward_lineage("SELECT n_name, sum(l_extendedprice * (1 - l_discount)) AS revenue FROM customer, orders, lineitem, supplier, nation, region WHERE c_custkey = o_custkey AND l_orderkey = o_orderkey AND l_suppkey = s_suppkey AND c_nationkey = s_nationkey AND s_nationkey = n_nationkey AND n_regionkey = r_regionkey AND r_name = 'ASIA' AND o_orderdate >= CAST('1994-01-01' AS date) AND o_orderdate < CAST('1995-01-01' AS date) GROUP BY n_name ORDER BY revenue DESC", 'LIN', '0')
----
186

query I
PRAGMA backward_lineage("SELECT n_name, sum(l_extendedprice * (1 - l_discount)) AS revenue FROM customer, orders, lineitem, supplier, nation, region WHERE c_custkey = o_custkey AND l_orderkey = o_orderkey AND l_suppkey = s_suppkey AND c_nationkey = s_nationkey AND s_nationkey = n_nationkey AND n_regionkey = r_regionkey AND r_name = 'ASIA' AND o_orderdate >= CAST('1994-01-01' AS date) AND o_orderdate < CAST('1995-01-01' AS date) GROUP BY n_name ORDER BY revenue DESC", 'PERM', '0')
----
186

query I
PRAGMA backward_lineage("SELECT n_name, sum(l_extendedprice * (1 - l_discount)) AS revenue FROM customer, orders, lineitem, supplier, nation, region WHERE c_custkey = o_custkey AND l_orderkey = o_orderkey AND l_suppkey = s_suppkey AND c_nationkey = s_nationkey AND s_nationkey = n_nationkey AND n_regionkey = r_regionkey AND r_name = 'ASIA' AND o_orderdate >= CAST('1994-01-01' AS date) AND o_orderdate < CAST('1995-01-01' AS date) GROUP BY n_name ORDER BY revenue DESC", 'PROV', '0')
----
186

query I
PRAGMA backward_lineage("SELECT n_name, sum(l_extendedprice * (1 - l_discount)) AS revenue FROM customer, orders, lineitem, supplier, nation, region WHERE c_custkey = o_custkey AND l_orderkey = o_orderkey AND l_suppkey = s_suppkey AND c_nationkey = s_nationkey AND s_nationkey = n_nationkey AND n_regionkey = r_regionkey AND r_name = 'ASIA' AND o_orderdate >= CAST('1994-01-01' AS date) AND o_orderdate < CAST('1995-01-01' AS date) GROUP BY n_name ORDER BY revenue DESC", 'COUNT', '3')
----
96
