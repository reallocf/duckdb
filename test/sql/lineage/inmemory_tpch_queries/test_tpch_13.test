# name: test/sql/lineage/inmemory_tpch_queries/test_tpch_13.test
# description: Test TPC-H Query 13 in-memory
# group: [inmemory_tpch_queries]

require tpch

statement ok
CALL dbgen(sf=0.01);

statement ok
PRAGMA trace_lineage = "ON";

statement ok
SELECT c_count, count(*) AS custdist FROM (SELECT c_custkey, count(o_orderkey) FROM customer LEFT OUTER JOIN orders ON c_custkey = o_custkey AND o_comment NOT LIKE '%special%requests%' GROUP BY c_custkey) AS c_orders (c_custkey, c_count) GROUP BY c_count ORDER BY custdist DESC, c_count DESC

statement ok
PRAGMA trace_lineage = "OFF";

query I
PRAGMA backward_lineage("SELECT c_count, count(*) AS custdist FROM (SELECT c_custkey, count(o_orderkey) FROM customer LEFT OUTER JOIN orders ON c_custkey = o_custkey AND o_comment NOT LIKE '%special%requests%' GROUP BY c_custkey) AS c_orders (c_custkey, c_count) GROUP BY c_count ORDER BY custdist DESC, c_count DESC", 'VALUE', '0')
----
[2, 5, 8, 11, 14, 17, 20, 23, 26, 29, 32, 35, 38, 41, 44, 47, 50, 53, 56, 59, 62, 65, 68, 71, 74, 77, 80, 83, 86, 89, 92, 95, 98, 101, 104, 107, 110, 113, 116, 119, 122, 125, 128, 131, 134, 137, 140, 143, 146, 149, 152, 155, 158, 161, 164, 167, 170, 173, 176, 179, 182, 185, 188, 191, 194, 197, 200, 203, 206, 209, 212, 215, 218, 221, 224, 227, 230, 233, 236, 239, 242, 245, 248, 251, 254, 257, 260, 263, 266, 269, 272, 275, 278, 281, 284, 287, 290, 293, 296, 299, 302, 305, 308, 311, 314, 317, 320, 323, 326, 329, 332, 335, 338, 341, 344, 347, 350, 353, 356, 359, 362, 365, 368, 371, 374, 377, 380, 383, 386, 389, 392, 395, 398, 401, 404, 407, 410, 413, 416, 419, 422, 425, 428, 431, 434, 437, 440, 443, 446, 449, 452, 455, 458, 461, 464, 467, 470, 473, 476, 479, 482, 485, 488, 491, 494, 497, 500, 503, 506, 509, 512, 515, 518, 521, 524, 527, 530, 533, 536, 539, 542, 545, 548, 551, 554, 557, 560, 563, 566, 569, 572, 575, 578, 581, 584, 587, 590, 593, 596, 599, 602, 605, 608, 611, 614, 617, 620, 623, 626, 629, 632, 635, 638, 641, 644, 647, 650, 653, 656, 659, 662, 665, 668, 671, 674, 677, 680, 683, 686, 689, 692, 695, 698, 701, 704, 707, 710, 713, 716, 719, 722, 725, 728, 731, 734, 737, 740, 743, 746, 749, 752, 755, 758, 761, 764, 767, 770, 773, 776, 779, 782, 785, 788, 791, 794, 797, 800, 803, 806, 809, 812, 815, 818, 821, 824, 827, 830, 833, 836, 839, 842, 845, 848, 851, 854, 857, 860, 863, 866, 869, 872, 875, 878, 881, 884, 887, 890, 893, 896, 899, 902, 905, 908, 911, 914, 917, 920, 923, 926, 929, 932, 935, 938, 941, 944, 947, 950, 953, 956, 959, 962, 965, 968, 971, 974, 977, 980, 983, 986, 989, 992, 995, 998, 1001, 1004, 1007, 1010, 1013, 1016, 1019, 1022, 1025, 1028, 1031, 1034, 1037, 1040, 1043, 1046, 1049, 1052, 1055, 1058, 1061, 1064, 1067, 1070, 1073, 1076, 1079, 1082, 1085, 1088, 1091, 1094, 1097, 1100, 1103, 1106, 1109, 1112, 1115, 1118, 1121, 1124, 1127, 1130, 1133, 1136, 1139, 1142, 1145, 1148, 1151, 1154, 1157, 1160, 1163, 1166, 1169, 1172, 1175, 1178, 1181, 1184, 1187, 1190, 1193, 1196, 1199, 1202, 1205, 1208, 1211, 1214, 1217, 1220, 1223, 1226, 1229, 1232, 1235, 1238, 1241, 1244, 1247, 1250, 1253, 1256, 1259, 1262, 1265, 1268, 1271, 1274, 1277, 1280, 1283, 1286, 1289, 1292, 1295, 1298, 1301, 1304, 1307, 1310, 1313, 1316, 1319, 1322, 1325, 1328, 1331, 1334, 1337, 1340, 1343, 1346, 1349, 1352, 1355, 1358, 1361, 1364, 1367, 1370, 1373, 1376, 1379, 1382, 1385, 1388, 1391, 1394, 1397, 1400, 1403, 1406, 1409, 1412, 1415, 1418, 1421, 1424, 1427, 1430, 1433, 1436, 1439, 1442, 1445, 1448, 1451, 1454, 1457, 1460, 1463, 1466, 1469, 1472, 1475, 1478, 1481, 1484, 1487, 1490, 1493, 1496, 1499]

query I
PRAGMA backward_lineage("SELECT c_count, count(*) AS custdist FROM (SELECT c_custkey, count(o_orderkey) FROM customer LEFT OUTER JOIN orders ON c_custkey = o_custkey AND o_comment NOT LIKE '%special%requests%' GROUP BY c_custkey) AS c_orders (c_custkey, c_count) GROUP BY c_count ORDER BY custdist DESC, c_count DESC", 'VALUE', '1')
----
[1961, 13, 2754, 13, 3903, 13, 5153, 13, 7410, 13, 8310, 13, 9691, 13, 10475, 13, 11286, 13, 13969, 13, 14410, 13, 93, 22, 1578, 22, 2368, 22, 3720, 22, 4701, 22, 5902, 22, 8179, 22, 10215, 22, 10585, 22, 12317, 22, 12435, 22, 414, 43, 2148, 43, 3792, 43, 5479, 43, 6186, 43, 8666, 43, 10003, 43, 11244, 43, 11296, 43, 11923, 43, 13767, 43, 309, 97, 905, 97, 2053, 97, 3795, 97, 4299, 97, 7467, 97, 8463, 97, 9316, 97, 9884, 97, 9979, 97, 12269, 97, 245, 133, 308, 133, 665, 133, 1795, 133, 3293, 133, 5415, 133, 6651, 133, 7632, 133, 11092, 133, 14092, 133, 14682, 133, 1225, 136, 4939, 136, 5362, 136, 6490, 136, 8843, 136, 9147, 136, 11247, 136, 11718, 136, 12818, 136, 14493, 136, 14877, 136, 374, 145, 3789, 145, 5698, 145, 7827, 145, 7879, 145, 9065, 145, 9236, 145, 9402, 145, 9456, 145, 9803, 145, 14907, 145, 1204, 148, 3064, 148, 5382, 148, 6183, 148, 7407, 148, 8641, 148, 8696, 148, 10821, 148, 11449, 148, 12018, 148, 14272, 148, 924, 157, 1928, 157, 2874, 157, 3256, 157, 4886, 157, 4977, 157, 10748, 157, 11530, 157, 11573, 157, 11669, 157, 14586, 157, 786, 165, 2631, 165, 3086, 165, 4357, 165, 6875, 165, 9381, 165, 9757, 165, 10772, 165, 12327, 165, 13293, 165, 13984, 165, 335, 169, 1678, 169, 2372, 169, 5773, 169, 6174, 169, 9478, 169, 10187, 169, 13280, 169, 13519, 169, 13865, 169, 13895, 169, 1878, 187, 3124, 187, 3412, 187, 3967, 187, 3990, 187, 7845, 187, 8619, 187, 8784, 187, 9827, 187, 9994, 187, 10743, 187, 1499, 292, 1648, 292, 2727, 292, 5054, 292, 7607, 292, 9116, 292, 9498, 292, 11024, 292, 11261, 292, 11886, 292, 13887, 292, 6723, 372, 7213, 372, 8828, 372, 9085, 372, 9408, 372, 10398, 372, 11896, 372, 13410, 372, 13717, 372, 13931, 372, 14007, 372, 3420, 453, 3467, 453, 5318, 453, 7786, 453, 8919, 453, 9854, 453, 11142, 453, 13000, 453, 13464, 453, 13482, 453, 13550, 453, 5858, 490, 6433, 490, 7147, 490, 8144, 490, 10264, 490, 10425, 490, 10707, 490, 11033, 490, 13968, 490, 14144, 490, 14233, 490, 655, 511, 842, 511, 992, 511, 4144, 511, 4303, 511, 4708, 511, 6170, 511, 6404, 511, 7344, 511, 10167, 511, 10788, 511, 104, 546, 5621, 546, 7258, 546, 9472, 546, 9969, 546, 10921, 546, 11260, 546, 11401, 546, 12619, 546, 12837, 546, 14589, 546, 621, 562, 678, 562, 1572, 562, 6960, 562, 10512, 562, 10799, 562, 10986, 562, 11638, 562, 12844, 562, 14308, 562, 14857, 562, 162, 577, 2645, 577, 3698, 577, 4680, 577, 5062, 577, 5093, 577, 6856, 577, 9744, 577, 12735, 577, 13278, 577, 14706, 577, 115, 595, 1157, 595, 1816, 595, 2959, 595, 4084, 595, 5849, 595, 6365, 595, 7988, 595, 9267, 595, 10722, 595, 12933, 595, 9, 610, 320, 610, 2286, 610, 2971, 610, 3813, 610, 7110, 610, 7867, 610, 8262, 610, 8924, 610, 10949, 610, 14146, 610, 1344, 622, 1540, 622, 2111, 622, 2467, 622, 3237, 622, 6711, 622, 9266, 622, 9823, 622, 10155, 622, 10166, 622, 10673, 622, 949, 649, 1545, 649, 2660, 649, 4154, 649, 4523, 649, 6405, 649, 6538, 649, 7237, 649, 10436, 649, 10759, 649, 13122, 649, 231, 657, 601, 657, 769, 657, 2339, 657, 3611, 657, 5831, 657, 8526, 657, 13166, 657, 13775, 657, 13990, 657, 14569, 657, 853, 667, 2784, 667, 3659, 667, 4035, 667, 5076, 667, 5235, 667, 7208, 667, 7403, 667, 9073, 667, 11275, 667, 11911, 667, 1187, 676, 1409, 676, 2257, 676, 5356, 676, 5603, 676, 6122, 676, 9388, 676, 10374, 676, 10791, 676, 11958, 676, 12996, 676, 1003, 682, 1127, 682, 1736, 682, 2512, 682, 2987, 682, 4667, 682, 7503, 682, 10622, 682, 10742, 682, 10745, 682, 10922, 682, 148, 687, 211, 687, 1245, 687, 1281, 687, 1495, 687, 2933, 687, 7011, 687, 8891, 687, 10182, 687, 11579, 687, 12987, 687, 90, 700, 4914, 700, 5578, 700, 7077, 700, 7196, 700, 9399, 700, 10574, 700, 10996, 700, 11320, 700, 11597, 700, 14012, 700, 2073, 733, 2532, 733, 2664, 733, 3203, 733, 3999, 733, 4917, 733, 8782, 733, 9165, 733, 10242, 733, 10537, 733, 11665, 733, 649, 775, 1276, 775, 1733, 775, 3784, 775, 5718, 775, 8271, 775, 8288, 775, 9868, 775, 11336, 775, 13615, 775, 14153, 775, 3385, 781, 4053, 781, 4288, 781, 5758, 781, 7494, 781, 8342, 781, 8610, 781, 8821, 781, 11091, 781, 11850, 781, 12160, 781, 48, 790, 2917, 790, 3519, 790, 5720, 790, 8387, 790, 10302, 790, 11455, 790, 13084, 790, 13368, 790, 13530, 790, 14258, 790, 1309, 796, 2554, 796, 4180, 796, 6655, 796, 7065, 796, 9269, 796, 10776, 796, 11967, 796, 12617, 796, 12793, 796, 14097, 796, 192, 799, 523, 799, 1224, 799, 1661, 799, 4978, 799, 6670, 799, 8273, 799, 8295, 799, 10064, 799, 11518, 799, 14460, 799, 1505, 832, 3721, 832, 5215, 832, 7634, 832, 8304, 832, 8835, 832, 9240, 832, 9567, 832, 10224, 832, 13754, 832, 13885, 832, 4249, 853, 4618, 853, 4651, 853, 5539, 853, 5642, 853, 6449, 853, 6676, 853, 7952, 853, 8477, 853, 12333, 853, 14647, 853, 622, 883, 684, 883, 870, 883, 1346, 883, 3733, 883, 4193, 883, 5531, 883, 6468, 883, 7252, 883, 10337, 883, 14185, 883, 964, 886, 2347, 886, 2964, 886, 5027, 886, 5338, 886, 6727, 886, 8685, 886, 8970, 886, 13146, 886, 13570, 886, 14105, 886, 673, 934, 984, 934, 1163, 934, 3673, 934, 5417, 934, 7622, 934, 8427, 934, 10558, 934, 11892, 934, 13975, 934, 14883, 934, 417, 940, 670, 940, 1399, 940, 1895, 940, 5689, 940, 8046, 940, 9087, 940, 12506, 940, 12849, 940, 13299, 940, 14235, 940, 625, 958, 1686, 958, 3878, 958, 5085, 958, 8499, 958, 9525, 958, 11314, 958, 11847, 958, 12129, 958, 12481, 958, 13995, 958, 195, 964, 941, 964, 3539, 964, 3751, 964, 4926, 964, 7470, 964, 7482, 964, 8554, 964, 8939, 964, 9964, 964, 12667, 964, 292, 967, 4925, 967, 5052, 967, 5632, 967, 6640, 967, 8056, 967, 8154, 967, 8325, 967, 10169, 967, 11469, 967, 12105, 967, 758, 1015, 1221, 1015, 3389, 1015, 3511, 1015, 4707, 1015, 5223, 1015, 5700, 1015, 9863, 1015, 11685, 1015, 12204, 1015, 14437, 1015, 1050, 1036, 1066, 1036, 1241, 1036, 5828, 1036, 5909, 1036, 8704, 1036, 11384, 1036, 13889, 1036, 14377, 1036, 14428, 1036, 14730, 1036, 4091, 1042, 4098, 1042, 4635, 1042, 5591, 1042, 6314, 1042, 7226, 1042, 8026, 1042, 8844, 1042, 8930, 1042, 11625, 1042, 14801, 1042, 440, 1048, 2358, 1048, 2868, 1048, 4274, 1048, 5847, 1048, 6785, 1048, 7476, 1048, 8125, 1048, 8640, 1048, 10100, 1048, 13631, 1048, 83, 1051, 1812, 1051, 2171, 1051, 2451, 1051, 2713, 1051, 4062, 1051, 4787, 1051, 11392, 1051, 13419, 1051, 13462, 1051, 13513, 1051, 361, 1105, 1393, 1105, 1766, 1105, 3763, 1105, 4023, 1105, 6825, 1105, 8010, 1105, 9939, 1105, 9991, 1105, 10709, 1105, 11095, 1105, 322, 1164, 1010, 1164, 3286, 1164, 4875, 1164, 5352, 1164, 6564, 1164, 9289, 1164, 10582, 1164, 11974, 1164, 12407, 1164, 14303, 1164, 866, 1186, 1671, 1186, 2919, 1186, 3184, 1186, 6225, 1186, 7849, 1186, 8341, 1186, 8740, 1186, 11235, 1186, 13021, 1186, 13752, 1186, 303, 1219, 854, 1219, 2404, 1219, 4648, 1219, 5398, 1219, 7370, 1219, 12859, 1219, 13109, 1219, 13461, 1219, 14767, 1219, 14835, 1219, 1856, 1252, 4365, 1252, 5546, 1252, 6440, 1252, 7589, 1252, 9424, 1252, 9809, 1252, 10859, 1252, 11732, 1252, 13123, 1252, 13413, 1252, 6288, 1273, 6896, 1273, 8720, 1273, 9084, 1273, 9793, 1273, 10669, 1273, 10783, 1273, 10790, 1273, 13941, 1273, 14639, 1273, 14679, 1273, 173, 1306, 1950, 1306, 3040, 1306, 3341, 1306, 8715, 1306, 9810, 1306, 10690, 1306, 11274, 1306, 11719, 1306, 13211, 1306, 13294, 1306, 967, 1330, 3634, 1330, 4585, 1330, 5951, 1330, 7158, 1330, 9099, 1330, 9468, 1330, 10102, 1330, 11067, 1330, 12326, 1330, 13317, 1330, 397, 1333, 430, 1333, 1160, 1333, 3165, 1333, 3185, 1333, 4817, 1333, 6376, 1333, 7341, 1333, 8581, 1333, 12312, 1333, 12956, 1333, 50, 1354, 3801, 1354, 4496, 1354, 4657, 1354, 6805, 1354, 6979, 1354, 10377, 1354, 10911, 1354, 11199, 1354, 14414, 1354, 14832, 1354, 791, 1357, 2365, 1357, 2583, 1357, 2828, 1357, 2842, 1357, 4840, 1357, 8823, 1357, 9107, 1357, 12801, 1357, 13883, 1357, 13891, 1357, 201, 1366, 6105, 1366, 6111, 1366, 6580, 1366, 9436, 1366, 10120, 1366, 10218, 1366, 10505, 1366, 12868, 1366, 13663, 1366, 13873, 1366, 445, 1384, 824, 1384, 3799, 1384, 4118, 1384, 5451, 1384, 6331, 1384, 6964, 1384, 8559, 1384, 12352, 1384, 12416, 1384, 13362, 1384, 4190, 1390, 4621, 1390, 6629, 1390, 6834, 1390, 7025, 1390, 9233, 1390, 9485, 1390, 11566, 1390, 11694, 1390, 12889, 1390, 13246, 1390, 516, 1405, 573, 1405, 1520, 1405, 1756, 1405, 3450, 1405, 3678, 1405, 7353, 1405, 7866, 1405, 10004, 1405, 12065, 1405, 13929, 1405, 329, 1423, 835, 1423, 2523, 1423, 2984, 1423, 3214, 1423, 4668, 1423, 7799, 1423, 8489, 1423, 10931, 1423, 12553, 1423, 14197, 1423, 137, 1432, 278, 1432, 285, 1432, 3217, 1432, 4453, 1432, 5736, 1432, 8993, 1432, 9287, 1432, 11378, 1432, 12807, 1432, 14932, 1432, 804, 1462, 1258, 1462, 2333, 1462, 2571, 1462, 3760, 1462, 11696, 1462, 11935, 1462, 12230, 1462, 12843, 1462, 12854, 1462, 14680, 1462]

query I
PRAGMA backward_lineage("SELECT c_count, count(*) AS custdist FROM (SELECT c_custkey, count(o_orderkey) FROM customer LEFT OUTER JOIN orders ON c_custkey = o_custkey AND o_comment NOT LIKE '%special%requests%' GROUP BY c_custkey) AS c_orders (c_custkey, c_count) GROUP BY c_count ORDER BY custdist DESC, c_count DESC", 'VALUE', '30')
----
[79, 3, 186, 3, 1635, 3, 2671, 3, 2699, 3, 3431, 3, 3738, 3, 3850, 3, 5097, 3, 5617, 3, 6103, 3, 6319, 3, 6476, 3, 6606, 3, 6681, 3, 6715, 3, 7104, 3, 7397, 3, 8690, 3, 9097, 3, 9532, 3, 10399, 3, 11125, 3, 11742, 3, 13505, 3, 13603, 3, 13681, 3, 14051, 3, 14537, 3, 14774, 3, 14787, 3]

query I
PRAGMA backward_lineage("SELECT c_count, count(*) AS custdist FROM (SELECT c_custkey, count(o_orderkey) FROM customer LEFT OUTER JOIN orders ON c_custkey = o_custkey AND o_comment NOT LIKE '%special%requests%' GROUP BY c_custkey) AS c_orders (c_custkey, c_count) GROUP BY c_count ORDER BY custdist DESC, c_count DESC", 'COUNT', '0')
----
500

query I
PRAGMA backward_lineage("SELECT c_count, count(*) AS custdist FROM (SELECT c_custkey, count(o_orderkey) FROM customer LEFT OUTER JOIN orders ON c_custkey = o_custkey AND o_comment NOT LIKE '%special%requests%' GROUP BY c_custkey) AS c_orders (c_custkey, c_count) GROUP BY c_count ORDER BY custdist DESC, c_count DESC", 'COUNT', '1')
----
1496

query I
PRAGMA backward_lineage("SELECT c_count, count(*) AS custdist FROM (SELECT c_custkey, count(o_orderkey) FROM customer LEFT OUTER JOIN orders ON c_custkey = o_custkey AND o_comment NOT LIKE '%special%requests%' GROUP BY c_custkey) AS c_orders (c_custkey, c_count) GROUP BY c_count ORDER BY custdist DESC, c_count DESC", 'COUNT', '30')
----
62
