# name: test/sql/lineage/inmemory_tpch_queries/test_tpch_13.test
# description: Test TPC-H Query 13 in-memory
# group: [inmemory_tpch_queries]

require tpch

statement ok
CALL dbgen(sf=0.01);

statement ok
PRAGMA trace_lineage = "ON";

statement ok
SELECT c_count, count(*) AS custdist FROM (SELECT c_custkey, count(o_orderkey) FROM customer LEFT OUTER JOIN orders ON c_custkey = o_custkey AND o_comment NOT LIKE '%special%requests%' GROUP BY c_custkey) AS c_orders (c_custkey, c_count) GROUP BY c_count ORDER BY custdist DESC, c_count DESC

statement ok
PRAGMA trace_lineage = "OFF";

query I
PRAGMA backward_lineage("SELECT c_count, count(*) AS custdist FROM (SELECT c_custkey, count(o_orderkey) FROM customer LEFT OUTER JOIN orders ON c_custkey = o_custkey AND o_comment NOT LIKE '%special%requests%' GROUP BY c_custkey) AS c_orders (c_custkey, c_count) GROUP BY c_count ORDER BY custdist DESC, c_count DESC", 'VALUE', '0')
----
[2, 5, 8, 11, 14, 17, 20, 23, 26, 29, 32, 35, 38, 41, 44, 47, 50, 53, 56, 59, 62, 65, 68, 71, 74, 77, 80, 83, 86, 89, 92, 95, 98, 101, 104, 107, 110, 113, 116, 119, 122, 125, 128, 131, 134, 137, 140, 143, 146, 149, 152, 155, 158, 161, 164, 167, 170, 173, 176, 179, 182, 185, 188, 191, 194, 197, 200, 203, 206, 209, 212, 215, 218, 221, 224, 227, 230, 233, 236, 239, 242, 245, 248, 251, 254, 257, 260, 263, 266, 269, 272, 275, 278, 281, 284, 287, 290, 293, 296, 299, 302, 305, 308, 311, 314, 317, 320, 323, 326, 329, 332, 335, 338, 341, 344, 347, 350, 353, 356, 359, 362, 365, 368, 371, 374, 377, 380, 383, 386, 389, 392, 395, 398, 401, 404, 407, 410, 413, 416, 419, 422, 425, 428, 431, 434, 437, 440, 443, 446, 449, 452, 455, 458, 461, 464, 467, 470, 473, 476, 479, 482, 485, 488, 491, 494, 497, 500, 503, 506, 509, 512, 515, 518, 521, 524, 527, 530, 533, 536, 539, 542, 545, 548, 551, 554, 557, 560, 563, 566, 569, 572, 575, 578, 581, 584, 587, 590, 593, 596, 599, 602, 605, 608, 611, 614, 617, 620, 623, 626, 629, 632, 635, 638, 641, 644, 647, 650, 653, 656, 659, 662, 665, 668, 671, 674, 677, 680, 683, 686, 689, 692, 695, 698, 701, 704, 707, 710, 713, 716, 719, 722, 725, 728, 731, 734, 737, 740, 743, 746, 749, 752, 755, 758, 761, 764, 767, 770, 773, 776, 779, 782, 785, 788, 791, 794, 797, 800, 803, 806, 809, 812, 815, 818, 821, 824, 827, 830, 833, 836, 839, 842, 845, 848, 851, 854, 857, 860, 863, 866, 869, 872, 875, 878, 881, 884, 887, 890, 893, 896, 899, 902, 905, 908, 911, 914, 917, 920, 923, 926, 929, 932, 935, 938, 941, 944, 947, 950, 953, 956, 959, 962, 965, 968, 971, 974, 977, 980, 983, 986, 989, 992, 995, 998, 1001, 1004, 1007, 1010, 1013, 1016, 1019, 1022, 1025, 1028, 1031, 1034, 1037, 1040, 1043, 1046, 1049, 1052, 1055, 1058, 1061, 1064, 1067, 1070, 1073, 1076, 1079, 1082, 1085, 1088, 1091, 1094, 1097, 1100, 1103, 1106, 1109, 1112, 1115, 1118, 1121, 1124, 1127, 1130, 1133, 1136, 1139, 1142, 1145, 1148, 1151, 1154, 1157, 1160, 1163, 1166, 1169, 1172, 1175, 1178, 1181, 1184, 1187, 1190, 1193, 1196, 1199, 1202, 1205, 1208, 1211, 1214, 1217, 1220, 1223, 1226, 1229, 1232, 1235, 1238, 1241, 1244, 1247, 1250, 1253, 1256, 1259, 1262, 1265, 1268, 1271, 1274, 1277, 1280, 1283, 1286, 1289, 1292, 1295, 1298, 1301, 1304, 1307, 1310, 1313, 1316, 1319, 1322, 1325, 1328, 1331, 1334, 1337, 1340, 1343, 1346, 1349, 1352, 1355, 1358, 1361, 1364, 1367, 1370, 1373, 1376, 1379, 1382, 1385, 1388, 1391, 1394, 1397, 1400, 1403, 1406, 1409, 1412, 1415, 1418, 1421, 1424, 1427, 1430, 1433, 1436, 1439, 1442, 1445, 1448, 1451, 1454, 1457, 1460, 1463, 1466, 1469, 1472, 1475, 1478, 1481, 1484, 1487, 1490, 1493, 1496, 1499]

query I
PRAGMA backward_lineage("SELECT c_count, count(*) AS custdist FROM (SELECT c_custkey, count(o_orderkey) FROM customer LEFT OUTER JOIN orders ON c_custkey = o_custkey AND o_comment NOT LIKE '%special%requests%' GROUP BY c_custkey) AS c_orders (c_custkey, c_count) GROUP BY c_count ORDER BY custdist DESC, c_count DESC", 'VALUE', '1')
----
[1961, 2754, 3903, 5153, 7410, 8310, 9691, 10475, 11286, 13969, 14410, 13, 13, 13, 13, 13, 13, 13, 13, 13, 13, 13, 93, 1578, 2368, 3720, 4701, 5902, 8179, 10215, 10585, 12317, 12435, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 414, 2148, 3792, 5479, 6186, 8666, 10003, 11244, 11296, 11923, 13767, 43, 43, 43, 43, 43, 43, 43, 43, 43, 43, 43, 309, 905, 2053, 3795, 4299, 7467, 8463, 9316, 9884, 9979, 12269, 97, 97, 97, 97, 97, 97, 97, 97, 97, 97, 97, 245, 308, 665, 1795, 3293, 5415, 6651, 7632, 11092, 14092, 14682, 133, 133, 133, 133, 133, 133, 133, 133, 133, 133, 133, 1225, 4939, 5362, 6490, 8843, 9147, 11247, 11718, 12818, 14493, 14877, 136, 136, 136, 136, 136, 136, 136, 136, 136, 136, 136, 374, 3789, 5698, 7827, 7879, 9065, 9236, 9402, 9456, 9803, 14907, 145, 145, 145, 145, 145, 145, 145, 145, 145, 145, 145, 1204, 3064, 5382, 6183, 7407, 8641, 8696, 10821, 11449, 12018, 14272, 148, 148, 148, 148, 148, 148, 148, 148, 148, 148, 148, 924, 1928, 2874, 3256, 4886, 4977, 10748, 11530, 11573, 11669, 14586, 157, 157, 157, 157, 157, 157, 157, 157, 157, 157, 157, 786, 2631, 3086, 4357, 6875, 9381, 9757, 10772, 12327, 13293, 13984, 165, 165, 165, 165, 165, 165, 165, 165, 165, 165, 165, 335, 1678, 2372, 5773, 6174, 9478, 10187, 13280, 13519, 13865, 13895, 169, 169, 169, 169, 169, 169, 169, 169, 169, 169, 169, 1878, 3124, 3412, 3967, 3990, 7845, 8619, 8784, 9827, 9994, 10743, 187, 187, 187, 187, 187, 187, 187, 187, 187, 187, 187, 1499, 1648, 2727, 5054, 7607, 9116, 9498, 11024, 11261, 11886, 13887, 292, 292, 292, 292, 292, 292, 292, 292, 292, 292, 292, 6723, 7213, 8828, 9085, 9408, 10398, 11896, 13410, 13717, 13931, 14007, 372, 372, 372, 372, 372, 372, 372, 372, 372, 372, 372, 3420, 3467, 5318, 7786, 8919, 9854, 11142, 13000, 13464, 13482, 13550, 453, 453, 453, 453, 453, 453, 453, 453, 453, 453, 453, 5858, 6433, 7147, 8144, 10264, 10425, 10707, 11033, 13968, 14144, 14233, 490, 490, 490, 490, 490, 490, 490, 490, 490, 490, 490, 655, 842, 992, 4144, 4303, 4708, 6170, 6404, 7344, 10167, 10788, 511, 511, 511, 511, 511, 511, 511, 511, 511, 511, 511, 104, 5621, 7258, 9472, 9969, 10921, 11260, 11401, 12619, 12837, 14589, 546, 546, 546, 546, 546, 546, 546, 546, 546, 546, 546, 621, 678, 1572, 6960, 10512, 10799, 10986, 11638, 12844, 14308, 14857, 562, 562, 562, 562, 562, 562, 562, 562, 562, 562, 562, 162, 2645, 3698, 4680, 5062, 5093, 6856, 9744, 12735, 13278, 14706, 577, 577, 577, 577, 577, 577, 577, 577, 577, 577, 577, 115, 1157, 1816, 2959, 4084, 5849, 6365, 7988, 9267, 10722, 12933, 595, 595, 595, 595, 595, 595, 595, 595, 595, 595, 595, 9, 320, 2286, 2971, 3813, 7110, 7867, 8262, 8924, 10949, 14146, 610, 610, 610, 610, 610, 610, 610, 610, 610, 610, 610, 1344, 1540, 2111, 2467, 3237, 6711, 9266, 9823, 10155, 10166, 10673, 622, 622, 622, 622, 622, 622, 622, 622, 622, 622, 622, 949, 1545, 2660, 4154, 4523, 6405, 6538, 7237, 10436, 10759, 13122, 649, 649, 649, 649, 649, 649, 649, 649, 649, 649, 649, 231, 601, 769, 2339, 3611, 5831, 8526, 13166, 13775, 13990, 14569, 657, 657, 657, 657, 657, 657, 657, 657, 657, 657, 657, 853, 2784, 3659, 4035, 5076, 5235, 7208, 7403, 9073, 11275, 11911, 667, 667, 667, 667, 667, 667, 667, 667, 667, 667, 667, 1187, 1409, 2257, 5356, 5603, 6122, 9388, 10374, 10791, 11958, 12996, 676, 676, 676, 676, 676, 676, 676, 676, 676, 676, 676, 1003, 1127, 1736, 2512, 2987, 4667, 7503, 10622, 10742, 10745, 10922, 682, 682, 682, 682, 682, 682, 682, 682, 682, 682, 682, 148, 211, 1245, 1281, 1495, 2933, 7011, 8891, 10182, 11579, 12987, 687, 687, 687, 687, 687, 687, 687, 687, 687, 687, 687, 90, 4914, 5578, 7077, 7196, 9399, 10574, 10996, 11320, 11597, 14012, 700, 700, 700, 700, 700, 700, 700, 700, 700, 700, 700, 2073, 2532, 2664, 3203, 3999, 4917, 8782, 9165, 10242, 10537, 11665, 733, 733, 733, 733, 733, 733, 733, 733, 733, 733, 733, 649, 1276, 1733, 3784, 5718, 8271, 8288, 9868, 11336, 13615, 14153, 775, 775, 775, 775, 775, 775, 775, 775, 775, 775, 775, 3385, 4053, 4288, 5758, 7494, 8342, 8610, 8821, 11091, 11850, 12160, 781, 781, 781, 781, 781, 781, 781, 781, 781, 781, 781, 48, 2917, 3519, 5720, 8387, 10302, 11455, 13084, 13368, 13530, 14258, 790, 790, 790, 790, 790, 790, 790, 790, 790, 790, 790, 1309, 2554, 4180, 6655, 7065, 9269, 10776, 11967, 12617, 12793, 14097, 796, 796, 796, 796, 796, 796, 796, 796, 796, 796, 796, 192, 523, 1224, 1661, 4978, 6670, 8273, 8295, 10064, 11518, 14460, 799, 799, 799, 799, 799, 799, 799, 799, 799, 799, 799, 1505, 3721, 5215, 7634, 8304, 8835, 9240, 9567, 10224, 13754, 13885, 832, 832, 832, 832, 832, 832, 832, 832, 832, 832, 832, 4249, 4618, 4651, 5539, 5642, 6449, 6676, 7952, 8477, 12333, 14647, 853, 853, 853, 853, 853, 853, 853, 853, 853, 853, 853, 622, 684, 870, 1346, 3733, 4193, 5531, 6468, 7252, 10337, 14185, 883, 883, 883, 883, 883, 883, 883, 883, 883, 883, 883, 964, 2347, 2964, 5027, 5338, 6727, 8685, 8970, 13146, 13570, 14105, 886, 886, 886, 886, 886, 886, 886, 886, 886, 886, 886, 673, 984, 1163, 3673, 5417, 7622, 8427, 10558, 11892, 13975, 14883, 934, 934, 934, 934, 934, 934, 934, 934, 934, 934, 934, 417, 670, 1399, 1895, 5689, 8046, 9087, 12506, 12849, 13299, 14235, 940, 940, 940, 940, 940, 940, 940, 940, 940, 940, 940, 625, 1686, 3878, 5085, 8499, 9525, 11314, 11847, 12129, 12481, 13995, 958, 958, 958, 958, 958, 958, 958, 958, 958, 958, 958, 195, 941, 3539, 3751, 4926, 7470, 7482, 8554, 8939, 9964, 12667, 964, 964, 964, 964, 964, 964, 964, 964, 964, 964, 964, 292, 4925, 5052, 5632, 6640, 8056, 8154, 8325, 10169, 11469, 12105, 967, 967, 967, 967, 967, 967, 967, 967, 967, 967, 967, 758, 1221, 3389, 3511, 4707, 5223, 5700, 9863, 11685, 12204, 14437, 1015, 1015, 1015, 1015, 1015, 1015, 1015, 1015, 1015, 1015, 1015, 1050, 1066, 1241, 5828, 5909, 8704, 11384, 13889, 14377, 14428, 14730, 1036, 1036, 1036, 1036, 1036, 1036, 1036, 1036, 1036, 1036, 1036, 4091, 4098, 4635, 5591, 6314, 7226, 8026, 8844, 8930, 11625, 14801, 1042, 1042, 1042, 1042, 1042, 1042, 1042, 1042, 1042, 1042, 1042, 440, 2358, 2868, 4274, 5847, 6785, 7476, 8125, 8640, 10100, 13631, 1048, 1048, 1048, 1048, 1048, 1048, 1048, 1048, 1048, 1048, 1048, 83, 1812, 2171, 2451, 2713, 4062, 4787, 11392, 13419, 13462, 13513, 1051, 1051, 1051, 1051, 1051, 1051, 1051, 1051, 1051, 1051, 1051, 361, 1393, 1766, 3763, 4023, 6825, 8010, 9939, 9991, 10709, 11095, 1105, 1105, 1105, 1105, 1105, 1105, 1105, 1105, 1105, 1105, 1105, 322, 1010, 3286, 4875, 5352, 6564, 9289, 10582, 11974, 12407, 14303, 1164, 1164, 1164, 1164, 1164, 1164, 1164, 1164, 1164, 1164, 1164, 866, 1671, 2919, 3184, 6225, 7849, 8341, 8740, 11235, 13021, 13752, 1186, 1186, 1186, 1186, 1186, 1186, 1186, 1186, 1186, 1186, 1186, 303, 854, 2404, 4648, 5398, 7370, 12859, 13109, 13461, 14767, 14835, 1219, 1219, 1219, 1219, 1219, 1219, 1219, 1219, 1219, 1219, 1219, 1856, 4365, 5546, 6440, 7589, 9424, 9809, 10859, 11732, 13123, 13413, 1252, 1252, 1252, 1252, 1252, 1252, 1252, 1252, 1252, 1252, 1252, 6288, 6896, 8720, 9084, 9793, 10669, 10783, 10790, 13941, 14639, 14679, 1273, 1273, 1273, 1273, 1273, 1273, 1273, 1273, 1273, 1273, 1273, 173, 1950, 3040, 3341, 8715, 9810, 10690, 11274, 11719, 13211, 13294, 1306, 1306, 1306, 1306, 1306, 1306, 1306, 1306, 1306, 1306, 1306, 967, 3634, 4585, 5951, 7158, 9099, 9468, 10102, 11067, 12326, 13317, 1330, 1330, 1330, 1330, 1330, 1330, 1330, 1330, 1330, 1330, 1330, 397, 430, 1160, 3165, 3185, 4817, 6376, 7341, 8581, 12312, 12956, 1333, 1333, 1333, 1333, 1333, 1333, 1333, 1333, 1333, 1333, 1333, 50, 3801, 4496, 4657, 6805, 6979, 10377, 10911, 11199, 14414, 14832, 1354, 1354, 1354, 1354, 1354, 1354, 1354, 1354, 1354, 1354, 1354, 791, 2365, 2583, 2828, 2842, 4840, 8823, 9107, 12801, 13883, 13891, 1357, 1357, 1357, 1357, 1357, 1357, 1357, 1357, 1357, 1357, 1357, 201, 6105, 6111, 6580, 9436, 10120, 10218, 10505, 12868, 13663, 13873, 1366, 1366, 1366, 1366, 1366, 1366, 1366, 1366, 1366, 1366, 1366, 445, 824, 3799, 4118, 5451, 6331, 6964, 8559, 12352, 12416, 13362, 1384, 1384, 1384, 1384, 1384, 1384, 1384, 1384, 1384, 1384, 1384, 4190, 4621, 6629, 6834, 7025, 9233, 9485, 11566, 11694, 12889, 13246, 1390, 1390, 1390, 1390, 1390, 1390, 1390, 1390, 1390, 1390, 1390, 516, 573, 1520, 1756, 3450, 3678, 7353, 7866, 10004, 12065, 13929, 1405, 1405, 1405, 1405, 1405, 1405, 1405, 1405, 1405, 1405, 1405, 329, 835, 2523, 2984, 3214, 4668, 7799, 8489, 10931, 12553, 14197, 1423, 1423, 1423, 1423, 1423, 1423, 1423, 1423, 1423, 1423, 1423, 137, 278, 285, 3217, 4453, 5736, 8993, 9287, 11378, 12807, 14932, 1432, 1432, 1432, 1432, 1432, 1432, 1432, 1432, 1432, 1432, 1432, 804, 1258, 2333, 2571, 3760, 11696, 11935, 12230, 12843, 12854, 14680, 1462, 1462, 1462, 1462, 1462, 1462, 1462, 1462, 1462, 1462, 1462]

query I
PRAGMA backward_lineage("SELECT c_count, count(*) AS custdist FROM (SELECT c_custkey, count(o_orderkey) FROM customer LEFT OUTER JOIN orders ON c_custkey = o_custkey AND o_comment NOT LIKE '%special%requests%' GROUP BY c_custkey) AS c_orders (c_custkey, c_count) GROUP BY c_count ORDER BY custdist DESC, c_count DESC", 'VALUE', '30')
----
[79, 186, 1635, 2671, 2699, 3431, 3738, 3850, 5097, 5617, 6103, 6319, 6476, 6606, 6681, 6715, 7104, 7397, 8690, 9097, 9532, 10399, 11125, 11742, 13505, 13603, 13681, 14051, 14537, 14774, 14787, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3]

query I
PRAGMA backward_lineage("SELECT c_count, count(*) AS custdist FROM (SELECT c_custkey, count(o_orderkey) FROM customer LEFT OUTER JOIN orders ON c_custkey = o_custkey AND o_comment NOT LIKE '%special%requests%' GROUP BY c_custkey) AS c_orders (c_custkey, c_count) GROUP BY c_count ORDER BY custdist DESC, c_count DESC", 'COUNT', '0')
----
500

query I
PRAGMA backward_lineage("SELECT c_count, count(*) AS custdist FROM (SELECT c_custkey, count(o_orderkey) FROM customer LEFT OUTER JOIN orders ON c_custkey = o_custkey AND o_comment NOT LIKE '%special%requests%' GROUP BY c_custkey) AS c_orders (c_custkey, c_count) GROUP BY c_count ORDER BY custdist DESC, c_count DESC", 'COUNT', '1')
----
1496

query I
PRAGMA backward_lineage("SELECT c_count, count(*) AS custdist FROM (SELECT c_custkey, count(o_orderkey) FROM customer LEFT OUTER JOIN orders ON c_custkey = o_custkey AND o_comment NOT LIKE '%special%requests%' GROUP BY c_custkey) AS c_orders (c_custkey, c_count) GROUP BY c_count ORDER BY custdist DESC, c_count DESC", 'COUNT', '30')
----
62
