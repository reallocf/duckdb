# name: test/sql/lineage/inmemory_tpch_queries/test_tpch_13.test
# description: Test TPC-H Query 13 in-memory
# group: [inmemory_tpch_queries]

require tpch

statement ok
CALL dbgen(sf=0.01);

statement ok
PRAGMA trace_lineage = "ON";

statement ok
SELECT c_count, count(*) AS custdist FROM (SELECT c_custkey, count(o_orderkey) FROM customer LEFT OUTER JOIN orders ON c_custkey = o_custkey AND o_comment NOT LIKE '%special%requests%' GROUP BY c_custkey) AS c_orders (c_custkey, c_count) GROUP BY c_count ORDER BY custdist DESC, c_count DESC

statement ok
PRAGMA trace_lineage = "OFF";

# This result looks weird and is different than the results from the persisted table lineage query, but I _think_ it's right since it's just referring to the 0 from the custdist table once per aggregation (since there was no join match)
query I
PRAGMA backward_lineage("SELECT c_count, count(*) AS custdist FROM (SELECT c_custkey, count(o_orderkey) FROM customer LEFT OUTER JOIN orders ON c_custkey = o_custkey AND o_comment NOT LIKE '%special%requests%' GROUP BY c_custkey) AS c_orders (c_custkey, c_count) GROUP BY c_count ORDER BY custdist DESC, c_count DESC", 'VALUE', '0')
----
[0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]

query I
PRAGMA backward_lineage("SELECT c_count, count(*) AS custdist FROM (SELECT c_custkey, count(o_orderkey) FROM customer LEFT OUTER JOIN orders ON c_custkey = o_custkey AND o_comment NOT LIKE '%special%requests%' GROUP BY c_custkey) AS c_orders (c_custkey, c_count) GROUP BY c_count ORDER BY custdist DESC, c_count DESC", 'VALUE', '1')
----
[13, 13, 13, 13, 13, 13, 13, 13, 13, 13, 13, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 43, 43, 43, 43, 43, 43, 43, 43, 43, 43, 43, 97, 97, 97, 97, 97, 97, 97, 97, 97, 97, 97, 133, 133, 133, 133, 133, 133, 133, 133, 133, 133, 133, 136, 136, 136, 136, 136, 136, 136, 136, 136, 136, 136, 145, 145, 145, 145, 145, 145, 145, 145, 145, 145, 145, 148, 148, 148, 148, 148, 148, 148, 148, 148, 148, 148, 157, 157, 157, 157, 157, 157, 157, 157, 157, 157, 157, 165, 165, 165, 165, 165, 165, 165, 165, 165, 165, 165, 169, 169, 169, 169, 169, 169, 169, 169, 169, 169, 169, 187, 187, 187, 187, 187, 187, 187, 187, 187, 187, 187, 292, 292, 292, 292, 292, 292, 292, 292, 292, 292, 292, 372, 372, 372, 372, 372, 372, 372, 372, 372, 372, 372, 453, 453, 453, 453, 453, 453, 453, 453, 453, 453, 453, 490, 490, 490, 490, 490, 490, 490, 490, 490, 490, 490, 511, 511, 511, 511, 511, 511, 511, 511, 511, 511, 511, 546, 546, 546, 546, 546, 546, 546, 546, 546, 546, 546, 562, 562, 562, 562, 562, 562, 562, 562, 562, 562, 562, 577, 577, 577, 577, 577, 577, 577, 577, 577, 577, 577, 595, 595, 595, 595, 595, 595, 595, 595, 595, 595, 595, 610, 610, 610, 610, 610, 610, 610, 610, 610, 610, 610, 622, 622, 622, 622, 622, 622, 622, 622, 622, 622, 622, 649, 649, 649, 649, 649, 649, 649, 649, 649, 649, 649, 657, 657, 657, 657, 657, 657, 657, 657, 657, 657, 657, 667, 667, 667, 667, 667, 667, 667, 667, 667, 667, 667, 676, 676, 676, 676, 676, 676, 676, 676, 676, 676, 676, 682, 682, 682, 682, 682, 682, 682, 682, 682, 682, 682, 687, 687, 687, 687, 687, 687, 687, 687, 687, 687, 687, 700, 700, 700, 700, 700, 700, 700, 700, 700, 700, 700, 733, 733, 733, 733, 733, 733, 733, 733, 733, 733, 733, 775, 775, 775, 775, 775, 775, 775, 775, 775, 775, 775, 781, 781, 781, 781, 781, 781, 781, 781, 781, 781, 781, 790, 790, 790, 790, 790, 790, 790, 790, 790, 790, 790, 796, 796, 796, 796, 796, 796, 796, 796, 796, 796, 796, 799, 799, 799, 799, 799, 799, 799, 799, 799, 799, 799, 832, 832, 832, 832, 832, 832, 832, 832, 832, 832, 832, 853, 853, 853, 853, 853, 853, 853, 853, 853, 853, 853, 883, 883, 883, 883, 883, 883, 883, 883, 883, 883, 883, 886, 886, 886, 886, 886, 886, 886, 886, 886, 886, 886, 934, 934, 934, 934, 934, 934, 934, 934, 934, 934, 934, 940, 940, 940, 940, 940, 940, 940, 940, 940, 940, 940, 958, 958, 958, 958, 958, 958, 958, 958, 958, 958, 958, 964, 964, 964, 964, 964, 964, 964, 964, 964, 964, 964, 967, 967, 967, 967, 967, 967, 967, 967, 967, 967, 967, 1015, 1015, 1015, 1015, 1015, 1015, 1015, 1015, 1015, 1015, 1015, 1036, 1036, 1036, 1036, 1036, 1036, 1036, 1036, 1036, 1036, 1036, 1042, 1042, 1042, 1042, 1042, 1042, 1042, 1042, 1042, 1042, 1042, 1048, 1048, 1048, 1048, 1048, 1048, 1048, 1048, 1048, 1048, 1048, 1051, 1051, 1051, 1051, 1051, 1051, 1051, 1051, 1051, 1051, 1051, 1105, 1105, 1105, 1105, 1105, 1105, 1105, 1105, 1105, 1105, 1105, 1164, 1164, 1164, 1164, 1164, 1164, 1164, 1164, 1164, 1164, 1164, 1186, 1186, 1186, 1186, 1186, 1186, 1186, 1186, 1186, 1186, 1186, 1219, 1219, 1219, 1219, 1219, 1219, 1219, 1219, 1219, 1219, 1219, 1252, 1252, 1252, 1252, 1252, 1252, 1252, 1252, 1252, 1252, 1252, 1273, 1273, 1273, 1273, 1273, 1273, 1273, 1273, 1273, 1273, 1273, 1306, 1306, 1306, 1306, 1306, 1306, 1306, 1306, 1306, 1306, 1306, 1330, 1330, 1330, 1330, 1330, 1330, 1330, 1330, 1330, 1330, 1330, 1333, 1333, 1333, 1333, 1333, 1333, 1333, 1333, 1333, 1333, 1333, 1354, 1354, 1354, 1354, 1354, 1354, 1354, 1354, 1354, 1354, 1354, 1357, 1357, 1357, 1357, 1357, 1357, 1357, 1357, 1357, 1357, 1357, 1366, 1366, 1366, 1366, 1366, 1366, 1366, 1366, 1366, 1366, 1366, 1384, 1384, 1384, 1384, 1384, 1384, 1384, 1384, 1384, 1384, 1384, 1390, 1390, 1390, 1390, 1390, 1390, 1390, 1390, 1390, 1390, 1390, 1405, 1405, 1405, 1405, 1405, 1405, 1405, 1405, 1405, 1405, 1405, 1423, 1423, 1423, 1423, 1423, 1423, 1423, 1423, 1423, 1423, 1423, 1432, 1432, 1432, 1432, 1432, 1432, 1432, 1432, 1432, 1432, 1432, 1462, 1462, 1462, 1462, 1462, 1462, 1462, 1462, 1462, 1462, 1462, 1961, 2754, 3903, 5153, 7410, 8310, 9691, 10475, 11286, 13969, 14410, 93, 1578, 2368, 3720, 4701, 5902, 8179, 10215, 10585, 12317, 12435, 414, 2148, 3792, 5479, 6186, 8666, 10003, 11244, 11296, 11923, 13767, 309, 905, 2053, 3795, 4299, 7467, 8463, 9316, 9884, 9979, 12269, 245, 308, 665, 1795, 3293, 5415, 6651, 7632, 11092, 14092, 14682, 1225, 4939, 5362, 6490, 8843, 9147, 11247, 11718, 12818, 14493, 14877, 374, 3789, 5698, 7827, 7879, 9065, 9236, 9402, 9456, 9803, 14907, 1204, 3064, 5382, 6183, 7407, 8641, 8696, 10821, 11449, 12018, 14272, 924, 1928, 2874, 3256, 4886, 4977, 10748, 11530, 11573, 11669, 14586, 786, 2631, 3086, 4357, 6875, 9381, 9757, 10772, 12327, 13293, 13984, 335, 1678, 2372, 5773, 6174, 9478, 10187, 13280, 13519, 13865, 13895, 1878, 3124, 3412, 3967, 3990, 7845, 8619, 8784, 9827, 9994, 10743, 1499, 1648, 2727, 5054, 7607, 9116, 9498, 11024, 11261, 11886, 13887, 6723, 7213, 8828, 9085, 9408, 10398, 11896, 13410, 13717, 13931, 14007, 3420, 3467, 5318, 7786, 8919, 9854, 11142, 13000, 13464, 13482, 13550, 5858, 6433, 7147, 8144, 10264, 10425, 10707, 11033, 13968, 14144, 14233, 655, 842, 992, 4144, 4303, 4708, 6170, 6404, 7344, 10167, 10788, 104, 5621, 7258, 9472, 9969, 10921, 11260, 11401, 12619, 12837, 14589, 621, 678, 1572, 6960, 10512, 10799, 10986, 11638, 12844, 14308, 14857, 162, 2645, 3698, 4680, 5062, 5093, 6856, 9744, 12735, 13278, 14706, 115, 1157, 1816, 2959, 4084, 5849, 6365, 7988, 9267, 10722, 12933, 9, 320, 2286, 2971, 3813, 7110, 7867, 8262, 8924, 10949, 14146, 1344, 1540, 2111, 2467, 3237, 6711, 9266, 9823, 10155, 10166, 10673, 949, 1545, 2660, 4154, 4523, 6405, 6538, 7237, 10436, 10759, 13122, 231, 601, 769, 2339, 3611, 5831, 8526, 13166, 13775, 13990, 14569, 853, 2784, 3659, 4035, 5076, 5235, 7208, 7403, 9073, 11275, 11911, 1187, 1409, 2257, 5356, 5603, 6122, 9388, 10374, 10791, 11958, 12996, 1003, 1127, 1736, 2512, 2987, 4667, 7503, 10622, 10742, 10745, 10922, 148, 211, 1245, 1281, 1495, 2933, 7011, 8891, 10182, 11579, 12987, 90, 4914, 5578, 7077, 7196, 9399, 10574, 10996, 11320, 11597, 14012, 2073, 2532, 2664, 3203, 3999, 4917, 8782, 9165, 10242, 10537, 11665, 649, 1276, 1733, 3784, 5718, 8271, 8288, 9868, 11336, 13615, 14153, 3385, 4053, 4288, 5758, 7494, 8342, 8610, 8821, 11091, 11850, 12160, 48, 2917, 3519, 5720, 8387, 10302, 11455, 13084, 13368, 13530, 14258, 1309, 2554, 4180, 6655, 7065, 9269, 10776, 11967, 12617, 12793, 14097, 192, 523, 1224, 1661, 4978, 6670, 8273, 8295, 10064, 11518, 14460, 1505, 3721, 5215, 7634, 8304, 8835, 9240, 9567, 10224, 13754, 13885, 4249, 4618, 4651, 5539, 5642, 6449, 6676, 7952, 8477, 12333, 14647, 622, 684, 870, 1346, 3733, 4193, 5531, 6468, 7252, 10337, 14185, 964, 2347, 2964, 5027, 5338, 6727, 8685, 8970, 13146, 13570, 14105, 673, 984, 1163, 3673, 5417, 7622, 8427, 10558, 11892, 13975, 14883, 417, 670, 1399, 1895, 5689, 8046, 9087, 12506, 12849, 13299, 14235, 625, 1686, 3878, 5085, 8499, 9525, 11314, 11847, 12129, 12481, 13995, 195, 941, 3539, 3751, 4926, 7470, 7482, 8554, 8939, 9964, 12667, 292, 4925, 5052, 5632, 6640, 8056, 8154, 8325, 10169, 11469, 12105, 758, 1221, 3389, 3511, 4707, 5223, 5700, 9863, 11685, 12204, 14437, 1050, 1066, 1241, 5828, 5909, 8704, 11384, 13889, 14377, 14428, 14730, 4091, 4098, 4635, 5591, 6314, 7226, 8026, 8844, 8930, 11625, 14801, 440, 2358, 2868, 4274, 5847, 6785, 7476, 8125, 8640, 10100, 13631, 83, 1812, 2171, 2451, 2713, 4062, 4787, 11392, 13419, 13462, 13513, 361, 1393, 1766, 3763, 4023, 6825, 8010, 9939, 9991, 10709, 11095, 322, 1010, 3286, 4875, 5352, 6564, 9289, 10582, 11974, 12407, 14303, 866, 1671, 2919, 3184, 6225, 7849, 8341, 8740, 11235, 13021, 13752, 303, 854, 2404, 4648, 5398, 7370, 12859, 13109, 13461, 14767, 14835, 1856, 4365, 5546, 6440, 7589, 9424, 9809, 10859, 11732, 13123, 13413, 6288, 6896, 8720, 9084, 9793, 10669, 10783, 10790, 13941, 14639, 14679, 173, 1950, 3040, 3341, 8715, 9810, 10690, 11274, 11719, 13211, 13294, 967, 3634, 4585, 5951, 7158, 9099, 9468, 10102, 11067, 12326, 13317, 397, 430, 1160, 3165, 3185, 4817, 6376, 7341, 8581, 12312, 12956, 50, 3801, 4496, 4657, 6805, 6979, 10377, 10911, 11199, 14414, 14832, 791, 2365, 2583, 2828, 2842, 4840, 8823, 9107, 12801, 13883, 13891, 201, 6105, 6111, 6580, 9436, 10120, 10218, 10505, 12868, 13663, 13873, 445, 824, 3799, 4118, 5451, 6331, 6964, 8559, 12352, 12416, 13362, 4190, 4621, 6629, 6834, 7025, 9233, 9485, 11566, 11694, 12889, 13246, 516, 573, 1520, 1756, 3450, 3678, 7353, 7866, 10004, 12065, 13929, 329, 835, 2523, 2984, 3214, 4668, 7799, 8489, 10931, 12553, 14197, 137, 278, 285, 3217, 4453, 5736, 8993, 9287, 11378, 12807, 14932, 804, 1258, 2333, 2571, 3760, 11696, 11935, 12230, 12843, 12854, 14680]

query I
PRAGMA backward_lineage("SELECT c_count, count(*) AS custdist FROM (SELECT c_custkey, count(o_orderkey) FROM customer LEFT OUTER JOIN orders ON c_custkey = o_custkey AND o_comment NOT LIKE '%special%requests%' GROUP BY c_custkey) AS c_orders (c_custkey, c_count) GROUP BY c_count ORDER BY custdist DESC, c_count DESC", 'VALUE', '30')
----
[3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 79, 186, 1635, 2671, 2699, 3431, 3738, 3850, 5097, 5617, 6103, 6319, 6476, 6606, 6681, 6715, 7104, 7397, 8690, 9097, 9532, 10399, 11125, 11742, 13505, 13603, 13681, 14051, 14537, 14774, 14787]

query I
PRAGMA backward_lineage("SELECT c_count, count(*) AS custdist FROM (SELECT c_custkey, count(o_orderkey) FROM customer LEFT OUTER JOIN orders ON c_custkey = o_custkey AND o_comment NOT LIKE '%special%requests%' GROUP BY c_custkey) AS c_orders (c_custkey, c_count) GROUP BY c_count ORDER BY custdist DESC, c_count DESC", 'COUNT', '0')
----
500

query I
PRAGMA backward_lineage("SELECT c_count, count(*) AS custdist FROM (SELECT c_custkey, count(o_orderkey) FROM customer LEFT OUTER JOIN orders ON c_custkey = o_custkey AND o_comment NOT LIKE '%special%requests%' GROUP BY c_custkey) AS c_orders (c_custkey, c_count) GROUP BY c_count ORDER BY custdist DESC, c_count DESC", 'COUNT', '1')
----
1496

query I
PRAGMA backward_lineage("SELECT c_count, count(*) AS custdist FROM (SELECT c_custkey, count(o_orderkey) FROM customer LEFT OUTER JOIN orders ON c_custkey = o_custkey AND o_comment NOT LIKE '%special%requests%' GROUP BY c_custkey) AS c_orders (c_custkey, c_count) GROUP BY c_count ORDER BY custdist DESC, c_count DESC", 'COUNT', '30')
----
62
