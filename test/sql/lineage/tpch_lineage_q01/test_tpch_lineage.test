# name: test/sql/lineage/tpch_lineage/test_tpch_lineage.test
# description: Test TPCH Q01 Lineage
# group: [tpch_lineage_q01]

require tpch

statement ok
CALL dbgen(sf=0.01);

statement ok
PRAGMA enable_profiling;
PRAGMA trace_lineage = "ON";

statement ok
create table q1 as (SELECT
                        c_name,
                        c_custkey,
                        o_orderkey,
                        o_orderdate,
                        o_totalprice,
                        sum(l_quantity)
                    FROM
                        customer,
                        orders,
                        lineitem
                    WHERE
                        o_orderkey IN (
                            SELECT
                                l_orderkey
                            FROM
                                lineitem
                            GROUP BY
                                l_orderkey
                            HAVING
                                sum(l_quantity) > 300)
                        AND c_custkey = o_custkey
                        AND o_orderkey = l_orderkey
                    GROUP BY
                        c_name,
                        c_custkey,
                        o_orderkey,
                        o_orderdate,
                        o_totalprice
                    ORDER BY
                        o_totalprice DESC,
                        o_orderdate
                    LIMIT 100
)

statement ok
PRAGMA trace_lineage = "OFF";
PRAGMA disable_profiling;

#query I
#pragma show_tables;
#----

query III
SELECT LINEAGE_1_HASH_JOIN_2_1.rhs_index as lineitem_rowid_0,
         LINEAGE_1_HASH_JOIN_2_0.in_index as orders_rowid_1,
         LINEAGE_1_HASH_JOIN_4_0.in_index as customer_rowid_3,
         LINEAGE_1_HASH_GROUP_BY_7_0.in_index as lineitem_rowid_5
  FROM LINEAGE_1_LIMIT_14_0, LINEAGE_1_ORDER_BY_13_0,
       LINEAGE_1_HASH_GROUP_BY_12_1, LINEAGE_1_HASH_GROUP_BY_12_0,
       LINEAGE_1_HASH_JOIN_10_1, LINEAGE_1_HASH_JOIN_10_0,
       LINEAGE_1_HASH_JOIN_4_1, LINEAGE_1_HASH_JOIN_4_0,
       LINEAGE_1_HASH_JOIN_2_1, LINEAGE_1_HASH_JOIN_2_0,
       LINEAGE_1_FILTER_8_0, LINEAGE_1_HASH_GROUP_BY_7_1,
      LINEAGE_1_HASH_GROUP_BY_7_0
  WHERE LINEAGE_1_ORDER_BY_13_0.out_index=LINEAGE_1_LIMIT_14_0.in_index
    and LINEAGE_1_HASH_GROUP_BY_12_1.out_index=LINEAGE_1_ORDER_BY_13_0.in_index
    and LINEAGE_1_HASH_GROUP_BY_12_1.in_index=LINEAGE_1_HASH_GROUP_BY_12_0.out_index
    and LINEAGE_1_HASH_JOIN_10_1.out_index=LINEAGE_1_HASH_GROUP_BY_12_0.in_index
    and LINEAGE_1_HASH_JOIN_10_0.out_address=LINEAGE_1_HASH_JOIN_10_1.lhs_address
    and LINEAGE_1_HASH_JOIN_10_1.rhs_index=LINEAGE_1_HASH_JOIN_4_1.out_index
    and LINEAGE_1_HASH_JOIN_4_0.out_address=LINEAGE_1_HASH_JOIN_4_1.lhs_address
    and LINEAGE_1_HASH_JOIN_4_1.rhs_index=LINEAGE_1_HASH_JOIN_2_1.out_index
    and LINEAGE_1_HASH_JOIN_2_0.out_address=LINEAGE_1_HASH_JOIN_2_1.lhs_address
    and LINEAGE_1_HASH_JOIN_10_0.in_index=LINEAGE_1_FILTER_8_0.out_index
    and LINEAGE_1_HASH_GROUP_BY_7_1.out_index=LINEAGE_1_FILTER_8_0.in_index
    and LINEAGE_1_HASH_GROUP_BY_7_1.in_index=LINEAGE_1_HASH_GROUP_BY_7_0.out_index
AND LINEAGE_1_LIMIT_14_0.out_index = 0
----


query III
select partsupp_rowid, lineitem_rowid, orders_rowid from lineage_q1 where out_index = 100
----
1845	107	27

query III
select partsupp_rowid, lineitem_rowid, orders_rowid from lineage_q1 where out_index = 2000
----
5405	1847	462

statement ok
create table lineage_q1_l1 as select out_index+1 as out_index, partsupp_rowid_1 as partsupp_rowid,  lineitem_rowid_0 as lineitem_rowid from (SELECT LINEAGE_1_HASH_JOIN_2_1.rhs_index as lineitem_rowid_0,
       LINEAGE_1_HASH_JOIN_2_0.in_index as partsupp_rowid_1,
       LINEAGE_1_HASH_JOIN_2_1.rhs_index as out_index
FROM LINEAGE_1_HASH_JOIN_2_1,
    LINEAGE_1_HASH_JOIN_2_0
WHERE  LINEAGE_1_HASH_JOIN_2_0.out_address=LINEAGE_1_HASH_JOIN_2_1.lhs_address)

query IIIIIIIIIIIIIIIIIIIIIIII
select * from lineitem, partsupp, lineage_q1_l1 where lineage_q1_l1.lineitem_rowid=lineitem.rowid and lineage_q1_l1.partsupp_rowid=partsupp.rowid and  ps_suppkey<>l_suppkey and ps_partkey<>l_partkey
----

query IIIIIIIIIIIIII
select * from q1 join lineage_q1 on (lineage_q1.out_index=q1.out_index) where q1.lineitem_rowid<>lineage_q1.lineitem_rowid or  q1.partsupp_rowid<>lineage_q1.partsupp_rowid or  q1.orders_rowid<>lineage_q1.orders_rowid
----