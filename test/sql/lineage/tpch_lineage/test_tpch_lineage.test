# name: test/sql/lineage/tpch_lineage/test_tpch_lineage.test
# description: Test TPCH Lineage
# group: [tpch_lineage]

require tpch

statement ok
CALL dbgen(sf=1);


statement ok
PRAGMA trace_lineage = "ON";

query I
 SELECT s_acctbal, s_name, n_name, p_partkey, p_mfgr, s_address, s_phone, s_comment FROM part, supplier, partsupp, nation, region WHERE p_partkey = ps_partkey AND s_suppkey = ps_suppkey AND p_size = 15 AND p_type LIKE '%BRASS' AND s_nationkey = n_nationkey AND n_regionkey = r_regionkey AND r_name = 'EUROPE' AND ps_supplycost = ( SELECT min(ps_supplycost) FROM partsupp, supplier, nation, region WHERE p_partkey = ps_partkey AND s_suppkey = ps_suppkey AND s_nationkey = n_nationkey AND n_regionkey = r_regionkey AND r_name = 'EUROPE') ORDER BY s_acctbal DESC, n_name, s_name, p_partkey LIMIT 100;
#SELECT c_count, count(*) AS custdist FROM ( SELECT c_custkey, count(o_orderkey) FROM customer LEFT OUTER JOIN orders ON c_custkey = o_custkey AND o_comment NOT LIKE '%special%requests%' GROUP BY c_custkey) AS c_orders (c_custkey, c_count) GROUP BY c_count ORDER BY custdist DESC, c_count DESC;
#SELECT sum(l_extendedprice) / 7.0 AS avg_yearly FROM lineitem, part WHERE p_partkey = l_partkey AND p_brand = 'Brand#23' AND p_container = 'MED BOX' AND l_quantity < ( SELECT 0.2 * avg(l_quantity) FROM lineitem WHERE l_partkey = p_partkey);
#SELECT sum(l_extendedprice * (1 - l_discount)) AS revenue FROM lineitem, part WHERE (p_partkey = l_partkey AND p_brand = 'Brand#12' AND p_container IN ('SM CASE', 'SM BOX', 'SM PACK', 'SM PKG') AND l_quantity >= 1 AND l_quantity <= 1 + 10 AND p_size BETWEEN 1 AND 5 AND l_shipmode IN ('AIR', 'AIR REG') AND l_shipinstruct = 'DELIVER IN PERSON') OR (p_partkey = l_partkey AND p_brand = 'Brand#23' AND p_container IN ('MED BAG', 'MED BOX', 'MED PKG', 'MED PACK') AND l_quantity >= 10 AND l_quantity <= 10 + 10 AND p_size BETWEEN 1 AND 10 AND l_shipmode IN ('AIR', 'AIR REG') AND l_shipinstruct = 'DELIVER IN PERSON') OR (p_partkey = l_partkey AND p_brand = 'Brand#34' AND p_container IN ('LG CASE', 'LG BOX', 'LG PACK', 'LG PKG') AND l_quantity >= 20 AND l_quantity <= 20 + 10 AND p_size BETWEEN 1 AND 15 AND l_shipmode IN ('AIR', 'AIR REG') AND l_shipinstruct = 'DELIVER IN PERSON');
#SELECT s_name, s_address FROM supplier, nation WHERE s_suppkey IN ( SELECT ps_suppkey FROM partsupp WHERE ps_partkey IN ( SELECT p_partkey FROM part WHERE p_name LIKE 'forest%') AND ps_availqty > ( SELECT 0.5 * sum(l_quantity) FROM lineitem WHERE l_partkey = ps_partkey AND l_suppkey = ps_suppkey AND l_shipdate >= CAST('1994-01-01' AS date) AND l_shipdate < CAST('1995-01-01' AS date))) AND s_nationkey = n_nationkey AND n_name = 'CANADA' ORDER BY s_name;
#SELECT s_name, count(*) AS numwait FROM supplier, lineitem l1, orders, nation WHERE s_suppkey = l1.l_suppkey AND o_orderkey = l1.l_orderkey AND o_orderstatus = 'F' AND l1.l_receiptdate > l1.l_commitdate AND EXISTS ( SELECT * FROM lineitem l2 WHERE l2.l_orderkey = l1.l_orderkey AND l2.l_suppkey <> l1.l_suppkey) AND NOT EXISTS ( SELECT * FROM lineitem l3 WHERE l3.l_orderkey = l1.l_orderkey AND l3.l_suppkey <> l1.l_suppkey AND l3.l_receiptdate > l3.l_commitdate) AND s_nationkey = n_nationkey AND n_name = 'SAUDI ARABIA' GROUP BY s_name ORDER BY numwait DESC, s_name LIMIT 100;
#SELECT cntrycode, count(*) AS numcust, sum(c_acctbal) AS totacctbal FROM ( SELECT substring(c_phone FROM 1 FOR 2) AS cntrycode, c_acctbal FROM customer WHERE substring(c_phone FROM 1 FOR 2) IN ('13', '31', '23', '29', '30', '18', '17') AND c_acctbal > ( SELECT avg(c_acctbal) FROM customer WHERE c_acctbal > 0.00 AND substring(c_phone FROM 1 FOR 2) IN ('13', '31', '23', '29', '30', '18', '17')) AND NOT EXISTS ( SELECT * FROM orders WHERE o_custkey = c_custkey)) AS custsale GROUP BY cntrycode ORDER BY cntrycode;
#SELECT s_name, s_address FROM supplier, nation WHERE s_suppkey IN ( SELECT ps_suppkey FROM partsupp WHERE ps_partkey IN ( SELECT p_partkey FROM part WHERE p_name LIKE 'forest%') AND ps_availqty > ( SELECT 0.5 * sum(l_quantity) FROM lineitem WHERE l_partkey = ps_partkey AND l_suppkey = ps_suppkey AND l_shipdate >= CAST('1994-01-01' AS date) AND l_shipdate < CAST('1995-01-01' AS date))) AND s_nationkey = n_nationkey AND n_name = 'CANADA' ORDER BY s_name;
#SELECT p_brand, p_type, p_size, count(DISTINCT ps_suppkey) AS supplier_cnt FROM partsupp, part WHERE p_partkey = ps_partkey AND p_brand <> 'Brand#45' AND p_type NOT LIKE 'MEDIUM POLISHED%' AND p_size IN (49, 14, 23, 45, 19, 3, 36, 9) AND ps_suppkey NOT IN ( SELECT s_suppkey FROM supplier WHERE s_comment LIKE '%Customer%Complaints%') GROUP BY p_brand, p_type, p_size ORDER BY supplier_cnt DESC, p_brand, p_type, p_size;
#SELECT c_count, count(*) AS custdist FROM ( SELECT c_custkey, count(o_orderkey) FROM customer LEFT OUTER JOIN orders ON c_custkey = o_custkey AND o_comment NOT LIKE '%special%requests%' GROUP BY c_custkey) AS c_orders (c_custkey, c_count) GROUP BY c_count ORDER BY custdist DESC, c_count DESC;
#SELECT s_name, count(*) AS numwait FROM supplier, lineitem l1, orders, nation WHERE s_suppkey = l1.l_suppkey AND o_orderkey = l1.l_orderkey AND o_orderstatus = 'F' AND l1.l_receiptdate > l1.l_commitdate AND EXISTS ( SELECT * FROM lineitem l2 WHERE l2.l_orderkey = l1.l_orderkey AND l2.l_suppkey <> l1.l_suppkey) AND NOT EXISTS ( SELECT * FROM lineitem l3 WHERE l3.l_orderkey = l1.l_orderkey AND l3.l_suppkey <> l1.l_suppkey AND l3.l_receiptdate > l3.l_commitdate) AND s_nationkey = n_nationkey AND n_name = 'SAUDI ARABIA' GROUP BY s_name ORDER BY numwait DESC, s_name LIMIT 100;
#SELECT s_acctbal, s_name, n_name, p_partkey, p_mfgr, s_address, s_phone, s_comment FROM part, supplier, partsupp, nation, region WHERE p_partkey = ps_partkey AND s_suppkey = ps_suppkey AND p_size = 15 AND p_type LIKE '%BRASS' AND s_nationkey = n_nationkey AND n_regionkey = r_regionkey AND r_name = 'EUROPE' AND ps_supplycost = ( SELECT min(ps_supplycost) FROM partsupp, supplier, nation, region WHERE p_partkey = ps_partkey AND s_suppkey = ps_suppkey AND s_nationkey = n_nationkey AND n_regionkey = r_regionkey AND r_name = 'EUROPE') ORDER BY s_acctbal DESC, n_name, s_name, p_partkey LIMIT 100;
#SELECT s_name, count(*) AS numwait FROM supplier, lineitem l1, orders, nation WHERE s_suppkey = l1.l_suppkey AND o_orderkey = l1.l_orderkey AND o_orderstatus = 'F' AND l1.l_receiptdate > l1.l_commitdate AND EXISTS ( SELECT * FROM lineitem l2 WHERE l2.l_orderkey = l1.l_orderkey AND l2.l_suppkey <> l1.l_suppkey) AND NOT EXISTS ( SELECT * FROM lineitem l3 WHERE l3.l_orderkey = l1.l_orderkey AND l3.l_suppkey <> l1.l_suppkey AND l3.l_receiptdate > l3.l_commitdate) AND s_nationkey = n_nationkey AND n_name = 'SAUDI ARABIA' GROUP BY s_name ORDER BY numwait DESC, s_name LIMIT 100;
#SELECT p_brand, p_type, p_size, count(DISTINCT ps_suppkey) AS supplier_cnt FROM partsupp, part WHERE p_partkey = ps_partkey AND p_brand <> 'Brand#45' AND p_type NOT LIKE 'MEDIUM POLISHED%' AND p_size IN (49, 14, 23, 45, 19, 3, 36, 9) AND ps_suppkey NOT IN ( SELECT s_suppkey FROM supplier WHERE s_comment LIKE '%Customer%Complaints%') GROUP BY p_brand, p_type, p_size ORDER BY supplier_cnt DESC, p_brand, p_type, p_size;
#SELECT 100.00 * sum( CASE WHEN p_type LIKE 'PROMO%' THEN l_extendedprice * (1 - l_discount) ELSE 0 END) / sum(l_extendedprice * (1 - l_discount)) AS promo_revenue FROM lineitem, part WHERE l_partkey = p_partkey AND l_shipdate >= date '1995-09-01' AND l_shipdate < CAST('1995-10-01' AS date);
#SELECT ps_partkey, sum(ps_supplycost * ps_availqty) AS value FROM partsupp, supplier, nation WHERE ps_suppkey = s_suppkey AND s_nationkey = n_nationkey AND n_name = 'GERMANY' GROUP BY ps_partkey HAVING sum(ps_supplycost * ps_availqty) > ( SELECT sum(ps_supplycost * ps_availqty) * 0.0001000000 FROM partsupp, supplier, nation WHERE ps_suppkey = s_suppkey AND s_nationkey = n_nationkey AND n_name = 'GERMANY') ORDER BY value DESC;
#SELECT o_orderpriority,  count(*) AS order_count FROM  orders WHERE  o_orderdate >= CAST('1993-07-01' AS date)    AND o_orderdate < CAST('1993-10-01' AS date)   AND EXISTS (  SELECT  *     FROM    lineitem    WHERE  l_orderkey = o_orderkey   AND l_commitdate < l_receiptdate) GROUP BY    o_orderpriority ORDER BY   o_orderpriority
#SELECT    l_orderkey,  sum(l_extendedprice * (1 - l_discount)) AS revenue, o_orderdate, o_shippriority FROM  customer,  orders,  lineitem WHERE    c_mktsegment = 'BUILDING'   AND c_custkey = o_custkey AND l_orderkey = o_orderkey AND o_orderdate < CAST('1995-03-15' AS date)   AND l_shipdate > CAST('1995-03-15' AS date) GROUP BY    l_orderkey,   o_orderdate,   o_shippriority ORDER BY  revenue DESC,  o_orderdate LIMIT 10
#SELECT sum(l_extendedprice) / 7.0 AS avg_yearly FROM lineitem,   part WHERE p_partkey = l_partkey AND p_container = 'MED BOX'    AND l_quantity < (   SELECT   0.2 * avg(l_quantity)   FROM  lineitem  WHERE l_partkey = p_partkey);
#SELECT p_brand, p_type, p_size, count(DISTINCT ps_suppkey) AS supplier_cnt FROM partsupp, part WHERE p_partkey = ps_partkey AND p_brand <> 'Brand#45' AND p_type NOT LIKE 'MEDIUM POLISHED%'  AND p_size IN (49, 14, 23, 45, 19, 3, 36, 9) AND ps_suppkey NOT IN ( SELECT  s_suppkey   FROM supplier    WHERE  s_comment LIKE '%Customer%Complaints%') GROUP BY p_brand, p_type, p_size ORDER BY supplier_cnt DESC, p_brand, p_type, p_size;
#SELECT c_count, count(*) AS custdist FROM ( SELECT c_custkey, count(o_orderkey)  FROM customer  LEFT OUTER JOIN orders ON c_custkey = o_custkey   AND o_comment NOT LIKE '%special%requests%' GROUP BY c_custkey) AS c_orders (c_custkey,   c_count) GROUP BY  c_count ORDER BY  custdist DESC, c_count DESC;
----
51286

statement ok
PRAGMA trace_lineage = "OFF";

query II
SELECT * FROM queries_list;
----
1	SELECT sum(l_extendedprice) / 7.0 AS avg_yearly FROM lineitem,   part WHERE p_partkey = l_partkey AND p_container = 'MED BOX'    AND l_quantity < (   SELECT   0.2 * avg(l_quantity)   FROM  lineitem  WHERE l_partkey = p_partkey);
2	PRAGMA trace_lineage = "OFF";

query I
pragma show_tables;
----
LINEAGE_1_FILTER_14_0
LINEAGE_1_HASH_GROUP_BY_8_0
LINEAGE_1_HASH_GROUP_BY_8_1
LINEAGE_1_HASH_JOIN_12_0
LINEAGE_1_HASH_JOIN_12_1
LINEAGE_1_HASH_JOIN_5_0
LINEAGE_1_HASH_JOIN_5_1
LINEAGE_1_HASH_JOIN_7_0
LINEAGE_1_HASH_JOIN_7_1
LINEAGE_1_PERFECT_HASH_GROUP_BY_3_0
LINEAGE_1_PERFECT_HASH_GROUP_BY_3_1
LINEAGE_1_SEQ_SCAN_10_0
LINEAGE_1_SEQ_SCAN_11_0
LINEAGE_1_SEQ_SCAN_1_0
customer
lineitem
nation
orders
part
partsupp
queries_list
region
supplier

statement ok
create table pipeline1 as (SELECT  sink.in_index as lineitem_rowid, probe.out_index FROM LINEAGE_1_PERFECT_HASH_GROUP_BY_3_0 sink, LINEAGE_1_PERFECT_HASH_GROUP_BY_3_1 probe where sink.out_index=probe.in_index and probe.out_index=678)


statement ok
create table pipeline2 as (SELECT probe.rhs_index as lineitem2_rowid, seq11.in_index as part_rowid, probe.out_index FROM LINEAGE_1_SEQ_SCAN_11_0 as seq11, LINEAGE_1_HASH_JOIN_12_0 as sink, LINEAGE_1_HASH_JOIN_12_1 as probe where sink.out_address=probe.lhs_address and sink.in_index=seq11.out_index)

statement ok
create table pipeline3 as (SELECT lineitem2_rowid, part_rowid, sink.out_index FROM LINEAGE_1_HASH_GROUP_BY_8_0 as sink, pipeline2 where sink.in_index=pipeline2.out_index)

statement ok
create table pipeline4 as (SELECT lineitem2_rowid, lineitem_rowid, part_rowid, probe.out_index as out_index FROM  pipeline3,  pipeline1, LINEAGE_1_HASH_JOIN_5_1 as probe, LINEAGE_1_HASH_JOIN_5_0 as sink where sink.out_address=probe.lhs_address and pipeline1.out_index=probe.rhs_index and pipeline3.out_index=sink.in_index)

#select p_partkey, part_rowid, l1.l_partkey, lineitem2_rowid, l2.l_partkey, lineitem_rowid from lineitem as l1, lineitem as l2, part, pipeline4 where l1.rowid=lineitem2_rowid and l2.rowid=lineitem_rowid and part.rowid=part_rowid

statement ok
CREATE TABLE pipeline5 AS (SELECT probe_input.lineitem2_rowid as probe_input_lineitem2_rowid, probe_input.part_rowid as probe_input_part_rowid, sink_input.lineitem2_rowid as sink_input_lineitem2_rowid, sink_input.lineitem_rowid as sink_input_lineitem_rowid, sink_input.part_rowid as  sink_input_part_rowid, probe.out_index FROM pipeline2 as probe_input, pipeline4 as sink_input, LINEAGE_1_HASH_JOIN_7_0 as sink, LINEAGE_1_HASH_JOIN_7_1 as probe where sink.out_address=probe.lhs_address and sink.in_index=sink_input.out_index and probe_input.out_index=probe.rhs_index)

query IIIII
select l1.l_partkey, l2.l_partkey, l3.l_partkey, p1.p_partkey, p2.p_partkey from lineitem as l1, lineitem as l2, lineitem as l3, part as p1, part as p2, LINEAGE_1_FILTER_14_0, pipeline5 where LINEAGE_1_FILTER_14_0.in_index=pipeline5.out_index and probe_input_lineitem2_rowid=l1.rowid and probe_input_part_rowid=p1.rowid and sink_input_lineitem2_rowid=l2.rowid and sink_input_lineitem_rowid=l3.rowid and p2.rowid=sink_input_part_rowid limit 1
----
679	679	679	679	679