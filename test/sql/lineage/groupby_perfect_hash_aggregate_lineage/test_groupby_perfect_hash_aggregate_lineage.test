# name: test/sql/lineage/groupby_lineage/test_groupby_perfect_hash_aggregate_lineage.test
# description: Test Group By lineage -- perfect hash aggregate
# group: [groupby_perfect_hash_aggregate_lineage]
#
#┌───────────────────────────┐
#│   PERFECT_HASH_GROUP_BY   │
#│   ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─   │
#│             #0            │
#│          avg(#1)          │
#└─────────────┬─────────────┘
#┌─────────────┴─────────────┐
#│         PROJECTION        │
#│   ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─   │
#│             i             │
#│             j             │
#└─────────────┬─────────────┘
#┌─────────────┴─────────────┐
#│          SEQ_SCAN         │
#│   ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─   │
#│             t1            │
#│   ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─   │
#│             i             │
#│             j             │
#└───────────────────────────┘

statement ok
PRAGMA trace_lineage = "OFF";

statement ok
CREATE TABLE t1(i INTEGER, j INTEGER);

statement ok
INSERT INTO t1 VALUES (1, 2),  (5, 2), (1, 4), (2, 1), (1, 3),(2, 2), (4, 1), (5, 1)


statement ok
PRAGMA trace_lineage = "ON";

# standalone limit
query II
select t1.i, avg(t1.j) from t1 GROUP BY t1.i
----
1	3.000000
2	1.500000
4	1.000000
5	1.500000

statement ok
PRAGMA trace_lineage = "OFF";


query III
select group_id, out_index, out_chunk_id from PERFECT_HASH_GROUP_BY_9_0_PROBE;
----
1	0	0
2	1	0
4	2	0
5	3	0

query III
select group_id, in_index, out_chunk_id from PERFECT_HASH_GROUP_BY_9_0_SINK;
----
1	0	0
5	1	0
1	2	0
2	3	0
1	4	0
2	5	0
4	6	0
5	7	0

query IIII
select s.out_chunk_id, s.in_index as input, p.out_chunk_id, p.out_index as output from PERFECT_HASH_GROUP_BY_9_0_PROBE as p, PERFECT_HASH_GROUP_BY_9_0_SINK as s where p.out_chunk_id=s.out_chunk_id and p.group_id=s.group_id;
----
0	0	0	0
0	1	0	3
0	2	0	0
0	3	0	1
0	4	0	0
0	5	0	1
0	6	0	2
0	7	0	3