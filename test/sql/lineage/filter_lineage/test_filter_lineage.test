# name: test/sql/lineage/filter_lineage/test_filter_lineage.test
# description: Test Filter Lineage
# group: [filter_lineage]


statement ok
PRAGMA explain_output = PHYSICAL_ONLY;
PRAGMA trace_lineage = "OFF";

statement ok
CREATE TABLE t1(i INTEGER);

statement ok
INSERT INTO t1 SELECT i FROM range(0,1080) tbl(i);
#┌───────────────────────────┐
#│           FILTER          │
#│   ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─   │
#│      (False OR True)      │
#└─────────────┬─────────────┘
#┌─────────────┴─────────────┐
#│          SEQ_SCAN         │
#│   ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─   │
#│             t1            │
#│   ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─   │
#│             i             │
#└───────────────────────────┘

statement ok
PRAGMA trace_lineage = "ON";

query I
select * from t1 where i < 5 or i > 1075 or (i > 1020 and i < 1024);
----
0
1
2
3
4
1021
1022
1023
1076
1077
1078
1079


statement ok
PRAGMA trace_lineage = "OFF";


query II
SELECT * FROM queries_list;
----
11	select * from t1 where i < 5 or i > 1075 or (i > 1020 and i < 1024);
13	PRAGMA trace_lineage = "OFF";

query IIII
select rowid, chunk_id, range_start, range_end from SEQ_SCAN_11_0_range;
----
0	0	0	1024
1	1	1024	1080

query IIII
select rowid, chunk_id, index, value from SEQ_SCAN_11_0_filter;
----


query IIII
select rowid, chunk_id, index, value from FILTER_11_0;
----
0	0	0	0
1	0	1	1
2	0	2	2
3	0	3	3
4	0	4	4
5	0	5	1021
6	0	6	1022
7	0	7	1023
8	1	0	52
9	1	1	53
10	1	2	54
11	1	3	55

# todo: how to map final rowid to (chunk_id, index) within lineage?
query II
select f.index as output, (f.value + r.range_start) as input from SEQ_SCAN_11_0_range as r, FILTER_11_0 as f where r.chunk_id=f.chunk_id;
----
0	0
1	1
2	2
3	3
4	4
5	1021
6	1022
7	1023
0	1076
1	1077
2	1078
3	1079