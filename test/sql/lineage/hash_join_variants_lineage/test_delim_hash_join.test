# name: test/sql/lineage/hash_join_variants_lineage/test_delim_hash_join.test
# description: Test Delim Hash Joins
# group: [hash_join_variants_lineage]


require tpch

statement ok
CALL dbgen(sf=0.01);

statement ok
PRAGMA trace_lineage = "ON";

query I
SELECT sum(l_extendedprice) / 7.0 AS avg_yearly FROM lineitem,   part WHERE p_partkey = l_partkey AND p_container = 'MED BOX' AND l_quantity < (   SELECT   0.2 * avg(l_quantity)   FROM  lineitem  WHERE l_partkey = p_partkey);
----
51286.374286

statement ok
PRAGMA trace_lineage = "OFF";

query I
pragma show_tables;
----
LINEAGE_1_FILTER_14_0
LINEAGE_1_HASH_GROUP_BY_8_0
LINEAGE_1_HASH_GROUP_BY_8_1
LINEAGE_1_HASH_JOIN_12_0
LINEAGE_1_HASH_JOIN_12_1
LINEAGE_1_HASH_JOIN_5_0
LINEAGE_1_HASH_JOIN_5_1
LINEAGE_1_HASH_JOIN_7_0
LINEAGE_1_HASH_JOIN_7_1
LINEAGE_1_PERFECT_HASH_GROUP_BY_3_0
LINEAGE_1_PERFECT_HASH_GROUP_BY_3_1
LINEAGE_1_SEQ_SCAN_10_0
LINEAGE_1_SEQ_SCAN_11_0
LINEAGE_1_SEQ_SCAN_1_0
customer
lineitem
nation
orders
part
partsupp
queries_list
region
supplier

statement ok
create table end_to_end as (
select temp_opio17.*, 0 as out_index
FROM (  SELECT temp_12.*, LINEAGE_1_HASH_JOIN_12_1.rhs_index as lineitem_rowid_10, LINEAGE_1_SEQ_SCAN_11_0.in_index as part_rowid_11, 0 as out_index
        from LINEAGE_1_FILTER_14_0, LINEAGE_1_HASH_JOIN_7_1 left join LINEAGE_1_HASH_JOIN_7_0 on (LINEAGE_1_HASH_JOIN_7_0.out_address=LINEAGE_1_HASH_JOIN_7_1.lhs_address)
        left join (select temp_9.*, LINEAGE_1_HASH_JOIN_5_0.in_index as delimscan_rowid_9, LINEAGE_1_HASH_JOIN_5_1.out_index as temp12_out_index
                    from LINEAGE_1_HASH_JOIN_5_0 left join LINEAGE_1_HASH_JOIN_5_1 on (LINEAGE_1_HASH_JOIN_5_0.out_address=LINEAGE_1_HASH_JOIN_5_1.lhs_address)
                        left join (select LINEAGE_1_PERFECT_HASH_GROUP_BY_3_0.in_index as lineitem_rowid_1, LINEAGE_1_PERFECT_HASH_GROUP_BY_3_1.out_index as temp9_out_index
                                    from LINEAGE_1_PERFECT_HASH_GROUP_BY_3_1, LINEAGE_1_PERFECT_HASH_GROUP_BY_3_0
                                    where LINEAGE_1_PERFECT_HASH_GROUP_BY_3_1.in_index=LINEAGE_1_PERFECT_HASH_GROUP_BY_3_0.out_index
                                    ) as temp_9 on (LINEAGE_1_HASH_JOIN_5_1.rhs_index=temp_9.temp9_out_index)
                    ) as temp_12 on (LINEAGE_1_HASH_JOIN_7_0.in_index=temp_12.temp12_out_index),
                    LINEAGE_1_HASH_JOIN_12_1, LINEAGE_1_HASH_JOIN_12_0, LINEAGE_1_SEQ_SCAN_11_0
        where   LINEAGE_1_HASH_JOIN_7_1.out_index=LINEAGE_1_FILTER_14_0.in_index
            and LINEAGE_1_HASH_JOIN_7_1.rhs_index=LINEAGE_1_HASH_JOIN_12_1.out_index
            and LINEAGE_1_HASH_JOIN_12_0.out_address=LINEAGE_1_HASH_JOIN_12_1.lhs_address
            and LINEAGE_1_HASH_JOIN_12_0.in_index=LINEAGE_1_SEQ_SCAN_11_0.out_index
    ) as temp_opio17
)


query IIII
select lineitem_rowid_10, part_rowid_11, p_partkey, l_partkey from end_to_end, lineitem, part where lineitem.rowid=lineitem_rowid_10 and part.rowid=part_rowid_11 limit 1
----
500	820	821	821