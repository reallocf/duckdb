# name: test/sql/lineage/hash_join_variants_lineage/test_mark_hash_join.test
# description: Test Mark Hash Joins
# group: [hash_join_variants_lineage]


require tpch

statement ok
CALL dbgen(sf=0.01);

statement ok
PRAGMA trace_lineage = "ON";

query IIII
SELECT p_brand, p_type, p_size, count(DISTINCT ps_suppkey) AS supplier_cnt FROM partsupp, part WHERE p_partkey = ps_partkey AND p_brand <> 'Brand#45' AND p_type NOT LIKE 'MEDIUM POLISHED%'  AND p_size IN (49, 14, 23, 45, 19, 3, 36, 9) AND ps_suppkey NOT IN ( SELECT  s_suppkey   FROM supplier    WHERE  s_comment LIKE '%Customer%Complaints%') GROUP BY p_brand, p_type, p_size ORDER BY supplier_cnt DESC, p_brand, p_type, p_size LIMIT 1;
----
Brand#14	PROMO BRUSHED STEEL	9	8

statement ok
PRAGMA trace_lineage = "OFF";

query I
pragma show_tables;
----
LINEAGE_1_FILTER_11_0
LINEAGE_1_FILTER_4_0
LINEAGE_1_FILTER_8_0
LINEAGE_1_HASH_GROUP_BY_14_0
LINEAGE_1_HASH_GROUP_BY_14_1
LINEAGE_1_HASH_JOIN_10_0
LINEAGE_1_HASH_JOIN_10_1
LINEAGE_1_HASH_JOIN_3_0
LINEAGE_1_HASH_JOIN_3_1
LINEAGE_1_HASH_JOIN_6_0
LINEAGE_1_HASH_JOIN_6_1
LINEAGE_1_LIMIT_16_0
LINEAGE_1_ORDER_BY_15_0
LINEAGE_1_SEQ_SCAN_0_0
LINEAGE_1_SEQ_SCAN_1_0
LINEAGE_1_SEQ_SCAN_7_0
customer
lineitem
nation
orders
part
partsupp
queries_list
region
supplier


query IIII
select LINEAGE_1_HASH_JOIN_6_1.rhs_index as partsupp_rowid_0,
LINEAGE_1_HASH_JOIN_3_0.in_index as chunkscan_rowid_2,
LINEAGE_1_HASH_JOIN_3_1.rhs_index as part_rowid_1,
LINEAGE_1_LIMIT_16_0.out_index
FROM LINEAGE_1_LIMIT_16_0, LINEAGE_1_ORDER_BY_15_0, LINEAGE_1_HASH_GROUP_BY_14_1,
LINEAGE_1_HASH_GROUP_BY_14_0, LINEAGE_1_FILTER_11_0,
LINEAGE_1_HASH_JOIN_6_1, LINEAGE_1_HASH_JOIN_6_0, LINEAGE_1_FILTER_4_0,
LINEAGE_1_HASH_JOIN_3_1 left join LINEAGE_1_HASH_JOIN_3_0 on (LINEAGE_1_HASH_JOIN_3_0.out_address=LINEAGE_1_HASH_JOIN_3_1.lhs_address)
where LINEAGE_1_ORDER_BY_15_0.out_index=LINEAGE_1_LIMIT_16_0.in_index
and LINEAGE_1_HASH_GROUP_BY_14_1.out_index=LINEAGE_1_ORDER_BY_15_0.in_index
and LINEAGE_1_HASH_GROUP_BY_14_1.in_index=LINEAGE_1_HASH_GROUP_BY_14_0.out_index
and LINEAGE_1_FILTER_11_0.out_index=LINEAGE_1_HASH_GROUP_BY_14_0.in_index
and LINEAGE_1_HASH_JOIN_6_1.out_index=LINEAGE_1_FILTER_11_0.in_index
and LINEAGE_1_HASH_JOIN_6_0.out_address=LINEAGE_1_HASH_JOIN_6_1.lhs_address
and LINEAGE_1_HASH_JOIN_6_0.in_index=LINEAGE_1_FILTER_4_0.out_index
and LINEAGE_1_HASH_JOIN_3_1.out_index=LINEAGE_1_FILTER_4_0.in_index
----
379	6	94	0
167	3	41	0
378	6	94	0
166	3	41	0
377	6	94	0
165	3	41	0
376	6	94	0
164	3	41	0

query I
select count(*) from LINEAGE_1_FILTER_4_0, LINEAGE_1_HASH_JOIN_3_1 where  LINEAGE_1_HASH_JOIN_3_1.out_index=LINEAGE_1_FILTER_4_0.in_index
----
299

# when lhs_address is zero, it means no match was found from the build side, that is why build.in_index is NULL
query IIIII
select LINEAGE_1_HASH_JOIN_3_1.lhs_address, LINEAGE_1_HASH_JOIN_3_1.rhs_index, LINEAGE_1_HASH_JOIN_3_1.out_index, LINEAGE_1_HASH_JOIN_3_0.in_index, LINEAGE_1_HASH_JOIN_3_0.out_address
FROM  LINEAGE_1_HASH_JOIN_3_1 left join LINEAGE_1_HASH_JOIN_3_0 on (LINEAGE_1_HASH_JOIN_3_0.out_address=LINEAGE_1_HASH_JOIN_3_1.lhs_address)
where LINEAGE_1_HASH_JOIN_3_1.lhs_address=0 limit 1
----
0	0	0	NULL	NULL